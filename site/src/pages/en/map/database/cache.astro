---
import DocsLayout from '../../../../layouts/DocsLayout.astro';
import Callout from '../../../../components/Callout';
import CodeBlock from '../../../../components/CodeBlock';
import SectionHeader from '../../../../components/SectionHeader';
import MetaBadge from '../../../../components/MetaBadge';
import PageNavigation from '../../../../components/PageNavigation.astro';

const fastapiCode = `# app/cache.py
import redis.asyncio as redis

REDIS_URL = "redis://localhost:6379"

redis_client = redis.from_url(REDIS_URL, decode_responses=True)`;

const fastapiQueryCode = `# app/main.py
import json
from fastapi import FastAPI
from app.cache import redis_client

app = FastAPI()

@app.get("/products/{product_id}")
async def get_product(product_id: str):
    # Check cache
    cached = await redis_client.get(f"product:{product_id}")
    if cached:
        return json.loads(cached)

    # Query from DB (example here)
    product = {"id": product_id, "name": "Laptop", "price": 1200000}

    # Store in cache (TTL 1 hour)
    await redis_client.set(
        f"product:{product_id}",
        json.dumps(product),
        ex=3600
    )
    return product

@app.post("/leaderboard")
async def update_score(user_id: str, score: int):
    # Real-time ranking with Sorted Set
    await redis_client.zadd("leaderboard", {user_id: score})
    rank = await redis_client.zrevrank("leaderboard", user_id)
    return {"user_id": user_id, "score": score, "rank": rank + 1}`;

const honoCode = `// src/cache.ts
import { Redis } from '@upstash/redis';

const redis = new Redis({
  url: 'https://your-endpoint.upstash.io',
  token: 'your-token',
});

export default redis;`;

const honoQueryCode = `// src/index.ts
import { Hono } from 'hono';
import redis from './cache';

const app = new Hono();

app.get('/products/:id', async (c) => {
  const id = c.req.param('id');

  // Check cache
  const cached = await redis.get<string>(\`product:\${id}\`);
  if (cached) {
    return c.json(JSON.parse(cached));
  }

  // Query from DB (example here)
  const product = { id, name: 'Laptop', price: 1200000 };

  // Store in cache (TTL 1 hour)
  await redis.set(\`product:\${id}\`, JSON.stringify(product), { ex: 3600 });
  return c.json(product);
});

app.get('/leaderboard', async (c) => {
  const top10 = await redis.zrange('leaderboard', 0, 9, { rev: true });
  return c.json(top10);
});

export default app;`;
---

<DocsLayout
  title="In-Memory / Cache Database"
  description="Ultra-fast cache systems such as Redis and Memcached"
  currentPath="/map/database/cache"
  lang="en"
>
  <div class="max-w-4xl mx-auto px-6 py-8">
    <nav class="flex items-center gap-2 text-sm text-text-secondary mb-6" aria-label="Breadcrumb">
      <a href="/en" class="hover:text-white transition-colors">Home</a>
      <span>/</span>
      <a href="/en/map" class="hover:text-white transition-colors">Learning Cycle</a>
      <span>/</span>
      <a href="/en/map/database" class="hover:text-white transition-colors">Database</a>
      <span>/</span>
      <span class="text-primary font-medium">Cache</span>
    </nav>

    <header class="mb-8 pb-6 border-b border-border">
      <div class="flex items-center gap-2 mb-4">
        <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-yellow-500/10 text-yellow-400 text-xs font-bold">
          Lv.3
        </span>
      </div>
      <h1 class="text-3xl md:text-4xl font-black text-white mb-4">
        In-Memory / Cache Database
      </h1>
      <p class="text-text-secondary text-lg leading-relaxed">
        Achieve ultra-fast read/write by storing data in memory.
        Primarily used for session management, caching, and real-time leaderboards.
      </p>
    </header>

    <section class="mb-10">
      <Callout client:load variant="tip" title="What is this?" locale="en">
        <p class="mt-1">
          Stores data in memory for ultra-fast (~1ms) reads. Used for sessions, caching, and real-time rankings.
        </p>
      </Callout>
    </section>

    <article class="prose prose-invert max-w-none">
      <!-- When do I need this? -->
      <section class="mb-10">
        <SectionHeader number={1} title="When do I need this?" />

        <ul class="list-disc list-inside text-text-secondary space-y-2">
          <li><strong class="text-white">API response caching</strong> - Cache DB query results to improve response speed</li>
          <li><strong class="text-white">Session storage</strong> - Share login sessions across multiple servers</li>
          <li><strong class="text-white">Real-time rankings/counters</strong> - View counts, likes, leaderboards</li>
          <li><strong class="text-white">Rate Limiting</strong> - Limit the number of API requests</li>
        </ul>
      </section>

      <!-- Key Services -->
      <section class="mb-10">
        <SectionHeader number={2} title="Key Services" />

        <div class="grid md:grid-cols-2 gap-4">
          <div class="p-4 bg-surface border border-primary/50 rounded-xl">
            <h3 class="text-white font-bold mb-1">Redis (Upstash)</h3>
            <span class="text-xs text-primary font-medium">Most popular, serverless free tier</span>
            <p class="text-text-secondary text-sm mt-2">
              The standard key-value store. Supports various data structures including
              strings, hashes, lists, sets, and sorted sets. Upstash is a serverless Redis service.
            </p>
          </div>
          <div class="p-4 bg-surface border border-border rounded-xl">
            <h3 class="text-white font-bold mb-1">Memcached</h3>
            <span class="text-xs text-text-secondary font-medium">Simple caching only</span>
            <p class="text-text-secondary text-sm mt-2">
              Specialized for simple key-value caching. Fewer features than Redis,
              but can be slightly faster for simple caching use cases.
            </p>
          </div>
          <div class="p-4 bg-surface border border-border rounded-xl">
            <h3 class="text-white font-bold mb-1">Valkey</h3>
            <span class="text-xs text-text-secondary font-medium">Redis fork, open source</span>
            <p class="text-text-secondary text-sm mt-2">
              An open-source fork of Redis. API-compatible with Redis
              and managed by the Linux Foundation.
            </p>
          </div>
        </div>
      </section>

      <!-- Pricing -->
      <section class="mb-10">
        <SectionHeader number={3} title="Pricing" />

        <div class="p-4 bg-surface border border-border rounded-xl">
          <ul class="text-text-secondary space-y-2">
            <li><strong class="text-white">Upstash Redis</strong> - Free tier: 10K commands/day, 256MB storage</li>
            <li><strong class="text-white">Redis Cloud</strong> - Free tier: 30MB (suitable for small-scale caching)</li>
            <li><strong class="text-white">Self-hosted Redis</strong> - Free with Docker local installation (server costs separate)</li>
          </ul>
        </div>
      </section>

      <!-- Connection Examples -->
      <section class="mb-10">
        <SectionHeader number={4} title="Connection Examples" />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">FastAPI + redis-py (Python)</h3>

        <CodeBlock
          client:load
          code={fastapiCode}
          filename="app/cache.py"
        />

        <CodeBlock
          client:load
          code={fastapiQueryCode}
          filename="app/main.py"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Hono + @upstash/redis (TypeScript)</h3>

        <CodeBlock
          client:load
          code={honoCode}
          filename="src/cache.ts"
        />

        <CodeBlock
          client:load
          code={honoQueryCode}
          filename="src/index.ts"
        />

        <Callout client:load variant="warning" title="Cache is a secondary store" locale="en">
          <p class="text-sm mt-1">
            Cached data can disappear at any time.
            Always use it alongside a primary data store (RDB/NoSQL),
            and implement logic to read from the primary source on a cache miss.
          </p>
        </Callout>
      </section>
    </article>

    <PageNavigation lang="en" currentPath="/map/database/cache" />
  </div>
</DocsLayout>
