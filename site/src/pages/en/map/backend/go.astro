---
import DocsLayout from '../../../../layouts/DocsLayout.astro';
import Callout from '../../../../components/Callout';
import CodeBlock from '../../../../components/CodeBlock';
import PageNavigation from '../../../../components/PageNavigation.astro';

// Code blocks defined as variables to avoid esbuild parsing issues
const goModCode = `module my-api

go 1.22

require (
    github.com/go-chi/chi/v5 v5.1.0
    github.com/go-chi/cors v1.2.1
    github.com/google/uuid v1.6.0
)`;

const mainGoCode = `package main

import (
    "encoding/json"
    "log"
    "net/http"
    "os"

    "github.com/go-chi/chi/v5"
    "github.com/go-chi/chi/v5/middleware"
    "github.com/go-chi/cors"
)

func main() {
    r := chi.NewRouter()

    // Middleware
    r.Use(middleware.Logger)
    r.Use(middleware.Recoverer)
    r.Use(cors.Handler(cors.Options{
        AllowedOrigins:   []string{"http://localhost:*"},
        AllowedMethods:   []string{"GET", "POST", "PUT", "DELETE"},
        AllowedHeaders:   []string{"Content-Type"},
        AllowCredentials: true,
    }))

    // Routes
    r.Get("/health", healthHandler)
    r.Get("/api/hello", helloHandler)

    // Start server
    port := os.Getenv("PORT")
    if port == "" {
        port = "8080"
    }
    log.Printf("Server starting on port %s", port)
    http.ListenAndServe(":"+port, r)
}

func healthHandler(w http.ResponseWriter, r *http.Request) {
    w.Header().Set("Content-Type", "application/json")
    json.NewEncoder(w).Encode(map[string]string{
        "status": "healthy",
    })
}

func helloHandler(w http.ResponseWriter, r *http.Request) {
    name := r.URL.Query().Get("name")
    if name == "" {
        name = "World"
    }
    w.Header().Set("Content-Type", "application/json")
    json.NewEncoder(w).Encode(map[string]string{
        "message": "Hello, " + name + "!",
    })
}`;

const crudCode = `package main

import (
    "encoding/json"
    "net/http"
    "sync"
    "time"

    "github.com/go-chi/chi/v5"
    "github.com/google/uuid"
)

// Project model
type Project struct {
    ID          string    \`json:"id"\`
    Name        string    \`json:"name"\`
    Description string    \`json:"description"\`
    CreatedAt   time.Time \`json:"created_at"\`
}

// In-memory storage
var (
    projects = make(map[string]*Project)
    mu       sync.RWMutex
)

// List projects
func listProjects(w http.ResponseWriter, r *http.Request) {
    mu.RLock()
    defer mu.RUnlock()

    items := make([]*Project, 0, len(projects))
    for _, p := range projects {
        items = append(items, p)
    }

    w.Header().Set("Content-Type", "application/json")
    json.NewEncoder(w).Encode(map[string]interface{}{
        "items": items,
        "total": len(items),
    })
}

// Create project
func createProject(w http.ResponseWriter, r *http.Request) {
    var req struct {
        Name        string \`json:"name"\`
        Description string \`json:"description"\`
    }
    if err := json.NewDecoder(r.Body).Decode(&req); err != nil {
        http.Error(w, \`{"error":"invalid body"}\`, http.StatusBadRequest)
        return
    }

    project := &Project{
        ID:          uuid.New().String(),
        Name:        req.Name,
        Description: req.Description,
        CreatedAt:   time.Now(),
    }

    mu.Lock()
    projects[project.ID] = project
    mu.Unlock()

    w.Header().Set("Content-Type", "application/json")
    w.WriteHeader(http.StatusCreated)
    json.NewEncoder(w).Encode(project)
}

// Get project
func getProject(w http.ResponseWriter, r *http.Request) {
    id := chi.URLParam(r, "id")

    mu.RLock()
    project, exists := projects[id]
    mu.RUnlock()

    if !exists {
        http.Error(w, \`{"error":"not found"}\`, http.StatusNotFound)
        return
    }

    w.Header().Set("Content-Type", "application/json")
    json.NewEncoder(w).Encode(project)
}

// Delete project
func deleteProject(w http.ResponseWriter, r *http.Request) {
    id := chi.URLParam(r, "id")

    mu.Lock()
    defer mu.Unlock()

    if _, exists := projects[id]; !exists {
        http.Error(w, \`{"error":"not found"}\`, http.StatusNotFound)
        return
    }

    delete(projects, id)
    w.WriteHeader(http.StatusNoContent)
}

// Router setup
func setupRoutes(r chi.Router) {
    r.Route("/api/v1/projects", func(r chi.Router) {
        r.Get("/", listProjects)
        r.Post("/", createProject)
        r.Get("/{id}", getProject)
        r.Delete("/{id}", deleteProject)
    })
}`;

const dockerfileCode = `# Build stage
FROM golang:1.22-alpine AS builder
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -ldflags="-w -s" -o server .

# Runtime stage
FROM alpine:3.20
WORKDIR /app
RUN adduser -D -g '' appuser
COPY --from=builder /app/server .
RUN chown -R appuser:appuser /app
USER appuser
EXPOSE 8080
CMD ["./server"]`;

const deployCode = `# Local test
docker build -t my-go-api .
docker run -p 8080:8080 my-go-api

# Check image size (< 20MB!)
docker images my-go-api

# Cloud Run deployment
gcloud run deploy my-go-api \\
  --source . \\
  --region asia-northeast3 \\
  --allow-unauthenticated \\
  --min-instances 0 \\
  --max-instances 1`;

const terminalSetup = `mkdir my-api && cd my-api
go mod init my-api
go get github.com/go-chi/chi/v5
go get github.com/go-chi/cors
go get github.com/google/uuid`;

const terminalRun = `go run main.go

# Test
curl http://localhost:8080/health
curl http://localhost:8080/api/hello?name=Choorai`;
---

<DocsLayout
  title="Go (Chi) - Lv.3 Performance-Focused"
  description="Fast execution, small images, low memory Go backend"
  currentPath="/map/backend/go"
  lang="en"
>
  <div class="max-w-4xl mx-auto px-6 py-8">
    <nav class="flex items-center gap-2 text-sm text-text-secondary mb-6" aria-label="Breadcrumb">
      <a href="/en" class="hover:text-white transition-colors">Home</a>
      <span>/</span>
      <a href="/en/map/backend" class="hover:text-white transition-colors">Backend Deployment</a>
      <span>/</span>
      <span class="text-primary font-medium">Go</span>
    </nav>

    <header class="mb-8 pb-6 border-b border-border">
      <div class="flex items-center gap-2 mb-4">
        <span class="px-3 py-1 rounded-full bg-blue-500/10 text-blue-400 text-xs font-bold">Lv.3 Performance</span>
        <span class="px-3 py-1 rounded-full bg-surface text-text-secondary text-xs">Go</span>
        <span class="px-3 py-1 rounded-full bg-surface text-text-secondary text-xs">Chi Router</span>
      </div>
      <h1 class="text-3xl md:text-4xl font-black text-white mb-4">
        Build a Performance-Focused Backend with Go
      </h1>
      <p class="text-text-secondary text-lg leading-relaxed">
        Go is a compiled language known for fast execution speed and low memory usage.
        Deploy as a single binary to keep Docker image size under 20MB.
      </p>
    </header>

    <section class="mb-10">
      <Callout client:load locale="en" variant="tip" title="Why Go?">
        <ul class="list-disc list-inside space-y-1 mt-2">
          <li>Fast execution speed (compiled language)</li>
          <li>Single binary deployment (no dependencies)</li>
          <li>Low memory usage (fast Cold Start)</li>
          <li>Docker image ~15MB</li>
          <li>Strong concurrency handling (goroutines)</li>
        </ul>
      </Callout>
    </section>

    <article class="prose prose-invert max-w-none">
      <!-- Project creation -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">1. Create Project</h2>

        <CodeBlock
          client:load
          code={terminalSetup}
          filename="Terminal"
        />

        <p class="text-text-secondary mt-4">
          Chi is a lightweight and fast Go router.
          It uses a middleware pattern similar to Express.js.
        </p>
      </section>

      <!-- First API -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">2. Write Your First API</h2>

        <CodeBlock
          client:load
          code={mainGoCode}
          filename="main.go"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Run</h3>

        <CodeBlock
          client:load
          code={terminalRun}
          filename="Terminal"
        />
      </section>

      <!-- CRUD API -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">3. Add CRUD API</h2>

        <CodeBlock
          client:load
          code={crudCode}
          filename="handlers.go"
        />

        <Callout client:load locale="en" variant="info" title="sync.RWMutex">
          <p class="text-sm mt-1">
            Go uses <code class="bg-surface px-1 rounded">sync.RWMutex</code> for concurrency safety.
            Multiple goroutines can read simultaneously, but only one can write at a time.
          </p>
        </Callout>
      </section>

      <!-- Docker deployment -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">4. Deploy with Docker</h2>

        <CodeBlock
          client:load
          code={dockerfileCode}
          filename="Dockerfile"
        />

        <p class="text-text-secondary mt-4 mb-4">
          Multi-stage builds ensure the final image contains only the binary.
          The resulting image size is approximately 15-20MB.
        </p>

        <CodeBlock
          client:load
          code={deployCode}
          filename="Terminal"
        />
      </section>

      <!-- Comparison -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">Framework Comparison</h2>

        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-border">
                <th class="text-left py-3 px-2 text-white">Category</th>
                <th class="text-left py-3 px-2 text-white">Go (Chi)</th>
                <th class="text-left py-3 px-2 text-white">Hono</th>
                <th class="text-left py-3 px-2 text-white">FastAPI</th>
              </tr>
            </thead>
            <tbody class="text-text-secondary">
              <tr class="border-b border-border/50">
                <td class="py-3 px-2">Image Size</td>
                <td class="py-3 px-2 text-green-400">~15MB</td>
                <td class="py-3 px-2">~150MB</td>
                <td class="py-3 px-2">~200MB</td>
              </tr>
              <tr class="border-b border-border/50">
                <td class="py-3 px-2">Cold Start</td>
                <td class="py-3 px-2 text-green-400">~100ms</td>
                <td class="py-3 px-2">~300ms</td>
                <td class="py-3 px-2">~500ms</td>
              </tr>
              <tr class="border-b border-border/50">
                <td class="py-3 px-2">Memory Usage</td>
                <td class="py-3 px-2 text-green-400">~20MB</td>
                <td class="py-3 px-2">~50MB</td>
                <td class="py-3 px-2">~80MB</td>
              </tr>
              <tr class="border-b border-border/50">
                <td class="py-3 px-2">Learning Curve</td>
                <td class="py-3 px-2 text-yellow-400">Medium</td>
                <td class="py-3 px-2 text-green-400">Easy</td>
                <td class="py-3 px-2 text-green-400">Easy</td>
              </tr>
              <tr>
                <td class="py-3 px-2">Type System</td>
                <td class="py-3 px-2 text-green-400">Static</td>
                <td class="py-3 px-2">Dynamic (TS)</td>
                <td class="py-3 px-2">Dynamic (Pydantic)</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- When to use -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">When Should You Choose Go?</h2>

        <div class="grid md:grid-cols-2 gap-4">
          <div class="p-4 bg-green-500/10 border border-green-500/30 rounded-xl">
            <h3 class="text-green-400 font-bold mb-2">Go Recommended</h3>
            <ul class="text-text-secondary text-sm space-y-1">
              <li>✅ Serverless where Cold Start matters</li>
              <li>✅ Cost optimization is a priority</li>
              <li>✅ High concurrent throughput</li>
              <li>✅ Microservices architecture</li>
            </ul>
          </div>
          <div class="p-4 bg-surface border border-border rounded-xl">
            <h3 class="text-white font-bold mb-2">Consider Other Options</h3>
            <ul class="text-text-secondary text-sm space-y-1">
              <li>Quick prototype: <a href="/en/map/backend/hono" class="text-primary">Hono</a></li>
              <li>Auto documentation: FastAPI</li>
              <li>Enterprise structure: <a href="/en/map/backend/nest" class="text-primary">NestJS</a></li>
            </ul>
          </div>
        </div>
      </section>

      <!-- Example code -->
      <section class="mb-10">
        <Callout client:load locale="en" variant="info" title="Full Example Code">
          <p class="text-sm mt-2">
            Check out the Go version of the B2B Admin API:
            <a href="https://github.com/curogom/choorai/tree/main/examples/b2b-admin/api-go" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline ml-1">
              examples/b2b-admin/api-go
            </a>
          </p>
        </Callout>
      </section>
    </article>

    <PageNavigation lang="en" currentPath="/map/backend/go" />
  </div>
</DocsLayout>
