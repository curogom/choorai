---
import DocsLayout from '../../../layouts/DocsLayout.astro';
import ModeToggle from '../../../components/ModeToggle';
import { MAP_NODES, EXTRA_NODES, getLocalizedNode } from '../../../data/mapNodes';

// Row 0 (top): Step 1-4
const localizedNodes = MAP_NODES.map((node) => getLocalizedNode(node, 'en'));
const localizedExtraNodes = EXTRA_NODES.map((node) => getLocalizedNode(node, 'en'));
const row0Nodes = localizedNodes.filter((n) => n.row === 0).sort((a, b) => a.order - b.order);
// Row 1 (bottom): Step 8-5 (reverse order, snake layout)
const row1Nodes = localizedNodes.filter((n) => n.row === 1).sort((a, b) => b.order - a.order);
---

<DocsLayout
  lang="en"
  title="Map - Service Deployment Roadmap"
  description="An 8-step roadmap to deploy your first service with AI"
  currentPath="/map"
>
  <div class="max-w-5xl mx-auto px-4 sm:px-6 py-8">
    <!-- Page Header -->
    <div class="text-center mb-8">
      <h1 class="text-2xl sm:text-3xl font-bold text-white mb-2">üó∫Ô∏è Service Deployment Roadmap</h1>
      <p class="text-text-secondary">8 steps to deploy your first service with AI</p>
    </div>

    <!-- Mode Toggle + Progress -->
    <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-8 p-4 bg-surface rounded-xl border border-border">
      <div class="flex items-center gap-4">
        <ModeToggle client:load />
        <div class="text-sm text-text-secondary">
          <span id="mode-description" class="hidden sm:inline">Follow in order (recommended for beginners)</span>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <span class="text-sm text-text-secondary">Progress:</span>
        <div class="w-32 h-2 bg-border rounded-full overflow-hidden">
          <div id="progress-bar" class="h-full bg-primary rounded-full transition-all duration-500" style="width: 0%"></div>
        </div>
        <span id="progress-text" class="text-sm font-medium text-primary">0/8</span>
      </div>
    </div>

    <!-- Main Roadmap: Step-by-Step -->
    <div class="roadmap-container">
      <!-- Row 0: Step 1-4 -->
      <div class="roadmap-row">
        {row0Nodes.map((node, idx) => (
          <div class="roadmap-step">
            <a
              href={node.href}
              class="map-node block p-4 bg-surface border-2 border-border rounded-xl hover:border-primary/50 transition-all hover:-translate-y-1 group"
              data-node-id={node.id}
              data-node-order={node.order}
            >
              <div class="flex items-center gap-2 mb-2">
                <span class="step-number text-xs font-bold px-2 py-0.5 rounded bg-primary/20 text-primary">
                  Step {node.order}
                </span>
                <span class="node-status text-xs px-2 py-0.5 rounded-full bg-surface-elevated text-text-secondary">
                  Pending
                </span>
              </div>
              <div class="flex items-center gap-2 mb-2">
                <span class="text-xl">{node.icon}</span>
                <h3 class="text-sm font-bold text-white group-hover:text-primary transition-colors">{node.title}</h3>
              </div>
              <p class="text-xs text-text-secondary line-clamp-2">{node.what}</p>
              <div class="mt-2 text-xs text-text-muted">{node.time}</div>
            </a>
            {idx < row0Nodes.length - 1 && (
              <div class="arrow-right">‚Üí</div>
            )}
          </div>
        ))}
      </div>

      <!-- Connector: Row 0 ‚Üí Row 1 -->
      <div class="roadmap-connector">
        <div class="connector-line"></div>
        <div class="connector-arrow">‚Üì</div>
      </div>

      <!-- Row 1: Step 8-5 (reverse, snake layout) -->
      <div class="roadmap-row">
        {row1Nodes.map((node, idx) => (
          <div class="roadmap-step">
            <a
              href={node.href}
              class="map-node block p-4 bg-surface border-2 border-border rounded-xl hover:border-primary/50 transition-all hover:-translate-y-1 group"
              data-node-id={node.id}
              data-node-order={node.order}
            >
              <div class="flex items-center gap-2 mb-2">
                <span class="step-number text-xs font-bold px-2 py-0.5 rounded bg-primary/20 text-primary">
                  Step {node.order}
                </span>
                <span class="node-status text-xs px-2 py-0.5 rounded-full bg-surface-elevated text-text-secondary">
                  Pending
                </span>
              </div>
              <div class="flex items-center gap-2 mb-2">
                <span class="text-xl">{node.icon}</span>
                <h3 class="text-sm font-bold text-white group-hover:text-primary transition-colors">{node.title}</h3>
              </div>
              <p class="text-xs text-text-secondary line-clamp-2">{node.what}</p>
              <div class="mt-2 text-xs text-text-muted">{node.time}</div>
            </a>
            {idx < row1Nodes.length - 1 && (
              <div class="arrow-right">‚Üê</div>
            )}
          </div>
        ))}
      </div>
    </div>

    <!-- Additional Learning -->
    <div class="mt-12 pt-8 border-t border-border">
      <h2 class="text-lg font-bold text-white mb-4">Additional Learning</h2>
      <p class="text-sm text-text-secondary mb-6">Challenge yourself after completing the 8 core steps</p>

      <div class="grid sm:grid-cols-3 gap-4">
        {localizedExtraNodes.map(node => (
          <a
            href={node.href}
            class="extra-node block p-4 bg-surface/50 border border-border rounded-xl hover:border-primary/30 transition-all group"
            data-node-id={node.id}
          >
            <div class="flex items-center gap-3 mb-2">
              <span class="text-xl">{node.icon}</span>
              <h3 class="font-bold text-white group-hover:text-primary transition-colors">{node.title}</h3>
            </div>
            <p class="text-xs text-text-secondary">{node.what}</p>
          </a>
        ))}
      </div>
    </div>

    <!-- Quick Start CTA -->
    <div class="mt-12 p-6 bg-gradient-to-r from-primary/10 to-primary/5 rounded-xl border border-primary/20 text-center">
      <h2 class="text-lg font-bold text-white mb-2">New here?</h2>
      <p class="text-sm text-text-secondary mb-4">Get guided from start to finish with the 60-minute completion course</p>
      <a
        href="/path/60min"
        class="inline-flex items-center gap-2 px-6 py-3 bg-primary hover:bg-primary-hover text-background font-bold rounded-lg transition-all hover:scale-[1.02]"
      >
        Start the 60-Minute Course
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
        </svg>
      </a>
    </div>
  </div>

  <style>
    /* Roadmap container */
    .roadmap-container {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    /* Roadmap row */
    .roadmap-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0;
      flex-wrap: wrap;
    }

    /* Each step (node + arrow) */
    .roadmap-step {
      display: flex;
      align-items: center;
    }

    .roadmap-step .map-node {
      width: 200px;
      min-height: 150px;
    }

    /* Arrow */
    .arrow-right {
      font-size: 1.5rem;
      color: var(--color-primary);
      padding: 0 0.75rem;
      font-weight: bold;
    }

    /* Row connector */
    .roadmap-connector {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      padding-right: calc(200px / 2 + 0.5rem);
      margin: 0.5rem 0;
    }

    .connector-line {
      width: 2px;
      height: 20px;
      background: var(--color-primary);
    }

    .connector-arrow {
      font-size: 1.25rem;
      color: var(--color-primary);
      font-weight: bold;
      line-height: 1;
    }

    /* Mobile responsive */
    @media (max-width: 900px) {
      .roadmap-row {
        flex-direction: column;
        gap: 0.5rem;
      }

      .roadmap-step {
        flex-direction: column;
      }

      .roadmap-step .map-node {
        width: 100%;
        max-width: 300px;
        min-height: auto;
      }

      .arrow-right {
        transform: rotate(90deg);
        padding: 0.5rem 0;
      }

      .roadmap-connector {
        align-items: center;
        padding-right: 0;
      }
    }

    @media (min-width: 901px) and (max-width: 1100px) {
      .roadmap-step .map-node {
        width: 180px;
        min-height: 140px;
      }

      .arrow-right {
        padding: 0 0.5rem;
        font-size: 1.25rem;
      }
    }
  </style>

  <script>
    // Map page client logic
    const STORAGE_KEY = 'choorai-map-completed-nodes';
    const MODE_KEY = 'choorai-learning-mode';

    function getCompletedNodes(): string[] {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (!saved) return [];
      try {
        return JSON.parse(saved);
      } catch {
        return [];
      }
    }

    function getMode(): 'guided' | 'explore' {
      return localStorage.getItem(MODE_KEY) === 'explore' ? 'explore' : 'guided';
    }

    function updateUI() {
      const completed = getCompletedNodes();
      const mode = getMode();
      const totalNodes = 8;

      // Update progress
      const progressBar = document.getElementById('progress-bar');
      const progressText = document.getElementById('progress-text');
      const progress = Math.round((completed.length / totalNodes) * 100);
      if (progressBar) progressBar.style.width = `${progress}%`;
      if (progressText) progressText.textContent = `${completed.length}/${totalNodes}`;

      // Update mode description
      const modeDesc = document.getElementById('mode-description');
      if (modeDesc) {
        modeDesc.textContent = mode === 'guided'
          ? 'Follow in order (recommended for beginners)'
          : 'Explore freely';
      }

      // Update node status
      document.querySelectorAll('.map-node').forEach(el => {
        const nodeId = el.getAttribute('data-node-id');
        const nodeOrder = parseInt(el.getAttribute('data-node-order') || '1');
        const statusEl = el.querySelector('.node-status');
        const stepEl = el.querySelector('.step-number');

        if (!nodeId || !statusEl) return;

        const isCompleted = completed.includes(nodeId);
        const isLocked = mode === 'guided' && !isCompleted && completed.length < nodeOrder - 1;
        const isCurrent = mode === 'guided' && !isCompleted && completed.length >= nodeOrder - 1;

        // Reset styles
        el.classList.remove('border-success/50', 'border-primary', 'opacity-50', 'pointer-events-none', 'ring-2', 'ring-primary');
        statusEl.classList.remove('bg-success/20', 'text-success', 'bg-primary/20', 'text-primary', 'bg-red-500/20', 'text-red-400');
        if (stepEl) {
          stepEl.classList.remove('bg-success/20', 'text-success', 'bg-red-500/20', 'text-red-400');
          stepEl.classList.add('bg-primary/20', 'text-primary');
        }

        if (isCompleted) {
          el.classList.add('border-success/50');
          statusEl.classList.add('bg-success/20', 'text-success');
          statusEl.textContent = '‚úì Done';
          if (stepEl) {
            stepEl.classList.remove('bg-primary/20', 'text-primary');
            stepEl.classList.add('bg-success/20', 'text-success');
          }
        } else if (isLocked) {
          el.classList.add('opacity-50', 'pointer-events-none');
          statusEl.classList.add('bg-red-500/20', 'text-red-400');
          statusEl.textContent = 'üîí Locked';
          if (stepEl) {
            stepEl.classList.remove('bg-primary/20', 'text-primary');
            stepEl.classList.add('bg-red-500/20', 'text-red-400');
          }
        } else if (isCurrent) {
          el.classList.add('border-primary', 'ring-2', 'ring-primary');
          statusEl.classList.add('bg-primary/20', 'text-primary');
          statusEl.textContent = '‚Üí Current';
        } else {
          statusEl.textContent = 'Pending';
        }
      });
    }

    // Initialize
    updateUI();

    // Event listeners
    window.addEventListener('map-progress-change', updateUI);
    window.addEventListener('learning-mode-change', updateUI);
    window.addEventListener('storage', updateUI);
  </script>
</DocsLayout>
