---
import DocsLayout from '../../../layouts/DocsLayout.astro';
import Callout from '../../../components/Callout';
import CodeBlock from '../../../components/CodeBlock';
import PageNavigation from '../../../components/PageNavigation.astro';
---

<DocsLayout
  lang="en"
  title="Cycle 7: Docker - Containerization"
  description="Containerize your application with Docker and run it identically anywhere"
  currentPath="/map/docker"
>
  <div class="max-w-4xl mx-auto px-6 py-8">
    <nav class="flex items-center gap-2 text-sm text-text-secondary mb-6" aria-label="Breadcrumb">
      <a href="/en" class="hover:text-white transition-colors">Home</a>
      <span>/</span>
      <a href="/en/map" class="hover:text-white transition-colors">Learning Cycles</a>
      <span>/</span>
      <span class="text-primary font-medium">Cycle 7: Docker</span>
    </nav>

    <header class="mb-8 pb-6 border-b border-border">
      <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-primary/10 text-primary text-xs font-bold mb-4">
        Cycle 7
      </div>
      <h1 class="text-3xl md:text-4xl font-black text-white mb-4">
        Docker - Containerization
      </h1>
      <p class="text-text-secondary text-lg leading-relaxed">
        Containerizing your application with Docker eliminates the "it works on my machine..." problem.
        It runs identically in the same environment anywhere.
      </p>
    </header>

    <section class="mb-10">
      <Callout client:load locale="en" variant="tip" title="What you'll learn in this Cycle">
        <ul class="list-disc list-inside space-y-1 mt-2">
          <li>Understanding container concepts and benefits</li>
          <li>Writing Dockerfiles and building images</li>
          <li>Managing multi-container setups with Docker Compose</li>
          <li>Deploying images to cloud registries</li>
        </ul>
      </Callout>
    </section>

    <article class="prose prose-invert max-w-none">
      <!-- What is a Container? -->
      <section class="mb-10" id="concept">
        <h2 class="text-2xl font-bold text-white mb-4">What is a Container?</h2>

        <p class="text-text-secondary mb-4">
          A container packages an application along with <strong class="text-white">everything it needs to run</strong>
          (code, libraries, configuration) into a single bundle.
        </p>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">VM vs Container</h3>

        <div class="grid md:grid-cols-2 gap-4 mb-6">
          <div class="p-4 bg-blue-500/10 border border-blue-500/30 rounded-xl">
            <h4 class="text-white font-bold mb-2">Virtual Machine (VM)</h4>
            <div class="space-y-2 text-sm">
              <div class="p-2 bg-surface rounded text-center text-text-secondary">App</div>
              <div class="p-2 bg-surface rounded text-center text-text-secondary">Libraries</div>
              <div class="p-2 bg-blue-500/30 rounded text-center text-blue-300">Guest OS (several GB)</div>
              <div class="p-2 bg-surface rounded text-center text-text-secondary">Hypervisor</div>
              <div class="p-2 bg-surface rounded text-center text-text-secondary">Host OS</div>
            </div>
            <p class="text-xs text-text-secondary mt-3">
              Includes entire OS, making it heavy and slow
            </p>
          </div>

          <div class="p-4 bg-green-500/10 border border-green-500/30 rounded-xl">
            <h4 class="text-white font-bold mb-2">Container</h4>
            <div class="space-y-2 text-sm">
              <div class="p-2 bg-surface rounded text-center text-text-secondary">App</div>
              <div class="p-2 bg-surface rounded text-center text-text-secondary">Libraries</div>
              <div class="p-2 bg-green-500/30 rounded text-center text-green-300">Container Engine (lightweight)</div>
              <div class="p-2 bg-surface rounded text-center text-text-secondary">Host OS</div>
            </div>
            <p class="text-xs text-text-secondary mt-3">
              Shares OS kernel, making it lightweight and fast
            </p>
          </div>
        </div>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Docker Core Concepts</h3>

        <div class="space-y-3 mb-6">
          <div class="flex items-start gap-3 p-3 bg-surface border border-border rounded-lg">
            <span class="text-2xl">üì¶</span>
            <div>
              <h4 class="text-white font-bold">Image</h4>
              <p class="text-text-secondary text-sm">
                The "blueprint" of a container. Defined by a Dockerfile, immutable once built.
              </p>
            </div>
          </div>
          <div class="flex items-start gap-3 p-3 bg-surface border border-border rounded-lg">
            <span class="text-2xl">üê≥</span>
            <div>
              <h4 class="text-white font-bold">Container</h4>
              <p class="text-text-secondary text-sm">
                A running "instance" of an image. You can run multiple; data is lost when deleted.
              </p>
            </div>
          </div>
          <div class="flex items-start gap-3 p-3 bg-surface border border-border rounded-lg">
            <span class="text-2xl">üè™</span>
            <div>
              <h4 class="text-white font-bold">Registry</h4>
              <p class="text-text-secondary text-sm">
                A "repository" for storing and sharing images. Docker Hub, GCR, GHCR, etc.
              </p>
            </div>
          </div>
        </div>

        <Callout client:load locale="en" variant="tip" title="Why use containers?">
          <ul class="list-disc list-inside mt-2 text-sm space-y-1">
            <li><strong class="text-white">Environment consistency</strong>: Dev/test/production environments are identical</li>
            <li><strong class="text-white">Fast deployment</strong>: Just download the image and run</li>
            <li><strong class="text-white">Isolation</strong>: Runs independently without conflicting with other apps</li>
            <li><strong class="text-white">Scalability</strong>: Run multiple containers from the same image</li>
          </ul>
        </Callout>
      </section>

      <!-- Dockerfile Basics -->
      <section class="mb-10" id="dockerfile">
        <h2 class="text-2xl font-bold text-white mb-4">Dockerfile Basics</h2>

        <p class="text-text-secondary mb-4">
          A Dockerfile is a <strong class="text-white">"recipe"</strong> for building images.
          Each instruction stacks a layer to create the final image.
        </p>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Basic Instructions</h3>

        <div class="overflow-x-auto mb-6">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-border">
                <th class="text-left py-3 px-3 text-white">Instruction</th>
                <th class="text-left py-3 px-3 text-white">Description</th>
                <th class="text-left py-3 px-3 text-white">Example</th>
              </tr>
            </thead>
            <tbody>
              <tr class="border-b border-border/50">
                <td class="py-3 px-3 text-primary font-mono">FROM</td>
                <td class="py-3 px-3 text-text-secondary">Specify base image</td>
                <td class="py-3 px-3 text-text-secondary font-mono text-xs">FROM python:3.11-slim</td>
              </tr>
              <tr class="border-b border-border/50">
                <td class="py-3 px-3 text-primary font-mono">WORKDIR</td>
                <td class="py-3 px-3 text-text-secondary">Set working directory</td>
                <td class="py-3 px-3 text-text-secondary font-mono text-xs">WORKDIR /app</td>
              </tr>
              <tr class="border-b border-border/50">
                <td class="py-3 px-3 text-primary font-mono">COPY</td>
                <td class="py-3 px-3 text-text-secondary">Copy files</td>
                <td class="py-3 px-3 text-text-secondary font-mono text-xs">COPY . .</td>
              </tr>
              <tr class="border-b border-border/50">
                <td class="py-3 px-3 text-primary font-mono">RUN</td>
                <td class="py-3 px-3 text-text-secondary">Execute command at build time</td>
                <td class="py-3 px-3 text-text-secondary font-mono text-xs">RUN pip install -r requirements.txt</td>
              </tr>
              <tr class="border-b border-border/50">
                <td class="py-3 px-3 text-primary font-mono">EXPOSE</td>
                <td class="py-3 px-3 text-text-secondary">Document port</td>
                <td class="py-3 px-3 text-text-secondary font-mono text-xs">EXPOSE 8000</td>
              </tr>
              <tr>
                <td class="py-3 px-3 text-primary font-mono">CMD</td>
                <td class="py-3 px-3 text-text-secondary">Container run command</td>
                <td class="py-3 px-3 text-text-secondary font-mono text-xs">CMD ["uvicorn", "main:app"]</td>
              </tr>
            </tbody>
          </table>
        </div>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Python (FastAPI) Dockerfile</h3>

        <CodeBlock
          client:load
          code={`# Use Python 3.11 slim image (minimize size)
FROM python:3.11-slim

# Set working directory
WORKDIR /app

# Copy dependency file first (caching optimization)
COPY requirements.txt .

# Install dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Copy source code
COPY . .

# Expose port (for documentation)
EXPOSE 8000

# Container run command
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]`}
          filename="Dockerfile (FastAPI)"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Node.js (Hono) Dockerfile</h3>

        <CodeBlock
          client:load
          code={`# Node.js 20 LTS Alpine image (lightweight)
FROM node:20-alpine

# Set working directory
WORKDIR /app

# Copy package files first (caching optimization)
COPY package*.json ./

# Install dependencies (production only)
RUN npm ci --only=production

# Copy source code
COPY . .

# Expose port
EXPOSE 3000

# Container run command
CMD ["node", "src/index.js"]`}
          filename="Dockerfile (Hono/Node.js)"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Multi-stage Build (Optimization)</h3>

        <p class="text-text-secondary mb-4">
          Separate build and runtime images to <strong class="text-white">reduce the final image size</strong>.
        </p>

        <CodeBlock
          client:load
          code={`# Stage 1: Build
FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

# Stage 2: Production
FROM node:20-alpine
WORKDIR /app
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
EXPOSE 3000
CMD ["node", "dist/index.js"]`}
          filename="Dockerfile (Multi-stage)"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Build & Run Image</h3>

        <CodeBlock
          client:load
          code={`# Build image
docker build -t my-api:latest .

# Run container
docker run -p 8000:8000 my-api:latest

# Run in background
docker run -d -p 8000:8000 --name my-api my-api:latest

# View logs
docker logs my-api

# Stop & remove container
docker stop my-api && docker rm my-api`}
          filename="Terminal"
        />
      </section>

      <!-- Docker Compose -->
      <section class="mb-10" id="compose">
        <h2 class="text-2xl font-bold text-white mb-4">Docker Compose</h2>

        <p class="text-text-secondary mb-4">
          <strong class="text-white">Define and run multiple containers at once</strong>.
          Manage frontend, backend, and DB in a single file.
        </p>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Why Do We Need Compose?</h3>

        <div class="grid md:grid-cols-2 gap-4 mb-6">
          <div class="p-4 bg-red-500/10 border border-red-500/30 rounded-xl">
            <h4 class="text-red-400 font-bold mb-2">‚ùå Repeating docker run</h4>
            <div class="text-text-secondary text-xs font-mono space-y-1">
              <p>docker run -d postgres...</p>
              <p>docker run -d redis...</p>
              <p>docker run -d my-api...</p>
              <p>docker run -d my-frontend...</p>
            </div>
          </div>
          <div class="p-4 bg-green-500/10 border border-green-500/30 rounded-xl">
            <h4 class="text-green-400 font-bold mb-2">‚úÖ One Compose command</h4>
            <div class="text-text-secondary text-xs font-mono">
              <p>docker compose up -d</p>
              <p class="text-green-400 mt-2">All services started at once!</p>
            </div>
          </div>
        </div>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">docker-compose.yml Example (Python Stack)</h3>

        <CodeBlock
          client:load
          code={`version: '3.8'

services:
  # PostgreSQL database
  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD: mypassword
      POSTGRES_DB: mydb
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  # FastAPI backend
  api:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      DATABASE_URL: postgresql://myuser:mypassword@db:5432/mydb
    depends_on:
      - db

  # React frontend
  web:
    build: ./frontend
    ports:
      - "3000:3000"
    depends_on:
      - api

volumes:
  postgres_data:`}
          filename="docker-compose.yml"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">docker-compose.yml Example (Node.js Stack)</h3>

        <CodeBlock
          client:load
          code={`version: '3.8'

services:
  # PostgreSQL database
  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD: mypassword
      POSTGRES_DB: mydb
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  # Hono backend
  api:
    build: ./backend
    ports:
      - "3001:3001"
    environment:
      DATABASE_URL: postgresql://myuser:mypassword@db:5432/mydb
    depends_on:
      - db

  # Vite frontend
  web:
    build: ./frontend
    ports:
      - "5173:5173"
    depends_on:
      - api

volumes:
  postgres_data:`}
          filename="docker-compose.yml (Node.js)"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Key Commands</h3>

        <div class="overflow-x-auto mb-6">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-border">
                <th class="text-left py-3 px-3 text-white">Command</th>
                <th class="text-left py-3 px-3 text-white">Description</th>
              </tr>
            </thead>
            <tbody>
              <tr class="border-b border-border/50">
                <td class="py-3 px-3 text-primary font-mono">docker compose up -d</td>
                <td class="py-3 px-3 text-text-secondary">Start all services in background</td>
              </tr>
              <tr class="border-b border-border/50">
                <td class="py-3 px-3 text-primary font-mono">docker compose down</td>
                <td class="py-3 px-3 text-text-secondary">Stop & remove all services</td>
              </tr>
              <tr class="border-b border-border/50">
                <td class="py-3 px-3 text-primary font-mono">docker compose logs -f api</td>
                <td class="py-3 px-3 text-text-secondary">Stream api service logs in real time</td>
              </tr>
              <tr class="border-b border-border/50">
                <td class="py-3 px-3 text-primary font-mono">docker compose exec api sh</td>
                <td class="py-3 px-3 text-text-secondary">Open a shell in the api container</td>
              </tr>
              <tr>
                <td class="py-3 px-3 text-primary font-mono">docker compose build</td>
                <td class="py-3 px-3 text-text-secondary">Rebuild images</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Image Registry -->
      <section class="mb-10" id="registry">
        <h2 class="text-2xl font-bold text-white mb-4">Image Registry</h2>

        <p class="text-text-secondary mb-4">
          <strong class="text-white">Store built images in the cloud</strong> so they can be pulled and run from anywhere.
        </p>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Registry Comparison</h3>

        <div class="grid md:grid-cols-3 gap-4 mb-6">
          <div class="p-4 bg-surface border border-border rounded-xl">
            <h4 class="text-white font-bold mb-2">Docker Hub</h4>
            <p class="text-text-secondary text-sm mb-2">The most widely used public registry</p>
            <ul class="text-xs text-text-secondary space-y-1">
              <li>‚úÖ Unlimited public images</li>
              <li>‚úÖ Easy to use</li>
              <li>‚ö†Ô∏è Only 1 private repo free</li>
            </ul>
          </div>
          <div class="p-4 bg-surface border border-border rounded-xl">
            <h4 class="text-white font-bold mb-2">GCR / Artifact Registry</h4>
            <p class="text-text-secondary text-sm mb-2">Google Cloud's registry</p>
            <ul class="text-xs text-text-secondary space-y-1">
              <li>‚úÖ Best integration with Cloud Run</li>
              <li>‚úÖ Private by default</li>
              <li>‚ö†Ô∏è Storage costs apply</li>
            </ul>
          </div>
          <div class="p-4 bg-surface border border-border rounded-xl">
            <h4 class="text-white font-bold mb-2">GitHub Container Registry</h4>
            <p class="text-text-secondary text-sm mb-2">Registry integrated with GitHub</p>
            <ul class="text-xs text-text-secondary space-y-1">
              <li>‚úÖ GitHub Actions integration</li>
              <li>‚úÖ Public is free</li>
              <li>‚ö†Ô∏è Private 500MB free</li>
            </ul>
          </div>
        </div>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Push Image to GCR</h3>

        <CodeBlock
          client:load
          code={`# 1. Authenticate with gcloud
gcloud auth configure-docker asia-northeast3-docker.pkg.dev

# 2. Tag the image
docker tag my-api:latest \\
  asia-northeast3-docker.pkg.dev/PROJECT_ID/my-repo/my-api:latest

# 3. Push the image
docker push asia-northeast3-docker.pkg.dev/PROJECT_ID/my-repo/my-api:latest

# 4. Use with Cloud Run
gcloud run deploy my-api \\
  --image=asia-northeast3-docker.pkg.dev/PROJECT_ID/my-repo/my-api:latest \\
  --region=asia-northeast3`}
          filename="Terminal (GCR)"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Push to GitHub Container Registry</h3>

        <CodeBlock
          client:load
          code={`# 1. Log in with GitHub Personal Access Token
echo $GITHUB_TOKEN | docker login ghcr.io -u USERNAME --password-stdin

# 2. Tag the image
docker tag my-api:latest ghcr.io/USERNAME/my-api:latest

# 3. Push the image
docker push ghcr.io/USERNAME/my-api:latest`}
          filename="Terminal (GHCR)"
        />
      </section>

      <!-- Practical Tips -->
      <section class="mb-10" id="tips">
        <h2 class="text-2xl font-bold text-white mb-4">Practical Tips & Best Practices</h2>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">.dockerignore Setup</h3>

        <p class="text-text-secondary mb-4">
          <strong class="text-white">Exclude unnecessary files</strong> from the build context to speed up builds.
        </p>

        <CodeBlock
          client:load
          code={`# Version control
.git
.gitignore

# Dependencies (installed fresh in image)
node_modules
__pycache__
.venv
venv

# Build artifacts
dist
build
*.pyc

# Development files
.env.local
.env.development
*.log

# IDE
.vscode
.idea

# Docker related
Dockerfile
docker-compose*.yml
.dockerignore`}
          filename=".dockerignore"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Layer Caching Optimization</h3>

        <div class="grid md:grid-cols-2 gap-4 mb-6">
          <div class="p-4 bg-red-500/10 border border-red-500/30 rounded-xl">
            <h4 class="text-red-400 font-bold mb-2">‚ùå Inefficient</h4>
            <div class="text-text-secondary text-xs font-mono space-y-1">
              <p>COPY . .</p>
              <p>RUN pip install -r requirements.txt</p>
            </div>
            <p class="text-xs text-text-secondary mt-2">
              Dependencies reinstalled on every source change
            </p>
          </div>
          <div class="p-4 bg-green-500/10 border border-green-500/30 rounded-xl">
            <h4 class="text-green-400 font-bold mb-2">‚úÖ Efficient</h4>
            <div class="text-text-secondary text-xs font-mono space-y-1">
              <p>COPY requirements.txt .</p>
              <p>RUN pip install -r requirements.txt</p>
              <p>COPY . .</p>
            </div>
            <p class="text-xs text-text-secondary mt-2">
              Cache used when dependency file hasn't changed
            </p>
          </div>
        </div>

        <Callout client:load locale="en" variant="warning" title="Security Considerations">
          <ul class="list-disc list-inside mt-2 text-sm space-y-1">
            <li><strong class="text-white">Avoid root user</strong>: Set a non-root user with the USER instruction</li>
            <li><strong class="text-white">Watch for secrets</strong>: Never hardcode passwords in Dockerfiles</li>
            <li><strong class="text-white">Latest base images</strong>: Use the latest versions with security patches</li>
            <li><strong class="text-white">Least privilege</strong>: Install only necessary packages</li>
          </ul>
        </Callout>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Debugging Tips</h3>

        <CodeBlock
          client:load
          code={`# List running containers
docker ps

# View container logs
docker logs -f my-container

# Access container shell
docker exec -it my-container sh

# Check image history (size per layer)
docker history my-api:latest

# Clean up unused resources
docker system prune -a`}
          filename="Terminal"
        />
      </section>

      <!-- Wrap-up -->
      <section class="mb-10">
        <Callout client:load locale="en" variant="info" title="Next Steps">
          <p class="text-sm">
            Now that you have completed containerization with Docker,
            set up <a href="/en/map/cicd" class="text-primary hover:underline ml-1">CI/CD</a>
            to automatically deploy with just a code push.
          </p>
        </Callout>
      </section>
    </article>

    <PageNavigation currentPath="/map/docker" lang="en" />
  </div>
</DocsLayout>
