---
import DocsLayout from '../../../layouts/DocsLayout.astro';
import Callout from '../../../components/Callout';
import CodeBlock from '../../../components/CodeBlock';
import SectionHeader from '../../../components/SectionHeader';
import MetaBadge from '../../../components/MetaBadge';
import PageNavigation from '../../../components/PageNavigation.astro';
---

<DocsLayout
  lang="en"
  title="Getting Started with Supabase (Lv.3)"
  description="How to implement databases and authentication without a backend using Supabase"
  currentPath="/baas/supabase"
>
  <div class="max-w-4xl mx-auto px-6 py-8">
    <nav class="flex items-center gap-2 text-sm text-text-secondary mb-6" aria-label="Breadcrumb">
      <a href="/en" class="hover:text-white transition-colors">Home</a>
      <span>/</span>
      <span class="text-primary font-medium">BaaS</span>
      <span>/</span>
      <span class="text-primary font-medium">Supabase</span>
    </nav>

    <header class="mb-8 pb-6 border-b border-border">
      <div class="flex items-center gap-2 mb-4">
        <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-green-500/10 text-green-400 text-xs font-bold">
          Lv.3
        </span>
        <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-emerald-500/10 text-emerald-400 text-xs font-bold">
          BaaS
        </span>
      </div>
      <h1 class="text-3xl md:text-4xl font-black text-white mb-4">
        Getting Started with Supabase
      </h1>
      <p class="text-text-secondary text-lg leading-relaxed">
        With <strong class="text-white">Backend-as-a-Service</strong>, you can use
        a PostgreSQL database and authentication without a separate backend server.
      </p>
    </header>

    <section class="mb-10">
      <Callout client:load locale="en" variant="tip" title="What is Supabase?">
        <ul class="list-disc list-inside space-y-1 mt-2">
          <li><strong class="text-white">PostgreSQL</strong>-based managed database</li>
          <li><strong class="text-white">Auth</strong> - Built-in email/social login</li>
          <li><strong class="text-white">Row Level Security</strong> - Data access control</li>
          <li><strong class="text-white">Realtime subscriptions</strong> - Automatic notifications on data changes</li>
          <li><strong class="text-white">Free tier</strong> - 50,000 MAU, 500MB storage</li>
        </ul>
      </Callout>
    </section>

    <article class="prose prose-invert max-w-none">
      <!-- Step 1: Create Project -->
      <section class="mb-10">
        <SectionHeader number={1} title="Create a Supabase Project" />

        <ol class="list-decimal list-inside text-text-secondary space-y-3 mb-4">
          <li>
            Sign up at
            <a href="https://supabase.com" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">
              supabase.com
            </a> (GitHub login recommended)
          </li>
          <li>Click <strong class="text-white">New project</strong></li>
          <li>Enter a project name</li>
          <li>Set a database password (save it somewhere safe!)</li>
          <li>Select a region: <code class="bg-surface px-1 rounded">Northeast Asia (Seoul)</code> recommended</li>
          <li>Click <strong class="text-white">Create new project</strong></li>
        </ol>

        <Callout client:load locale="en" variant="info">
          <p>Project creation takes about 1-2 minutes. Once complete, you can find your API keys in the dashboard.</p>
        </Callout>
      </section>

      <!-- Step 2: Create Tables -->
      <section class="mb-10">
        <SectionHeader number={2} title="Create Tables (SQL Editor)" />

        <p class="text-text-secondary mb-4">
          Open the <strong class="text-white">SQL Editor</strong> in the dashboard and run the schema below.
        </p>

        <CodeBlock
          client:load
          code={`-- Create todos table
create table todos (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references auth.users(id) on delete cascade,
  title text not null,
  completed boolean default false,
  created_at timestamptz default now()
);

-- Enable RLS (Row Level Security)
alter table todos enable row level security;

-- Policy: users can only view their own data
create policy "Users can view own todos"
  on todos for select
  using (auth.uid() = user_id);

-- Policy: users can only insert their own data
create policy "Users can insert own todos"
  on todos for insert
  with check (auth.uid() = user_id);

-- Policy: users can only update their own data
create policy "Users can update own todos"
  on todos for update
  using (auth.uid() = user_id);

-- Policy: users can only delete their own data
create policy "Users can delete own todos"
  on todos for delete
  using (auth.uid() = user_id);`}
          filename="SQL Editor"
        />

        <Callout client:load locale="en" variant="warning" title="Why RLS matters">
          <p class="text-sm mt-2">
            Without RLS, <strong class="text-white">all users can access all data</strong>.
            <code class="bg-surface px-1 rounded">auth.uid()</code> returns the currently logged-in user's ID.
          </p>
        </Callout>
      </section>

      <!-- Step 3: Client Setup -->
      <section class="mb-10">
        <SectionHeader number={3} title="Client Setup (React)" />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Install Dependencies</h3>

        <CodeBlock
          client:load
          code={`npm install @supabase/supabase-js @tanstack/react-query`}
          filename="Terminal"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Environment Variables</h3>

        <CodeBlock
          client:load
          code={`# .env.local
VITE_SUPABASE_URL=https://your-project-id.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key`}
          filename=".env.local"
        />

        <p class="text-text-secondary text-sm mt-2 mb-4">
          Find these in the Supabase dashboard under <strong class="text-white">Settings</strong> → <strong class="text-white">API</strong>.
        </p>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Supabase Client</h3>

        <CodeBlock
          client:load
          code={`// src/lib/supabase.ts
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

export const supabase = createClient(supabaseUrl, supabaseAnonKey);`}
          filename="src/lib/supabase.ts"
        />
      </section>

      <!-- Step 4: CRUD Example -->
      <section class="mb-10">
        <SectionHeader number={4} title="CRUD Example (React Query + Supabase)" />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Type Definitions</h3>

        <CodeBlock
          client:load
          code={`// src/types/todo.ts
export interface Todo {
  id: string;
  user_id: string;
  title: string;
  completed: boolean;
  created_at: string;
}

export type CreateTodoInput = Pick<Todo, 'title'>;
export type UpdateTodoInput = Partial<Pick<Todo, 'title' | 'completed'>>;`}
          filename="src/types/todo.ts"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Hooks (TanStack Query)</h3>

        <CodeBlock
          client:load
          code={`// src/hooks/useTodos.ts
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { supabase } from '../lib/supabase';
import type { Todo, CreateTodoInput, UpdateTodoInput } from '../types/todo';

// Fetch list
export function useTodos() {
  return useQuery({
    queryKey: ['todos'],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('todos')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) throw error;
      return data as Todo[];
    },
  });
}

// Create
export function useCreateTodo() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async (input: CreateTodoInput) => {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error('Not authenticated');

      const { data, error } = await supabase
        .from('todos')
        .insert({ ...input, user_id: user.id })
        .select()
        .single();

      if (error) throw error;
      return data as Todo;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['todos'] });
    },
  });
}

// Update
export function useUpdateTodo() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({ id, ...input }: UpdateTodoInput & { id: string }) => {
      const { data, error } = await supabase
        .from('todos')
        .update(input)
        .eq('id', id)
        .select()
        .single();

      if (error) throw error;
      return data as Todo;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['todos'] });
    },
  });
}

// Delete
export function useDeleteTodo() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async (id: string) => {
      const { error } = await supabase
        .from('todos')
        .delete()
        .eq('id', id);

      if (error) throw error;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['todos'] });
    },
  });
}`}
          filename="src/hooks/useTodos.ts"
        />
      </section>

      <!-- Step 5: Authentication Example -->
      <section class="mb-10">
        <SectionHeader number={5} title="Authentication Example (Optional)" />

        <p class="text-text-secondary mb-4">
          With Supabase Auth, you can easily implement email/password login.
        </p>

        <CodeBlock
          client:load
          code={`// src/hooks/useAuth.ts
import { useState, useEffect } from 'react';
import { supabase } from '../lib/supabase';
import type { User } from '@supabase/supabase-js';

export function useAuth() {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Check current session
    supabase.auth.getSession().then(({ data: { session } }) => {
      setUser(session?.user ?? null);
      setLoading(false);
    });

    // Listen for auth state changes
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      (_event, session) => {
        setUser(session?.user ?? null);
      }
    );

    return () => subscription.unsubscribe();
  }, []);

  // Sign up
  const signUp = async (email: string, password: string) => {
    const { error } = await supabase.auth.signUp({ email, password });
    if (error) throw error;
  };

  // Sign in
  const signIn = async (email: string, password: string) => {
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) throw error;
  };

  // Sign out
  const signOut = async () => {
    const { error } = await supabase.auth.signOut();
    if (error) throw error;
  };

  return { user, loading, signUp, signIn, signOut };
}`}
          filename="src/hooks/useAuth.ts"
        />

        <Callout client:load locale="en" variant="info" title="Social login">
          <p class="text-sm">
            Social login with GitHub, Google, Discord, and more is also supported.
            Configure it in the Supabase dashboard under <strong class="text-white">Authentication</strong> → <strong class="text-white">Providers</strong>.
          </p>
        </Callout>
      </section>

      <!-- When to Use -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">When should you use Supabase?</h2>

        <div class="grid md:grid-cols-2 gap-4 mb-6">
          <div class="p-4 bg-green-500/10 border border-green-500/30 rounded-xl">
            <h3 class="text-white font-bold mb-2">✅ Recommended</h3>
            <ul class="text-text-secondary text-sm space-y-1">
              <li>Building an MVP quickly</li>
              <li>Focusing on frontend only without backend development</li>
              <li>When realtime features are needed</li>
              <li>When you want auth + DB in one solution</li>
            </ul>
          </div>
          <div class="p-4 bg-red-500/10 border border-red-500/30 rounded-xl">
            <h3 class="text-white font-bold mb-2">⚠️ Consider carefully</h3>
            <ul class="text-text-secondary text-sm space-y-1">
              <li>Complex business logic requirements</li>
              <li>Heavy external API integrations</li>
              <li>Custom backend logic is essential</li>
              <li>Data structure changes frequently</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- Next Steps -->
      <section class="mb-10">
        <Callout client:load locale="en" variant="info" title="Next steps">
          <ul class="list-disc list-inside space-y-1 mt-2">
            <li><a href="/en/map/auth" class="text-primary hover:underline">Auth Guide</a> - Compare JWT, Session, OAuth</li>
            <li><a href="https://supabase.com/docs" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">Supabase Official Docs</a> - More detailed features</li>
            <li><a href="/en/map/runtime" class="text-primary hover:underline">Cycle 5: Runtime</a> - Environment configuration management</li>
          </ul>
        </Callout>
      </section>
    </article>

    <PageNavigation currentPath="/baas/supabase" />
  </div>
</DocsLayout>
