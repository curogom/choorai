---
import DocsLayout from '../../../layouts/DocsLayout.astro';
import Callout from '../../../components/Callout';
import CodeBlock from '../../../components/CodeBlock';
import SectionHeader from '../../../components/SectionHeader';
import MetaBadge from '../../../components/MetaBadge';
import PageNavigation from '../../../components/PageNavigation.astro';

const firestoreRules = `rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /todos/{todoId} {
      allow read, write: if request.auth != null
        && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.userId;
    }
  }
}`;

const firebaseConfig = `// src/lib/firebase.ts
import { initializeApp } from 'firebase/app';
import { getFirestore } from 'firebase/firestore';
import { getAuth } from 'firebase/auth';

const firebaseConfig = {
  apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
  authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.VITE_FIREBASE_APP_ID,
};

const app = initializeApp(firebaseConfig);
export const db = getFirestore(app);
export const auth = getAuth(app);`;

const envVars = `# .env.local
VITE_FIREBASE_API_KEY=your-api-key
VITE_FIREBASE_AUTH_DOMAIN=your-project.firebaseapp.com
VITE_FIREBASE_PROJECT_ID=your-project-id
VITE_FIREBASE_STORAGE_BUCKET=your-project.appspot.com
VITE_FIREBASE_MESSAGING_SENDER_ID=your-sender-id
VITE_FIREBASE_APP_ID=your-app-id`;

const useTodosCode = `// src/hooks/useTodos.ts
import { useState, useEffect } from 'react';
import {
  collection,
  addDoc,
  getDocs,
  updateDoc,
  deleteDoc,
  doc,
  query,
  where,
  orderBy,
  onSnapshot,
  serverTimestamp,
} from 'firebase/firestore';
import { db, auth } from '../lib/firebase';

interface Todo {
  id: string;
  title: string;
  completed: boolean;
  userId: string;
  createdAt: any;
}

export function useTodos() {
  const [todos, setTodos] = useState<Todo[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const user = auth.currentUser;
    if (!user) return;

    const q = query(
      collection(db, 'todos'),
      where('userId', '==', user.uid),
      orderBy('createdAt', 'desc')
    );

    // Realtime subscription
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const items = snapshot.docs.map((doc) => ({
        id: doc.id,
        ...doc.data(),
      })) as Todo[];
      setTodos(items);
      setLoading(false);
    });

    return () => unsubscribe();
  }, []);

  // Create
  const addTodo = async (title: string) => {
    const user = auth.currentUser;
    if (!user) throw new Error('Not authenticated');

    await addDoc(collection(db, 'todos'), {
      title,
      completed: false,
      userId: user.uid,
      createdAt: serverTimestamp(),
    });
  };

  // Update
  const toggleTodo = async (id: string, completed: boolean) => {
    await updateDoc(doc(db, 'todos', id), { completed });
  };

  // Delete
  const removeTodo = async (id: string) => {
    await deleteDoc(doc(db, 'todos', id));
  };

  return { todos, loading, addTodo, toggleTodo, removeTodo };
}`;

const useAuthCode = `// src/hooks/useAuth.ts
import { useState, useEffect } from 'react';
import {
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut as firebaseSignOut,
  onAuthStateChanged,
  User,
} from 'firebase/auth';
import { auth } from '../lib/firebase';

export function useAuth() {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (user) => {
      setUser(user);
      setLoading(false);
    });

    return () => unsubscribe();
  }, []);

  // Sign up
  const signUp = async (email: string, password: string) => {
    const { user } = await createUserWithEmailAndPassword(
      auth, email, password
    );
    return user;
  };

  // Sign in
  const signIn = async (email: string, password: string) => {
    const { user } = await signInWithEmailAndPassword(
      auth, email, password
    );
    return user;
  };

  // Sign out
  const signOut = async () => {
    await firebaseSignOut(auth);
  };

  return { user, loading, signUp, signIn, signOut };
}`;
---

<DocsLayout
  lang="en"
  title="Getting Started with Firebase (Lv.2)"
  description="How to implement databases and authentication without a backend using Firebase"
  currentPath="/baas/firebase"
>
  <div class="max-w-4xl mx-auto px-6 py-8">
    <nav class="flex items-center gap-2 text-sm text-text-secondary mb-6" aria-label="Breadcrumb">
      <a href="/en" class="hover:text-white transition-colors">Home</a>
      <span>/</span>
      <span class="text-primary font-medium">BaaS</span>
      <span>/</span>
      <span class="text-primary font-medium">Firebase</span>
    </nav>

    <header class="mb-8 pb-6 border-b border-border">
      <div class="flex items-center gap-2 mb-4">
        <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-500/10 text-blue-400 text-xs font-bold">
          Lv.2
        </span>
        <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-orange-500/10 text-orange-400 text-xs font-bold">
          BaaS
        </span>
      </div>
      <h1 class="text-3xl md:text-4xl font-black text-white mb-4">
        Getting Started with Firebase
      </h1>
      <p class="text-text-secondary text-lg leading-relaxed">
        With <strong class="text-white">Backend-as-a-Service</strong>, you can use
        a NoSQL database and authentication without a separate backend server.
      </p>
    </header>

    <section class="mb-10">
      <Callout client:load locale="en" variant="tip" title="What is Firebase?">
        <ul class="list-disc list-inside space-y-1 mt-2">
          <li><strong class="text-white">Firestore</strong> - NoSQL realtime database</li>
          <li><strong class="text-white">Auth</strong> - Built-in email/social login</li>
          <li><strong class="text-white">Cloud Storage</strong> - File storage and management</li>
          <li><strong class="text-white">Hosting</strong> - Static site deployment</li>
          <li><strong class="text-white">Cloud Functions</strong> - Serverless function execution</li>
          <li><strong class="text-white">Free tier</strong> - Spark plan with unlimited projects</li>
        </ul>
      </Callout>
    </section>

    <article class="prose prose-invert max-w-none">
      <!-- Step 1: Create Project -->
      <section class="mb-10">
        <SectionHeader number={1} title="Create a Firebase Project" />

        <ol class="list-decimal list-inside text-text-secondary space-y-3 mb-4">
          <li>
            Log in with your Google account at
            <a href="https://console.firebase.google.com" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">
              console.firebase.google.com
            </a>
          </li>
          <li>Click <strong class="text-white">Add project</strong></li>
          <li>Enter a project name</li>
          <li>Configure Google Analytics (optional)</li>
          <li>Click <strong class="text-white">Create project</strong></li>
          <li>After creation, click <strong class="text-white">Add web app</strong> (&#60;/&#62; icon) to get SDK configuration</li>
        </ol>

        <Callout client:load locale="en" variant="info">
          <p>After project creation, go to <strong class="text-white">Project Settings</strong> in the dashboard to find your API keys and configuration.</p>
        </Callout>
      </section>

      <!-- Step 2: Firestore Database Setup -->
      <section class="mb-10">
        <SectionHeader number={2} title="Firestore Database Setup" />

        <p class="text-text-secondary mb-4">
          Select <strong class="text-white">Firestore Database</strong> in the dashboard and create a database.
        </p>

        <ol class="list-decimal list-inside text-text-secondary space-y-3 mb-4">
          <li>Click <strong class="text-white">Create database</strong></li>
          <li>Choose production mode or test mode</li>
          <li>Select a region: <code class="bg-surface px-1 rounded">asia-northeast3 (Seoul)</code> recommended</li>
        </ol>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Security Rules Setup</h3>

        <p class="text-text-secondary mb-4">
          Go to <strong class="text-white">Firestore</strong> → <strong class="text-white">Rules</strong> tab and apply the security rules below.
        </p>

        <CodeBlock
          client:load
          code={firestoreRules}
          filename="Firestore Rules"
        />

        <Callout client:load locale="en" variant="warning" title="Why security rules matter">
          <p class="text-sm mt-2">
            Without security rules, <strong class="text-white">all users can access all data</strong>.
            Use <code class="bg-surface px-1 rounded">request.auth.uid</code> to restrict access so only logged-in users can access their own data.
          </p>
        </Callout>
      </section>

      <!-- Step 3: Client Setup -->
      <section class="mb-10">
        <SectionHeader number={3} title="Client Setup (React)" />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Install Dependencies</h3>

        <CodeBlock
          client:load
          code={`npm install firebase`}
          filename="Terminal"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Environment Variables</h3>

        <CodeBlock
          client:load
          code={envVars}
          filename=".env.local"
        />

        <p class="text-text-secondary text-sm mt-2 mb-4">
          Find these in Firebase Console → <strong class="text-white">Project Settings</strong> → <strong class="text-white">General</strong> → <strong class="text-white">Your apps</strong>.
        </p>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Firebase Client</h3>

        <CodeBlock
          client:load
          code={firebaseConfig}
          filename="src/lib/firebase.ts"
        />
      </section>

      <!-- Step 4: CRUD Example -->
      <section class="mb-10">
        <SectionHeader number={4} title="CRUD Example (React + Firestore)" />

        <p class="text-text-secondary mb-4">
          A Todo app example using Firestore's realtime subscription (<code class="bg-surface px-1 rounded">onSnapshot</code>).
        </p>

        <CodeBlock
          client:load
          code={useTodosCode}
          filename="src/hooks/useTodos.ts"
        />
      </section>

      <!-- Step 5: Authentication Example -->
      <section class="mb-10">
        <SectionHeader number={5} title="Authentication Example (Optional)" />

        <p class="text-text-secondary mb-4">
          With Firebase Auth, you can easily implement email/password login.
        </p>

        <CodeBlock
          client:load
          code={useAuthCode}
          filename="src/hooks/useAuth.ts"
        />

        <Callout client:load locale="en" variant="info" title="Social login">
          <p class="text-sm">
            Social login with Google, GitHub, Facebook, and more is also supported.
            Configure it in Firebase Console → <strong class="text-white">Authentication</strong> → <strong class="text-white">Sign-in method</strong>.
          </p>
        </Callout>
      </section>

      <!-- When to Use -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">When should you use Firebase?</h2>

        <div class="grid md:grid-cols-2 gap-4 mb-6">
          <div class="p-4 bg-green-500/10 border border-green-500/30 rounded-xl">
            <h3 class="text-white font-bold mb-2">Recommended</h3>
            <ul class="text-text-secondary text-sm space-y-1">
              <li>- Building a prototype quickly</li>
              <li>- When realtime data sync is needed</li>
              <li>- Supporting mobile and web simultaneously</li>
              <li>- When Google ecosystem integration is needed</li>
            </ul>
          </div>
          <div class="p-4 bg-red-500/10 border border-red-500/30 rounded-xl">
            <h3 class="text-white font-bold mb-2">Consider carefully</h3>
            <ul class="text-text-secondary text-sm space-y-1">
              <li>- Complex relational queries are needed</li>
              <li>- SQL-based data analysis is important</li>
              <li>- Vendor lock-in is a concern</li>
              <li>- Frequent bulk data exports are needed</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- Next Steps -->
      <section class="mb-10">
        <Callout client:load locale="en" variant="info" title="Next steps">
          <ul class="list-disc list-inside space-y-1 mt-2">
            <li><a href="/en/map/auth" class="text-primary hover:underline">Auth Guide</a> - Compare JWT, Session, OAuth</li>
            <li><a href="https://firebase.google.com/docs" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">Firebase Official Docs</a> - More detailed features</li>
            <li><a href="/en/baas/supabase" class="text-primary hover:underline">Supabase Guide</a> - Compare with a SQL-based alternative</li>
          </ul>
        </Callout>
      </section>
    </article>

    <PageNavigation currentPath="/baas/firebase" />
  </div>
</DocsLayout>
