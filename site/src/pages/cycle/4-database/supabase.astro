---
import DocsLayout from '../../../layouts/DocsLayout.astro';
import Callout from '../../../components/Callout';
import CodeBlock from '../../../components/CodeBlock';
---

<DocsLayout
  title="Supabase 시작하기 (Lv.3)"
  description="Supabase로 백엔드 없이 데이터베이스와 인증을 구현하는 방법"
  currentPath="/cycle/4-database/supabase"
>
  <div class="max-w-4xl mx-auto px-6 py-8">
    <nav class="flex items-center gap-2 text-sm text-text-secondary mb-6">
      <a href="/" class="hover:text-white transition-colors">홈</a>
      <span>/</span>
      <a href="/cycle/0-overview" class="hover:text-white transition-colors">학습 사이클</a>
      <span>/</span>
      <a href="/cycle/4-database" class="hover:text-white transition-colors">Cycle 4: 데이터베이스</a>
      <span>/</span>
      <span class="text-primary font-medium">Supabase</span>
    </nav>

    <header class="mb-8 pb-6 border-b border-border">
      <div class="flex items-center gap-2 mb-4">
        <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-green-500/10 text-green-400 text-xs font-bold">
          Lv.3
        </span>
        <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-emerald-500/10 text-emerald-400 text-xs font-bold">
          BaaS
        </span>
      </div>
      <h1 class="text-3xl md:text-4xl font-black text-white mb-4">
        Supabase 시작하기
      </h1>
      <p class="text-text-secondary text-lg leading-relaxed">
        <strong class="text-white">Backend-as-a-Service</strong>로 별도 백엔드 서버 없이
        PostgreSQL 데이터베이스와 인증을 사용할 수 있습니다.
      </p>
    </header>

    <section class="mb-10">
      <Callout client:load variant="tip" title="Supabase란?">
        <ul class="list-disc list-inside space-y-1 mt-2">
          <li><strong class="text-white">PostgreSQL</strong> 기반 관리형 데이터베이스</li>
          <li><strong class="text-white">Auth</strong> - 이메일/소셜 로그인 내장</li>
          <li><strong class="text-white">Row Level Security</strong> - 데이터 접근 권한 제어</li>
          <li><strong class="text-white">실시간 구독</strong> - 데이터 변경 시 자동 알림</li>
          <li><strong class="text-white">무료 티어</strong> - 50,000 MAU, 500MB 스토리지</li>
        </ul>
      </Callout>
    </section>

    <article class="prose prose-invert max-w-none">
      <!-- Step 1: 프로젝트 생성 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
          <span class="flex items-center justify-center w-8 h-8 rounded-full bg-primary text-background text-sm font-bold">1</span>
          Supabase 프로젝트 생성
        </h2>

        <ol class="list-decimal list-inside text-text-secondary space-y-3 mb-4">
          <li>
            <a href="https://supabase.com" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">
              supabase.com
            </a>에서 가입 (GitHub 로그인 추천)
          </li>
          <li><strong class="text-white">New project</strong> 클릭</li>
          <li>프로젝트 이름 입력</li>
          <li>데이터베이스 비밀번호 설정 (안전한 곳에 저장!)</li>
          <li>리전 선택: <code class="bg-surface px-1 rounded">Northeast Asia (Seoul)</code> 추천</li>
          <li><strong class="text-white">Create new project</strong> 클릭</li>
        </ol>

        <Callout client:load variant="info">
          <p>프로젝트 생성에 1-2분 정도 소요됩니다. 생성 완료 후 대시보드에서 API 키를 확인할 수 있습니다.</p>
        </Callout>
      </section>

      <!-- Step 2: 테이블 생성 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
          <span class="flex items-center justify-center w-8 h-8 rounded-full bg-primary text-background text-sm font-bold">2</span>
          테이블 생성 (SQL Editor)
        </h2>

        <p class="text-text-secondary mb-4">
          대시보드에서 <strong class="text-white">SQL Editor</strong>를 열고 아래 스키마를 실행하세요.
        </p>

        <CodeBlock
          client:load
          code={`-- todos 테이블 생성
create table todos (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references auth.users(id) on delete cascade,
  title text not null,
  completed boolean default false,
  created_at timestamptz default now()
);

-- RLS (Row Level Security) 활성화
alter table todos enable row level security;

-- 정책: 자신의 데이터만 조회 가능
create policy "Users can view own todos"
  on todos for select
  using (auth.uid() = user_id);

-- 정책: 자신의 데이터만 추가 가능
create policy "Users can insert own todos"
  on todos for insert
  with check (auth.uid() = user_id);

-- 정책: 자신의 데이터만 수정 가능
create policy "Users can update own todos"
  on todos for update
  using (auth.uid() = user_id);

-- 정책: 자신의 데이터만 삭제 가능
create policy "Users can delete own todos"
  on todos for delete
  using (auth.uid() = user_id);`}
          filename="SQL Editor"
        />

        <Callout client:load variant="warning" title="RLS가 중요한 이유">
          <p class="text-sm mt-2">
            RLS 없이는 <strong class="text-white">모든 사용자가 모든 데이터에 접근</strong>할 수 있습니다.
            <code class="bg-surface px-1 rounded">auth.uid()</code>는 현재 로그인한 사용자의 ID를 반환합니다.
          </p>
        </Callout>
      </section>

      <!-- Step 3: 클라이언트 설정 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
          <span class="flex items-center justify-center w-8 h-8 rounded-full bg-primary text-background text-sm font-bold">3</span>
          클라이언트 설정 (React)
        </h2>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">의존성 설치</h3>

        <CodeBlock
          client:load
          code={`npm install @supabase/supabase-js @tanstack/react-query`}
          filename="터미널"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">환경 변수 설정</h3>

        <CodeBlock
          client:load
          code={`# .env.local
VITE_SUPABASE_URL=https://your-project-id.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key`}
          filename=".env.local"
        />

        <p class="text-text-secondary text-sm mt-2 mb-4">
          Supabase 대시보드 → <strong class="text-white">Settings</strong> → <strong class="text-white">API</strong>에서 확인하세요.
        </p>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Supabase 클라이언트</h3>

        <CodeBlock
          client:load
          code={`// src/lib/supabase.ts
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

export const supabase = createClient(supabaseUrl, supabaseAnonKey);`}
          filename="src/lib/supabase.ts"
        />
      </section>

      <!-- Step 4: CRUD 예제 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
          <span class="flex items-center justify-center w-8 h-8 rounded-full bg-primary text-background text-sm font-bold">4</span>
          CRUD 예제 (React Query + Supabase)
        </h2>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">타입 정의</h3>

        <CodeBlock
          client:load
          code={`// src/types/todo.ts
export interface Todo {
  id: string;
  user_id: string;
  title: string;
  completed: boolean;
  created_at: string;
}

export type CreateTodoInput = Pick<Todo, 'title'>;
export type UpdateTodoInput = Partial<Pick<Todo, 'title' | 'completed'>>;`}
          filename="src/types/todo.ts"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Hooks (TanStack Query)</h3>

        <CodeBlock
          client:load
          code={`// src/hooks/useTodos.ts
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { supabase } from '../lib/supabase';
import type { Todo, CreateTodoInput, UpdateTodoInput } from '../types/todo';

// 목록 조회
export function useTodos() {
  return useQuery({
    queryKey: ['todos'],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('todos')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) throw error;
      return data as Todo[];
    },
  });
}

// 생성
export function useCreateTodo() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async (input: CreateTodoInput) => {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error('Not authenticated');

      const { data, error } = await supabase
        .from('todos')
        .insert({ ...input, user_id: user.id })
        .select()
        .single();

      if (error) throw error;
      return data as Todo;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['todos'] });
    },
  });
}

// 수정
export function useUpdateTodo() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({ id, ...input }: UpdateTodoInput & { id: string }) => {
      const { data, error } = await supabase
        .from('todos')
        .update(input)
        .eq('id', id)
        .select()
        .single();

      if (error) throw error;
      return data as Todo;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['todos'] });
    },
  });
}

// 삭제
export function useDeleteTodo() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async (id: string) => {
      const { error } = await supabase
        .from('todos')
        .delete()
        .eq('id', id);

      if (error) throw error;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['todos'] });
    },
  });
}`}
          filename="src/hooks/useTodos.ts"
        />
      </section>

      <!-- Step 5: 인증 예제 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
          <span class="flex items-center justify-center w-8 h-8 rounded-full bg-primary text-background text-sm font-bold">5</span>
          인증 예제 (선택)
        </h2>

        <p class="text-text-secondary mb-4">
          Supabase Auth를 사용하면 이메일/비밀번호 로그인을 쉽게 구현할 수 있습니다.
        </p>

        <CodeBlock
          client:load
          code={`// src/hooks/useAuth.ts
import { useState, useEffect } from 'react';
import { supabase } from '../lib/supabase';
import type { User } from '@supabase/supabase-js';

export function useAuth() {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // 현재 세션 확인
    supabase.auth.getSession().then(({ data: { session } }) => {
      setUser(session?.user ?? null);
      setLoading(false);
    });

    // 인증 상태 변경 감지
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      (_event, session) => {
        setUser(session?.user ?? null);
      }
    );

    return () => subscription.unsubscribe();
  }, []);

  // 회원가입
  const signUp = async (email: string, password: string) => {
    const { error } = await supabase.auth.signUp({ email, password });
    if (error) throw error;
  };

  // 로그인
  const signIn = async (email: string, password: string) => {
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) throw error;
  };

  // 로그아웃
  const signOut = async () => {
    const { error } = await supabase.auth.signOut();
    if (error) throw error;
  };

  return { user, loading, signUp, signIn, signOut };
}`}
          filename="src/hooks/useAuth.ts"
        />

        <Callout client:load variant="info" title="소셜 로그인">
          <p class="text-sm">
            GitHub, Google, Discord 등 소셜 로그인도 지원합니다.
            Supabase 대시보드 → <strong class="text-white">Authentication</strong> → <strong class="text-white">Providers</strong>에서 설정하세요.
          </p>
        </Callout>
      </section>

      <!-- 언제 사용하면 좋을까 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">언제 Supabase를 사용하면 좋을까요?</h2>

        <div class="grid md:grid-cols-2 gap-4 mb-6">
          <div class="p-4 bg-green-500/10 border border-green-500/30 rounded-xl">
            <h3 class="text-white font-bold mb-2">✅ 추천하는 경우</h3>
            <ul class="text-text-secondary text-sm space-y-1">
              <li>빠르게 MVP 만들 때</li>
              <li>백엔드 개발 없이 프론트만 집중하고 싶을 때</li>
              <li>실시간 기능이 필요할 때</li>
              <li>인증 + DB를 한 번에 해결하고 싶을 때</li>
            </ul>
          </div>
          <div class="p-4 bg-red-500/10 border border-red-500/30 rounded-xl">
            <h3 class="text-white font-bold mb-2">⚠️ 고려가 필요한 경우</h3>
            <ul class="text-text-secondary text-sm space-y-1">
              <li>복잡한 비즈니스 로직이 있을 때</li>
              <li>외부 API 연동이 많을 때</li>
              <li>커스텀 백엔드 로직이 필수일 때</li>
              <li>데이터 구조가 자주 바뀔 때</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- 다음 단계 -->
      <section class="mb-10">
        <Callout client:load variant="info" title="다음 단계">
          <ul class="list-disc list-inside space-y-1 mt-2">
            <li><a href="/cycle/auth" class="text-primary hover:underline">인증 가이드</a> - JWT, Session, OAuth 비교</li>
            <li><a href="https://supabase.com/docs" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">Supabase 공식 문서</a> - 더 자세한 기능</li>
            <li><a href="/cycle/5-runtime" class="text-primary hover:underline">Cycle 5: Runtime</a> - 환경 설정 관리</li>
          </ul>
        </Callout>
      </section>
    </article>

    <nav class="flex items-center justify-between pt-8 border-t border-border">
      <a
        href="/cycle/4-database"
        class="group flex items-center gap-3 px-4 py-2 rounded-lg border border-border hover:bg-surface transition-colors no-underline"
      >
        <svg class="w-5 h-5 text-text-secondary group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        <div class="text-left">
          <span class="text-xs text-text-secondary">이전</span>
          <span class="block text-sm text-white font-medium">Cycle 4: 데이터베이스</span>
        </div>
      </a>

      <a
        href="/cycle/auth"
        class="group flex items-center gap-3 px-4 py-2 rounded-lg bg-primary hover:bg-primary-hover text-background transition-colors no-underline"
      >
        <div class="text-right">
          <span class="text-xs opacity-70">다음</span>
          <span class="block text-sm font-bold">인증 가이드</span>
        </div>
        <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </a>
    </nav>
  </div>
</DocsLayout>
