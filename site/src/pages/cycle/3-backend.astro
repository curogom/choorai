---
import DocsLayout from '../../layouts/DocsLayout.astro';
import Callout from '../../components/Callout';
import CodeBlock from '../../components/CodeBlock';
---

<DocsLayout
  title="Cycle 3: Backend 배포"
  description="FastAPI 앱을 Docker로 패키징하고 Cloud Run에 배포하는 방법"
  currentPath="/cycle/3-backend"
>
  <div class="max-w-4xl mx-auto px-6 py-8">
    <nav class="flex items-center gap-2 text-sm text-text-secondary mb-6">
      <a href="/" class="hover:text-white transition-colors">홈</a>
      <span>/</span>
      <a href="/cycle/0-overview" class="hover:text-white transition-colors">학습 사이클</a>
      <span>/</span>
      <span class="text-primary font-medium">Cycle 3: Backend</span>
    </nav>

    <header class="mb-8 pb-6 border-b border-border">
      <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-primary/10 text-primary text-xs font-bold mb-4">
        Cycle 3
      </div>
      <h1 class="text-3xl md:text-4xl font-black text-white mb-4">
        Backend 배포
      </h1>
      <p class="text-text-secondary text-lg leading-relaxed">
        FastAPI 앱을 Docker 컨테이너로 패키징하고 Google Cloud Run에 배포합니다.
      </p>
    </header>

    <section class="mb-10">
      <Callout client:load variant="tip" title="이 Cycle에서 배우는 것">
        <ul class="list-disc list-inside space-y-1 mt-2">
          <li>백엔드 배포가 프론트엔드와 다른 이유</li>
          <li>Docker 기초 (Dockerfile 작성)</li>
          <li>Cloud Run 배포</li>
          <li>헬스체크와 로깅</li>
        </ul>
      </Callout>
    </section>

    <!-- 프레임워크 레벨 -->
    <section class="mb-10">
      <h2 class="text-2xl font-bold text-white mb-4">🎯 프레임워크 성숙도 레벨</h2>
      <p class="text-text-secondary mb-6">
        백엔드 프레임워크는 복잡도에 따라 레벨이 나뉩니다.
        본인의 수준과 프로젝트 규모에 맞는 프레임워크를 선택하세요.
      </p>

      <div class="grid md:grid-cols-3 gap-4 mb-6">
        <a href="/cycle/3-backend/hono" class="block p-4 bg-green-500/10 border border-green-500/30 rounded-xl hover:bg-green-500/20 transition-colors no-underline">
          <div class="flex items-center gap-2 mb-2">
            <span class="px-2 py-0.5 bg-green-500/20 text-green-400 text-xs font-bold rounded">Lv.1</span>
            <span class="text-white font-bold">Hono</span>
          </div>
          <p class="text-text-secondary text-sm mb-2">입문 · 미니멀</p>
          <ul class="text-text-secondary text-xs space-y-1">
            <li>• 파일 1개로 시작</li>
            <li>• Express 스타일</li>
            <li>• 15분 완성</li>
          </ul>
        </a>

        <div class="p-4 bg-blue-500/10 border-2 border-blue-500/50 rounded-xl relative">
          <div class="absolute -top-2 right-2 px-2 py-0.5 bg-blue-500 text-white text-xs font-bold rounded">현재 페이지</div>
          <div class="flex items-center gap-2 mb-2">
            <span class="px-2 py-0.5 bg-blue-500/20 text-blue-400 text-xs font-bold rounded">Lv.2</span>
            <span class="text-white font-bold">FastAPI</span>
          </div>
          <p class="text-text-secondary text-sm mb-2">기초 · 타입 지원</p>
          <ul class="text-text-secondary text-xs space-y-1">
            <li>• 자동 문서화</li>
            <li>• Pydantic 검증</li>
            <li>• Python 생태계</li>
          </ul>
        </div>

        <a href="/cycle/3-backend/nest" class="block p-4 bg-purple-500/10 border border-purple-500/30 rounded-xl hover:bg-purple-500/20 transition-colors no-underline">
          <div class="flex items-center gap-2 mb-2">
            <span class="px-2 py-0.5 bg-purple-500/20 text-purple-400 text-xs font-bold rounded">Lv.4</span>
            <span class="text-white font-bold">NestJS</span>
          </div>
          <p class="text-text-secondary text-sm mb-2">실무 · 엔터프라이즈</p>
          <ul class="text-text-secondary text-xs space-y-1">
            <li>• 모듈/DI 구조</li>
            <li>• 데코레이터 패턴</li>
            <li>• 대규모 팀용</li>
          </ul>
        </a>
      </div>

      <Callout client:load variant="info" title="어떤 프레임워크를 선택할까?">
        <div class="mt-2 space-y-2 text-sm">
          <p><strong class="text-green-400">Hono (Lv.1)</strong>: JavaScript만 알면 됨, 가장 빠르게 시작</p>
          <p><strong class="text-blue-400">FastAPI (Lv.2)</strong>: Python 선호, 자동 문서화 필요</p>
          <p><strong class="text-purple-400">NestJS (Lv.4)</strong>: 실무 경험 쌓기, 대규모 프로젝트</p>
        </div>
      </Callout>
    </section>

    <article class="prose prose-invert max-w-none">
      <!-- 백엔드 배포가 다른 이유 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">백엔드 배포가 다른 이유</h2>

        <div class="grid md:grid-cols-2 gap-4 mb-6">
          <div class="p-4 bg-blue-500/10 border border-blue-500/30 rounded-xl">
            <h3 class="text-white font-bold mb-2">Frontend</h3>
            <ul class="text-text-secondary text-sm space-y-1">
              <li>정적 파일 (HTML/CSS/JS)</li>
              <li>CDN에 업로드만 하면 됨</li>
              <li>서버 프로세스 불필요</li>
            </ul>
          </div>
          <div class="p-4 bg-purple-500/10 border border-purple-500/30 rounded-xl">
            <h3 class="text-white font-bold mb-2">Backend</h3>
            <ul class="text-text-secondary text-sm space-y-1">
              <li>서버 프로세스 실행 필요</li>
              <li>요청마다 코드 실행</li>
              <li>상태 관리, DB 연결</li>
            </ul>
          </div>
        </div>

        <p class="text-text-secondary">
          백엔드는 <strong class="text-white">컨테이너</strong>로 패키징하면
          어떤 서버에서든 동일하게 실행할 수 있습니다.
        </p>
      </section>

      <!-- Docker 기초 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">Docker 기초</h2>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Dockerfile 작성</h3>

        <CodeBlock
          client:load
          code={`# Python 이미지 사용
FROM python:3.11-slim

# 작업 디렉토리 설정
WORKDIR /app

# 의존성 먼저 설치 (캐시 활용)
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 소스 코드 복사
COPY . .

# 포트 노출
EXPOSE 8080

# 앱 실행
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8080"]`}
          filename="Dockerfile"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">로컬에서 테스트</h3>

        <CodeBlock
          client:load
          code={`# 이미지 빌드
docker build -t my-api .

# 컨테이너 실행
docker run -p 8080:8080 my-api

# http://localhost:8080 에서 확인`}
          filename="터미널"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">멀티스테이지 빌드 (선택)</h3>

        <p class="text-text-secondary mb-4">
          이미지 크기를 줄이려면 멀티스테이지 빌드를 사용합니다.
        </p>

        <CodeBlock
          client:load
          code={`# 빌드 스테이지
FROM python:3.11-slim as builder
WORKDIR /app
COPY requirements.txt .
RUN pip install --user --no-cache-dir -r requirements.txt

# 실행 스테이지
FROM python:3.11-slim
WORKDIR /app
COPY --from=builder /root/.local /root/.local
COPY . .
ENV PATH=/root/.local/bin:$PATH
EXPOSE 8080
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8080"]`}
          filename="Dockerfile (멀티스테이지)"
        />
      </section>

      <!-- Cloud Run 배포 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">Cloud Run 배포</h2>

        <div class="space-y-6">
          <div class="p-4 bg-surface border border-border rounded-xl">
            <h3 class="text-white font-bold mb-3 flex items-center gap-2">
              <span class="flex items-center justify-center w-6 h-6 rounded-full bg-primary text-background text-sm font-bold">1</span>
              gcloud CLI 설치
            </h3>
            <CodeBlock
              client:load
              code={`# macOS
brew install google-cloud-sdk

# 로그인
gcloud auth login

# 프로젝트 설정
gcloud config set project YOUR_PROJECT_ID`}
              filename="터미널"
            />
          </div>

          <div class="p-4 bg-surface border border-border rounded-xl">
            <h3 class="text-white font-bold mb-3 flex items-center gap-2">
              <span class="flex items-center justify-center w-6 h-6 rounded-full bg-primary text-background text-sm font-bold">2</span>
              이미지 빌드 및 푸시
            </h3>
            <CodeBlock
              client:load
              code={`# Cloud Build로 빌드 + Artifact Registry에 푸시
gcloud builds submit --tag gcr.io/YOUR_PROJECT_ID/my-api`}
              filename="터미널"
            />
          </div>

          <div class="p-4 bg-surface border border-border rounded-xl">
            <h3 class="text-white font-bold mb-3 flex items-center gap-2">
              <span class="flex items-center justify-center w-6 h-6 rounded-full bg-primary text-background text-sm font-bold">3</span>
              Cloud Run 배포
            </h3>
            <CodeBlock
              client:load
              code={`gcloud run deploy my-api \\
  --image gcr.io/YOUR_PROJECT_ID/my-api \\
  --platform managed \\
  --region asia-northeast3 \\
  --allow-unauthenticated`}
              filename="터미널"
            />
            <p class="text-text-secondary text-sm mt-2">
              <code class="bg-background px-1 rounded">--allow-unauthenticated</code>: 인증 없이 접근 가능 (공개 API용)
            </p>
          </div>

          <div class="p-4 bg-surface border border-border rounded-xl">
            <h3 class="text-white font-bold mb-3 flex items-center gap-2">
              <span class="flex items-center justify-center w-6 h-6 rounded-full bg-primary text-background text-sm font-bold">4</span>
              환경 변수 설정
            </h3>
            <CodeBlock
              client:load
              code={`gcloud run deploy my-api \\
  --image gcr.io/YOUR_PROJECT_ID/my-api \\
  --set-env-vars="DATABASE_URL=postgresql://...,API_KEY=secret"`}
              filename="터미널"
            />
            <Callout client:load variant="warning" title="시크릿 관리">
              <p class="mt-2 text-sm">
                민감한 정보는 환경 변수 대신 <a href="https://cloud.google.com/secret-manager" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">Secret Manager</a>를 사용하세요.
              </p>
            </Callout>
          </div>
        </div>
      </section>

      <!-- 운영 기초 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">운영 기초</h2>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">헬스체크 엔드포인트</h3>

        <p class="text-text-secondary mb-4">
          Cloud Run은 <code class="bg-surface px-1 rounded">/</code> 경로로 헬스체크를 수행합니다.
          별도의 헬스체크 엔드포인트를 만드는 것이 좋습니다.
        </p>

        <CodeBlock
          client:load
          code={`from fastapi import FastAPI

app = FastAPI()

@app.get("/health")
def health_check():
    return {"status": "healthy"}

@app.get("/")
def root():
    return {"message": "Hello, World!"}`}
          filename="main.py"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">로그 확인</h3>

        <CodeBlock
          client:load
          code={`# Cloud Run 로그 확인
gcloud run services logs read my-api --region asia-northeast3

# 실시간 로그 스트리밍
gcloud run services logs tail my-api --region asia-northeast3`}
          filename="터미널"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">CORS 설정</h3>

        <p class="text-text-secondary mb-4">
          프론트엔드와 백엔드 도메인이 다르면 CORS 설정이 필요합니다.
        </p>

        <CodeBlock
          client:load
          code={`from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["https://myapp.com", "http://localhost:3000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)`}
          filename="main.py"
        />
      </section>

      <!-- 다음 단계 -->
      <section class="mb-10">
        <Callout client:load variant="info" title="다음 단계">
          <p class="text-sm">
            백엔드 배포가 완료되었다면, 이제 데이터베이스를 연결해봅시다.
            <a href="/cycle/4-database" class="text-primary hover:underline ml-1">Cycle 4: 데이터베이스</a>에서
            PostgreSQL을 연결하는 방법을 배웁니다.
          </p>
        </Callout>
      </section>
    </article>

    <nav class="flex items-center justify-between pt-8 border-t border-border">
      <a
        href="/cycle/2-frontend"
        class="group flex items-center gap-3 px-4 py-2 rounded-lg border border-border hover:bg-surface transition-colors no-underline"
      >
        <svg class="w-5 h-5 text-text-secondary group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        <div class="text-left">
          <span class="text-xs text-text-secondary">이전</span>
          <span class="block text-sm text-white font-medium">Cycle 2: Frontend</span>
        </div>
      </a>

      <a
        href="/cycle/4-database"
        class="group flex items-center gap-3 px-4 py-2 rounded-lg bg-primary hover:bg-primary-hover text-background transition-colors no-underline"
      >
        <div class="text-right">
          <span class="text-xs opacity-70">다음</span>
          <span class="block text-sm font-bold">Cycle 4: 데이터베이스</span>
        </div>
        <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </a>
    </nav>
  </div>
</DocsLayout>
