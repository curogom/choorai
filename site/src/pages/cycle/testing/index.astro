---
import DocsLayout from '../../../layouts/DocsLayout.astro';
import Callout from '../../../components/Callout';
import CodeBlock from '../../../components/CodeBlock';
import testCountsData from '../../../data/test-counts.json';

// Use test counts from generated JSON file
const testCounts = testCountsData.breakdown;
const totalTests = testCountsData.total;
---

<DocsLayout
  title="테스팅 가이드"
  description="테스팅 피라미드와 실전 테스트 전략"
  currentPath="/cycle/testing"
>
  <div class="max-w-4xl mx-auto px-6 py-8">
    <nav class="flex items-center gap-2 text-sm text-text-secondary mb-6" aria-label="현재 위치">
      <a href="/" class="hover:text-white transition-colors">홈</a>
      <span>/</span>
      <a href="/cycle/0-overview" class="hover:text-white transition-colors">학습 사이클</a>
      <span>/</span>
      <span class="text-primary font-medium">테스팅</span>
    </nav>

    <header class="mb-8 pb-6 border-b border-border">
      <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-primary/10 text-primary text-xs font-bold mb-4">
        품질 보증
      </div>
      <h1 class="text-3xl md:text-4xl font-black text-white mb-4">
        테스팅 가이드
      </h1>
      <p class="text-text-secondary text-lg leading-relaxed">
        Choorai 프로젝트는 <strong class="text-white">{totalTests}개 이상의 테스트</strong>로 품질을 보장합니다.
        테스팅 피라미드를 이해하고 실전 테스트 전략을 배웁니다.
      </p>
    </header>

    <section class="mb-10">
      <Callout client:load variant="tip" title="이 가이드에서 배우는 것">
        <ul class="list-disc list-inside space-y-1 mt-2">
          <li>테스팅 피라미드 이해 (Unit → Integration → E2E)</li>
          <li>Python pytest로 백엔드 테스트</li>
          <li>Vitest로 프론트엔드/Node.js 테스트</li>
          <li>Playwright로 E2E 테스트</li>
        </ul>
      </Callout>
    </section>

    <article class="prose prose-invert max-w-none">
      <!-- 테스팅 피라미드 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">테스팅 피라미드</h2>

        <div class="relative mb-6">
          <div class="flex flex-col items-center gap-2">
            <!-- E2E -->
            <div class="w-32 h-16 bg-red-500/20 border border-red-500/50 rounded-t-xl flex items-center justify-center">
              <span class="text-red-400 font-bold text-sm">E2E</span>
            </div>
            <!-- Integration -->
            <div class="w-48 h-16 bg-yellow-500/20 border border-yellow-500/50 flex items-center justify-center">
              <span class="text-yellow-400 font-bold text-sm">Integration</span>
            </div>
            <!-- Unit -->
            <div class="w-64 h-16 bg-green-500/20 border border-green-500/50 rounded-b-xl flex items-center justify-center">
              <span class="text-green-400 font-bold text-sm">Unit</span>
            </div>
          </div>
        </div>

        <div class="grid md:grid-cols-3 gap-4 mb-6">
          <div class="p-4 bg-green-500/10 border border-green-500/30 rounded-xl">
            <h3 class="text-green-400 font-bold mb-2">Unit Tests</h3>
            <p class="text-text-secondary text-sm mb-2">개별 함수/컴포넌트 테스트</p>
            <ul class="text-text-secondary text-xs space-y-1">
              <li>✅ 빠른 실행 (ms)</li>
              <li>✅ 격리된 테스트</li>
              <li>✅ 가장 많이 작성</li>
            </ul>
          </div>
          <div class="p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-xl">
            <h3 class="text-yellow-400 font-bold mb-2">Integration Tests</h3>
            <p class="text-text-secondary text-sm mb-2">모듈 간 상호작용 테스트</p>
            <ul class="text-text-secondary text-xs space-y-1">
              <li>✅ API 엔드포인트</li>
              <li>✅ DB 연동</li>
              <li>⚠️ 설정 필요</li>
            </ul>
          </div>
          <div class="p-4 bg-red-500/10 border border-red-500/30 rounded-xl">
            <h3 class="text-red-400 font-bold mb-2">E2E Tests</h3>
            <p class="text-text-secondary text-sm mb-2">전체 사용자 시나리오</p>
            <ul class="text-text-secondary text-xs space-y-1">
              <li>✅ 실제 브라우저</li>
              <li>⚠️ 느린 실행 (s)</li>
              <li>⚠️ 최소한으로</li>
            </ul>
          </div>
        </div>

        <Callout client:load variant="info" title="권장 비율">
          <p class="text-sm mt-1">
            <strong class="text-green-400">Unit 70%</strong> ·
            <strong class="text-yellow-400">Integration 20%</strong> ·
            <strong class="text-red-400">E2E 10%</strong>
          </p>
        </Callout>
      </section>

      <!-- Choorai 테스트 현황 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">Choorai 프로젝트 테스트 현황</h2>

        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-border">
                <th class="text-left py-3 px-2 text-white">프로젝트</th>
                <th class="text-left py-3 px-2 text-white">API (Python)</th>
                <th class="text-left py-3 px-2 text-white">API (Hono)</th>
                <th class="text-left py-3 px-2 text-white">API (NestJS)</th>
                <th class="text-left py-3 px-2 text-white">Web (React)</th>
                <th class="text-left py-3 px-2 text-white">Web (Vue)</th>
              </tr>
            </thead>
            <tbody class="text-text-secondary">
              <tr class="border-b border-border/50">
                <td class="py-3 px-2 text-white font-medium">B2B Admin</td>
                <td class="py-3 px-2">{testCounts.b2bAdmin.api}</td>
                <td class="py-3 px-2">{testCounts.b2bAdmin.apiHono}</td>
                <td class="py-3 px-2">{testCounts.b2bAdmin.apiNest}</td>
                <td class="py-3 px-2">{testCounts.b2bAdmin.web}</td>
                <td class="py-3 px-2">{testCounts.b2bAdmin.webVue}</td>
              </tr>
              <tr>
                <td class="py-3 px-2 text-white font-medium">B2C Todo</td>
                <td class="py-3 px-2">{testCounts.b2cTodo.api}</td>
                <td class="py-3 px-2">{testCounts.b2cTodo.apiHono}</td>
                <td class="py-3 px-2">{testCounts.b2cTodo.apiNest}</td>
                <td class="py-3 px-2">{testCounts.b2cTodo.web || '-'}</td>
                <td class="py-3 px-2">{testCounts.b2cTodo.webVue}</td>
              </tr>
            </tbody>
            <tfoot>
              <tr class="border-t border-border">
                <td class="py-3 px-2 text-white font-bold">총계</td>
                <td colspan="5" class="py-3 px-2 text-primary font-bold">{totalTests}개</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </section>

      <!-- 테스트 도구 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">테스트 도구</h2>

        <div class="grid md:grid-cols-2 gap-4">
          <a href="/cycle/testing/unit" class="block p-4 bg-surface border border-border rounded-xl hover:border-primary/50 transition-colors no-underline">
            <div class="flex items-center gap-2 mb-2">
              <span class="px-2 py-0.5 bg-green-500/20 text-green-400 text-xs font-bold rounded">Unit</span>
              <span class="text-white font-bold">단위 테스트</span>
            </div>
            <p class="text-text-secondary text-sm mb-2">pytest, Vitest로 함수/컴포넌트 테스트</p>
            <ul class="text-text-secondary text-xs space-y-1">
              <li>• Python: pytest + pytest-asyncio</li>
              <li>• Node.js: Vitest</li>
              <li>• React/Vue: @testing-library</li>
            </ul>
          </a>

          <a href="/cycle/testing/e2e" class="block p-4 bg-surface border border-border rounded-xl hover:border-primary/50 transition-colors no-underline">
            <div class="flex items-center gap-2 mb-2">
              <span class="px-2 py-0.5 bg-red-500/20 text-red-400 text-xs font-bold rounded">E2E</span>
              <span class="text-white font-bold">E2E 테스트</span>
            </div>
            <p class="text-text-secondary text-sm mb-2">Playwright로 브라우저 자동화 테스트</p>
            <ul class="text-text-secondary text-xs space-y-1">
              <li>• 크로스 브라우저 테스트</li>
              <li>• 스크린샷 비교</li>
              <li>• CI/CD 통합</li>
            </ul>
          </a>
        </div>
      </section>

      <!-- 테스트 실행 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">테스트 실행하기</h2>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Python (pytest)</h3>
        <CodeBlock
          client:load
          code={`# B2B Admin API 테스트
cd examples/b2b-admin/api
pip install -r requirements.txt
pytest -v

# B2C Todo API 테스트
cd examples/b2c-todo/api
pytest -v`}
          filename="터미널"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Node.js (Vitest)</h3>
        <CodeBlock
          client:load
          code={`# Hono API 테스트
cd examples/b2b-admin/api-hono
npm install
npm run test:run

# Vue 프론트엔드 테스트
cd examples/b2b-admin/web-vue
npm install
npm run test:run`}
          filename="터미널"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">NestJS (Jest)</h3>
        <CodeBlock
          client:load
          code={`# NestJS E2E 테스트
cd examples/b2b-admin/api-nest
npm install
npm run test:e2e`}
          filename="터미널"
        />
      </section>

      <!-- CI/CD -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">CI/CD 통합</h2>

        <p class="text-text-secondary mb-4">
          Choorai는 GitHub Actions를 사용하여 모든 PR에서 자동으로 테스트를 실행합니다.
        </p>

        <CodeBlock
          client:load
          code={`# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Python 테스트
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run Python tests
        run: |
          cd examples/b2b-admin/api
          pip install -r requirements.txt
          pytest -v

      # Node.js 테스트
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Hono tests
        run: |
          cd examples/b2b-admin/api-hono
          npm ci
          npm run test:run`}
          filename=".github/workflows/ci.yml"
        />

        <Callout client:load variant="tip" title="모든 테스트 통과 후 머지">
          <p class="text-sm mt-1">
            PR이 머지되기 전에 모든 테스트가 통과해야 합니다.
            <a href="https://github.com/curogom/choorai/actions" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline ml-1">GitHub Actions</a>에서 실행 상태를 확인하세요.
          </p>
        </Callout>
      </section>

      <!-- 다음 단계 -->
      <section class="mb-10">
        <Callout client:load variant="info" title="다음 단계">
          <div class="mt-2 space-y-2 text-sm">
            <p>
              <a href="/cycle/testing/unit" class="text-primary hover:underline">단위 테스트 가이드</a>에서
              pytest와 Vitest 사용법을 자세히 배웁니다.
            </p>
            <p>
              <a href="/cycle/testing/e2e" class="text-primary hover:underline">E2E 테스트 가이드</a>에서
              Playwright로 브라우저 테스트를 작성합니다.
            </p>
          </div>
        </Callout>
      </section>
    </article>

    <nav class="flex items-center justify-between pt-8 border-t border-border" aria-label="페이지 이동">
      <a
        href="/cycle/6-ops"
        class="group flex items-center gap-3 px-4 py-2 rounded-lg border border-border hover:bg-surface transition-colors no-underline"
      >
        <svg class="w-5 h-5 text-text-secondary group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        <div class="text-left">
          <span class="text-xs text-text-secondary">이전</span>
          <span class="block text-sm text-white font-medium">Cycle 6: Ops</span>
        </div>
      </a>

      <a
        href="/cycle/testing/unit"
        class="group flex items-center gap-3 px-4 py-2 rounded-lg bg-primary hover:bg-primary-hover text-background transition-colors no-underline"
      >
        <div class="text-right">
          <span class="text-xs opacity-70">다음</span>
          <span class="block text-sm font-bold">단위 테스트</span>
        </div>
        <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </a>
    </nav>
  </div>
</DocsLayout>
