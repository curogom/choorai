---
import DocsLayout from '../../layouts/DocsLayout.astro';
import Callout from '../../components/Callout';
import CodeBlock from '../../components/CodeBlock';
---

<DocsLayout
  title="사용자 인증 구현"
  description="로그인/회원가입 기능을 구현하는 방법"
  currentPath="/cycle/auth"
>
  <div class="max-w-4xl mx-auto px-6 py-8">
    <nav class="flex items-center gap-2 text-sm text-text-secondary mb-6">
      <a href="/" class="hover:text-white transition-colors">홈</a>
      <span>/</span>
      <a href="/cycle/0-overview" class="hover:text-white transition-colors">학습 사이클</a>
      <span>/</span>
      <span class="text-primary font-medium">사용자 인증</span>
    </nav>

    <header class="mb-8 pb-6 border-b border-border">
      <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-yellow-500/10 text-yellow-400 text-xs font-bold mb-4">
        🔐 고급 주제
      </div>
      <h1 class="text-3xl md:text-4xl font-black text-white mb-4">
        사용자 인증 구현
      </h1>
      <p class="text-text-secondary text-lg leading-relaxed">
        로그인, 회원가입, 비밀번호 관리 등 사용자 인증 기능을 구현합니다.
        보안을 고려한 올바른 방법을 배워봅시다.
      </p>
    </header>

    <section class="mb-10">
      <Callout client:load variant="tip" title="이 가이드에서 배우는 것">
        <ul class="list-disc list-inside space-y-1 mt-2">
          <li>인증 방식 비교 (세션 vs JWT)</li>
          <li>비밀번호 해싱 (bcrypt)</li>
          <li>OAuth 소셜 로그인</li>
          <li>인증 서비스 활용 (Clerk, Auth0)</li>
        </ul>
      </Callout>
    </section>

    <article class="prose prose-invert max-w-none">
      <!-- 인증 방식 비교 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">인증 방식 비교</h2>

        <div class="grid md:grid-cols-2 gap-4 mb-6">
          <div class="p-4 bg-surface border border-border rounded-xl">
            <h3 class="text-white font-bold mb-2">🍪 세션 기반</h3>
            <p class="text-text-secondary text-sm mb-3">
              서버에 세션을 저장하고 쿠키로 세션 ID 전달
            </p>
            <ul class="text-text-secondary text-xs space-y-1">
              <li>✅ 간단한 구현</li>
              <li>✅ 즉시 무효화 가능</li>
              <li>⚠️ 서버 확장 시 세션 공유 필요</li>
            </ul>
          </div>
          <div class="p-4 bg-surface border border-border rounded-xl">
            <h3 class="text-white font-bold mb-2">🎫 JWT (토큰 기반)</h3>
            <p class="text-text-secondary text-sm mb-3">
              서명된 토큰을 클라이언트가 보관
            </p>
            <ul class="text-text-secondary text-xs space-y-1">
              <li>✅ 서버 상태 불필요</li>
              <li>✅ 마이크로서비스에 적합</li>
              <li>⚠️ 토큰 탈취 시 대응 어려움</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- 직접 구현 vs 서비스 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">직접 구현 vs 인증 서비스</h2>

        <Callout client:load variant="warning" title="권장: 인증 서비스 사용">
          <p class="text-sm mb-2">
            인증은 보안에 민감한 영역입니다. 처음에는 검증된 인증 서비스를 사용하는 것을 권장합니다.
          </p>
          <p class="text-sm">
            직접 구현은 보안 취약점을 만들기 쉽고, 유지보수 부담도 큽니다.
          </p>
        </Callout>
      </section>

      <!-- 추천 인증 서비스 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">추천 인증 서비스</h2>

        <div class="grid md:grid-cols-2 gap-4">
          <a href="https://clerk.com" target="_blank" class="p-4 bg-surface border border-primary/30 rounded-xl hover:border-primary/50 transition-colors no-underline">
            <div class="flex items-center gap-2 mb-2">
              <span class="px-2 py-0.5 rounded bg-primary/20 text-primary text-xs font-bold">추천</span>
              <h3 class="text-white font-bold">Clerk</h3>
            </div>
            <p class="text-text-secondary text-sm mb-2">
              React/Next.js에 최적화된 인증 서비스.
              소셜 로그인, MFA, 조직 관리 기능 포함.
            </p>
            <span class="text-primary text-xs">무료 티어: 월 10,000 MAU →</span>
          </a>
          <a href="https://auth0.com" target="_blank" class="p-4 bg-surface border border-border rounded-xl hover:border-primary/50 transition-colors no-underline">
            <h3 class="text-white font-bold mb-2">Auth0</h3>
            <p class="text-text-secondary text-sm mb-2">
              엔터프라이즈급 인증 플랫폼.
              다양한 프레임워크 지원.
            </p>
            <span class="text-text-secondary text-xs">무료 티어: 월 7,000 MAU →</span>
          </a>
          <a href="https://supabase.com/auth" target="_blank" class="p-4 bg-surface border border-border rounded-xl hover:border-primary/50 transition-colors no-underline">
            <h3 class="text-white font-bold mb-2">Supabase Auth</h3>
            <p class="text-text-secondary text-sm mb-2">
              Supabase 데이터베이스와 통합된 인증.
              PostgreSQL Row Level Security 지원.
            </p>
            <span class="text-text-secondary text-xs">무료 티어: 월 50,000 MAU →</span>
          </a>
          <a href="https://firebase.google.com/products/auth" target="_blank" class="p-4 bg-surface border border-border rounded-xl hover:border-primary/50 transition-colors no-underline">
            <h3 class="text-white font-bold mb-2">Firebase Auth</h3>
            <p class="text-text-secondary text-sm mb-2">
              Google의 인증 서비스.
              모바일 앱에도 적합.
            </p>
            <span class="text-text-secondary text-xs">무료 티어: 무제한 →</span>
          </a>
        </div>
      </section>

      <!-- FastAPI + JWT 예시 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">FastAPI + JWT 예시 (참고용)</h2>

        <p class="text-text-secondary mb-4">
          직접 구현해야 한다면, 아래 구조를 참고하세요:
        </p>

        <CodeBlock
          client:load
          code={`from fastapi import FastAPI, Depends, HTTPException
from fastapi.security import OAuth2PasswordBearer
from jose import JWTError, jwt
from passlib.context import CryptContext
from datetime import datetime, timedelta

# 비밀번호 해싱
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

# JWT 설정
SECRET_KEY = "your-secret-key"  # 실제로는 환경변수로!
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 30

oauth2_scheme = OAuth2PasswordBearer(tokenUrl="token")

def verify_password(plain_password, hashed_password):
    return pwd_context.verify(plain_password, hashed_password)

def create_access_token(data: dict):
    to_encode = data.copy()
    expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    to_encode.update({"exp": expire})
    return jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)

async def get_current_user(token: str = Depends(oauth2_scheme)):
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        user_id: str = payload.get("sub")
        if user_id is None:
            raise HTTPException(status_code=401, detail="Invalid token")
        return user_id
    except JWTError:
        raise HTTPException(status_code=401, detail="Invalid token")`}
          filename="app/auth.py"
        />

        <Callout client:load variant="error" title="주의: 프로덕션에서는 더 많은 고려 필요">
          <ul class="list-disc list-inside space-y-1 mt-2 text-sm">
            <li>HTTPS 필수</li>
            <li>환경변수로 시크릿 키 관리</li>
            <li>Refresh Token 구현</li>
            <li>Rate Limiting</li>
            <li>로그인 시도 제한</li>
          </ul>
        </Callout>
      </section>

      <!-- 다음 단계 -->
      <section class="mb-10">
        <Callout client:load variant="info" title="상세 가이드 준비 중">
          <p class="text-sm">
            인증 구현에 대한 더 자세한 가이드를 준비하고 있습니다.
            먼저 <a href="/start/60min" class="text-primary hover:underline">60분 완주</a>와
            <a href="/cycle/4-database" class="text-primary hover:underline">데이터베이스 연결</a>을 완료하세요.
          </p>
        </Callout>
      </section>
    </article>

    <nav class="flex items-center justify-between pt-8 border-t border-border">
      <a
        href="/cycle/4-database"
        class="group flex items-center gap-3 px-4 py-2 rounded-lg border border-border hover:bg-surface transition-colors no-underline"
      >
        <svg class="w-5 h-5 text-text-secondary group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        <div class="text-left">
          <span class="text-xs text-text-secondary">이전</span>
          <span class="block text-sm text-white font-medium">데이터베이스</span>
        </div>
      </a>

      <a
        href="/cycle/0-overview"
        class="group flex items-center gap-3 px-4 py-2 rounded-lg bg-primary hover:bg-primary-hover text-background transition-colors no-underline"
      >
        <div class="text-right">
          <span class="text-xs opacity-70">돌아가기</span>
          <span class="block text-sm font-bold">학습 사이클</span>
        </div>
        <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </a>
    </nav>
  </div>
</DocsLayout>
