---
import DocsLayout from '../../../layouts/DocsLayout.astro';
import Callout from '../../../components/Callout';
import CodeBlock from '../../../components/CodeBlock';

const pytestExample = `# tests/test_projects.py
import pytest
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)

def test_create_project():
    """프로젝트 생성 테스트"""
    response = client.post(
        "/api/v1/projects",
        json={"name": "Test Project", "description": "A test"}
    )
    assert response.status_code == 201
    data = response.json()
    assert data["name"] == "Test Project"
    assert "id" in data

def test_create_project_validation():
    """이름 필드 검증 테스트"""
    response = client.post("/api/v1/projects", json={})
    assert response.status_code == 422  # Validation error

def test_get_projects_empty():
    """빈 목록 반환 테스트"""
    response = client.get("/api/v1/projects")
    assert response.status_code == 200
    assert response.json()["items"] == []`;

const vitestExample = `// src/index.test.ts
import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { app } from './index';

describe('Todos API', () => {
  // 각 테스트 전에 저장소 초기화
  beforeEach(() => {
    // Reset storage
  });

  describe('POST /api/v1/todos', () => {
    it('should create a todo', async () => {
      const res = await app.request('/api/v1/todos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title: 'Test Todo' }),
      });

      expect(res.status).toBe(201);
      const data = await res.json();
      expect(data.title).toBe('Test Todo');
      expect(data.is_completed).toBe(false);
    });

    it('should return 422 for empty title', async () => {
      const res = await app.request('/api/v1/todos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title: '' }),
      });

      expect(res.status).toBe(422); // Validation error
    });
  });

  describe('PATCH /api/v1/todos/:id', () => {
    it('should toggle todo completion', async () => {
      // Create a todo first
      const createRes = await app.request('/api/v1/todos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title: 'Test' }),
      });
      const { id } = await createRes.json();

      // Toggle completion
      const res = await app.request(\`/api/v1/todos/\${id}\`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_completed: true }),
      });

      expect(res.status).toBe(200);
      const data = await res.json();
      expect(data.is_completed).toBe(true);
    });
  });
});`;

const vueTestExample = `// src/__tests__/useTodos.test.ts
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { flushPromises } from '@vue/test-utils';
import { QueryClient, VueQueryPlugin } from '@tanstack/vue-query';
import { createApp, h, defineComponent } from 'vue';
import { useTodos, useCreateTodo } from '../composables/useTodos';

// Vue composable 테스트를 위한 헬퍼
function withSetup<T>(composable: () => T) {
  let result!: T;

  const TestComponent = defineComponent({
    setup() {
      result = composable();
      return () => h('div');
    },
  });

  const queryClient = new QueryClient({
    defaultOptions: {
      queries: { retry: false },
      mutations: { retry: false },
    },
  });

  const app = createApp(TestComponent);
  app.use(VueQueryPlugin, { queryClient });
  app.mount(document.createElement('div'));

  return { result, app };
}

describe('useTodos', () => {
  beforeEach(() => {
    vi.restoreAllMocks();
  });

  it('should fetch todos list', async () => {
    const mockResponse = {
      items: [{ id: '1', title: 'Todo 1', is_completed: false }],
      total: 1,
    };

    global.fetch = vi.fn().mockResolvedValue({
      ok: true,
      json: () => Promise.resolve(mockResponse),
    });

    const { result, app } = withSetup(() => useTodos());

    await flushPromises();
    await new Promise(resolve => setTimeout(resolve, 100));

    expect(result.data.value).toEqual(mockResponse);
    app.unmount();
  });
});`;

const reactTestExample = `// src/__tests__/useProjects.test.ts
import { renderHook, waitFor } from '@testing-library/react';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { useProjects, useCreateProject } from '../hooks/useProjects';

const createWrapper = () => {
  const queryClient = new QueryClient({
    defaultOptions: {
      queries: { retry: false },
    },
  });
  return ({ children }) => (
    <QueryClientProvider client={queryClient}>
      {children}
    </QueryClientProvider>
  );
};

describe('useProjects', () => {
  it('should fetch projects', async () => {
    const mockData = { items: [{ id: '1', name: 'Test' }], total: 1 };

    global.fetch = vi.fn().mockResolvedValue({
      ok: true,
      json: () => Promise.resolve(mockData),
    });

    const { result } = renderHook(() => useProjects(), {
      wrapper: createWrapper(),
    });

    await waitFor(() => {
      expect(result.current.data).toEqual(mockData);
    });
  });
});`;
---

<DocsLayout
  title="단위 테스트 가이드"
  description="pytest와 Vitest로 단위 테스트 작성하기"
  currentPath="/map/testing/unit"
>
  <div class="max-w-4xl mx-auto px-6 py-8">
    <nav class="flex items-center gap-2 text-sm text-text-secondary mb-6" aria-label="현재 위치">
      <a href="/" class="hover:text-white transition-colors">홈</a>
      <span>/</span>
      <a href="/map/testing" class="hover:text-white transition-colors">테스팅</a>
      <span>/</span>
      <span class="text-primary font-medium">단위 테스트</span>
    </nav>

    <header class="mb-8 pb-6 border-b border-border">
      <div class="flex items-center gap-2 mb-4">
        <span class="px-3 py-1 rounded-full bg-green-500/10 text-green-400 text-xs font-bold">Unit</span>
        <span class="px-3 py-1 rounded-full bg-surface text-text-secondary text-xs">pytest</span>
        <span class="px-3 py-1 rounded-full bg-surface text-text-secondary text-xs">Vitest</span>
      </div>
      <h1 class="text-3xl md:text-4xl font-black text-white mb-4">
        단위 테스트 가이드
      </h1>
      <p class="text-text-secondary text-lg leading-relaxed">
        개별 함수, API 엔드포인트, 컴포넌트를 격리하여 테스트합니다.
        빠르게 실행되고 디버깅이 쉬운 것이 장점입니다.
      </p>
    </header>

    <section class="mb-10">
      <Callout client:load variant="tip" title="단위 테스트의 원칙">
        <ul class="list-disc list-inside space-y-1 mt-2">
          <li><strong class="text-white">Fast</strong>: 밀리초 단위로 실행</li>
          <li><strong class="text-white">Isolated</strong>: 다른 테스트에 영향 없음</li>
          <li><strong class="text-white">Repeatable</strong>: 언제 실행해도 같은 결과</li>
          <li><strong class="text-white">Self-validating</strong>: 성공/실패가 명확</li>
        </ul>
      </Callout>
    </section>

    <article class="prose prose-invert max-w-none">
      <!-- Python pytest -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">Python: pytest</h2>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">설치 및 설정</h3>

        <CodeBlock
          client:load
          code={`# 의존성 설치
pip install pytest pytest-asyncio httpx

# pytest.ini (설정 파일)
[pytest]
testpaths = tests
asyncio_mode = auto`}
          filename="터미널"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">API 테스트 예제</h3>

        <CodeBlock
          client:load
          code={pytestExample}
          filename="tests/test_projects.py"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">테스트 실행</h3>

        <CodeBlock
          client:load
          code={`# 전체 테스트 실행
pytest

# 상세 출력
pytest -v

# 특정 파일만
pytest tests/test_projects.py

# 특정 함수만
pytest tests/test_projects.py::test_create_project

# 커버리지 확인
pip install pytest-cov
pytest --cov=app --cov-report=html`}
          filename="터미널"
        />

        <Callout client:load variant="info" title="FastAPI TestClient">
          <p class="text-sm mt-1">
            FastAPI의 <code class="bg-surface px-1 rounded">TestClient</code>는
            실제 HTTP 요청 없이 API를 테스트할 수 있습니다.
            비동기 테스트가 필요하면 <code class="bg-surface px-1 rounded">httpx.AsyncClient</code>를 사용하세요.
          </p>
        </Callout>
      </section>

      <!-- Vitest -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">Node.js: Vitest</h2>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">설치 및 설정</h3>

        <CodeBlock
          client:load
          code={`# 의존성 설치
npm install -D vitest

# package.json scripts
{
  "scripts": {
    "test": "vitest",
    "test:run": "vitest run",
    "test:coverage": "vitest run --coverage"
  }
}`}
          filename="터미널"
        />

        <CodeBlock
          client:load
          code={`// vitest.config.ts
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    globals: false,
    environment: 'node', // 또는 'jsdom' (브라우저 환경)
  },
});`}
          filename="vitest.config.ts"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Hono API 테스트 예제</h3>

        <CodeBlock
          client:load
          code={vitestExample}
          filename="src/index.test.ts"
        />

        <Callout client:load variant="tip" title="Hono의 app.request()">
          <p class="text-sm mt-1">
            Hono는 <code class="bg-surface px-1 rounded">app.request()</code> 메서드로
            실제 서버 없이 HTTP 요청을 시뮬레이션할 수 있습니다.
          </p>
        </Callout>
      </section>

      <!-- Vue 테스트 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">Vue: Vitest + @vue/test-utils</h2>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">설정</h3>

        <CodeBlock
          client:load
          code={`# 의존성 설치
npm install -D vitest @vue/test-utils jsdom

# vitest.config.ts
import { defineConfig } from 'vitest/config';
import vue from '@vitejs/plugin-vue';

export default defineConfig({
  plugins: [vue()],
  test: {
    environment: 'jsdom',  // 브라우저 환경 시뮬레이션
    globals: false,
  },
});`}
          filename="설정"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Composable 테스트 예제</h3>

        <CodeBlock
          client:load
          code={vueTestExample}
          filename="src/__tests__/useTodos.test.ts"
        />

        <Callout client:load variant="warning" title="jsdom 환경 필수">
          <p class="text-sm mt-1">
            Vue 컴포넌트와 composable 테스트에는 <code class="bg-surface px-1 rounded">environment: 'jsdom'</code>이 필요합니다.
            설정하지 않으면 <code class="bg-surface px-1 rounded">document is not defined</code> 에러가 발생합니다.
          </p>
        </Callout>
      </section>

      <!-- React 테스트 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">React: Vitest + @testing-library/react</h2>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">설정</h3>

        <CodeBlock
          client:load
          code={`# 의존성 설치
npm install -D vitest @testing-library/react @testing-library/jest-dom jsdom`}
          filename="터미널"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Hook 테스트 예제</h3>

        <CodeBlock
          client:load
          code={reactTestExample}
          filename="src/__tests__/useProjects.test.ts"
        />
      </section>

      <!-- 모킹 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">모킹 (Mocking)</h2>

        <p class="text-text-secondary mb-4">
          외부 의존성(API, 데이터베이스)을 모킹하여 격리된 테스트를 작성합니다.
        </p>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Vitest에서 fetch 모킹</h3>

        <CodeBlock
          client:load
          code={`import { vi, describe, it, expect, beforeEach, afterEach } from 'vitest';

// 전역 fetch 모킹
const originalFetch = global.fetch;

beforeEach(() => {
  global.fetch = vi.fn();
});

afterEach(() => {
  global.fetch = originalFetch;
});

it('should handle API response', async () => {
  // 성공 응답 모킹
  vi.mocked(global.fetch).mockResolvedValue({
    ok: true,
    json: () => Promise.resolve({ data: 'test' }),
  } as Response);

  // 테스트 실행
  const result = await fetchData();
  expect(result.data).toBe('test');
});

it('should handle API error', async () => {
  // 에러 응답 모킹
  vi.mocked(global.fetch).mockResolvedValue({
    ok: false,
    status: 500,
  } as Response);

  // 에러 처리 검증
  await expect(fetchData()).rejects.toThrow();
});`}
          filename="모킹 예제"
        />
      </section>

      <!-- 베스트 프랙티스 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">베스트 프랙티스</h2>

        <div class="grid md:grid-cols-2 gap-4">
          <div class="p-4 bg-green-500/10 border border-green-500/30 rounded-xl">
            <h3 class="text-green-400 font-bold mb-2">DO</h3>
            <ul class="text-text-secondary text-sm space-y-1">
              <li>✅ 하나의 테스트에 하나의 검증</li>
              <li>✅ 테스트 이름에 의도 명시</li>
              <li>✅ 외부 의존성 모킹</li>
              <li>✅ 엣지 케이스 테스트</li>
              <li>✅ 에러 상황 테스트</li>
            </ul>
          </div>
          <div class="p-4 bg-red-500/10 border border-red-500/30 rounded-xl">
            <h3 class="text-red-400 font-bold mb-2">DON'T</h3>
            <ul class="text-text-secondary text-sm space-y-1">
              <li>❌ 테스트 간 상태 공유</li>
              <li>❌ 실제 API/DB 호출</li>
              <li>❌ sleep/setTimeout 의존</li>
              <li>❌ 구현 세부사항 테스트</li>
              <li>❌ 매직 넘버 사용</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- 다음 단계 -->
      <section class="mb-10">
        <Callout client:load variant="info" title="다음 단계">
          <p class="text-sm">
            단위 테스트를 마스터했다면,
            <a href="/map/testing/e2e" class="text-primary hover:underline">E2E 테스트 가이드</a>에서
            Playwright로 전체 사용자 시나리오를 테스트하는 방법을 배웁니다.
          </p>
        </Callout>
      </section>
    </article>

    <nav class="flex items-center justify-between pt-8 border-t border-border" aria-label="페이지 이동">
      <a
        href="/map/testing"
        class="group flex items-center gap-3 px-4 py-2 rounded-lg border border-border hover:bg-surface transition-colors no-underline"
      >
        <svg class="w-5 h-5 text-text-secondary group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        <div class="text-left">
          <span class="text-xs text-text-secondary">이전</span>
          <span class="block text-sm text-white font-medium">테스팅 개요</span>
        </div>
      </a>

      <a
        href="/map/testing/e2e"
        class="group flex items-center gap-3 px-4 py-2 rounded-lg bg-primary hover:bg-primary-hover text-background transition-colors no-underline"
      >
        <div class="text-right">
          <span class="text-xs opacity-70">다음</span>
          <span class="block text-sm font-bold">E2E 테스트</span>
        </div>
        <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </a>
    </nav>
  </div>
</DocsLayout>
