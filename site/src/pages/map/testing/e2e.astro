---
import DocsLayout from '../../../layouts/DocsLayout.astro';
import Callout from '../../../components/Callout';
import CodeBlock from '../../../components/CodeBlock';

const playwrightConfig = `// playwright.config.ts
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:5173',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
    // 모바일 테스트
    {
      name: 'Mobile Chrome',
      use: { ...devices['Pixel 5'] },
    },
  ],
  // 테스트 전 서버 시작
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:5173',
    reuseExistingServer: !process.env.CI,
  },
});`;

const basicTest = `// e2e/todo.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Todo App', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/');
  });

  test('should display the home page', async ({ page }) => {
    // 페이지 타이틀 확인
    await expect(page).toHaveTitle(/Todo/);

    // 메인 헤딩 확인
    await expect(page.getByRole('heading', { level: 1 })).toBeVisible();
  });

  test('should create a new todo', async ({ page }) => {
    // 입력 필드에 텍스트 입력
    await page.getByPlaceholder('할 일을 입력하세요').fill('새로운 할 일');

    // 추가 버튼 클릭
    await page.getByRole('button', { name: '추가' }).click();

    // 목록에 추가되었는지 확인
    await expect(page.getByText('새로운 할 일')).toBeVisible();
  });

  test('should toggle todo completion', async ({ page }) => {
    // 할 일 생성
    await page.getByPlaceholder('할 일을 입력하세요').fill('테스트 할 일');
    await page.getByRole('button', { name: '추가' }).click();

    // 체크박스 클릭
    await page.getByRole('checkbox').first().click();

    // 완료 상태 확인 (취소선 스타일)
    await expect(page.getByText('테스트 할 일')).toHaveClass(/line-through/);
  });

  test('should delete a todo', async ({ page }) => {
    // 할 일 생성
    await page.getByPlaceholder('할 일을 입력하세요').fill('삭제할 할 일');
    await page.getByRole('button', { name: '추가' }).click();

    // 삭제 버튼 클릭
    await page.getByRole('button', { name: '삭제' }).click();

    // 목록에서 사라졌는지 확인
    await expect(page.getByText('삭제할 할 일')).not.toBeVisible();
  });
});`;

const apiMocking = `// e2e/with-mock.spec.ts
import { test, expect } from '@playwright/test';

test('should display mocked todos', async ({ page }) => {
  // API 응답 모킹
  await page.route('**/api/v1/todos**', async (route) => {
    await route.fulfill({
      status: 200,
      contentType: 'application/json',
      body: JSON.stringify({
        items: [
          { id: '1', title: 'Mocked Todo 1', is_completed: false },
          { id: '2', title: 'Mocked Todo 2', is_completed: true },
        ],
        total: 2,
      }),
    });
  });

  await page.goto('/');

  // 모킹된 데이터 확인
  await expect(page.getByText('Mocked Todo 1')).toBeVisible();
  await expect(page.getByText('Mocked Todo 2')).toBeVisible();
});

test('should handle API error', async ({ page }) => {
  // API 에러 모킹
  await page.route('**/api/v1/todos**', async (route) => {
    await route.fulfill({
      status: 500,
      contentType: 'application/json',
      body: JSON.stringify({ error: 'Server error' }),
    });
  });

  await page.goto('/');

  // 에러 메시지 확인
  await expect(page.getByText(/에러|오류|실패/)).toBeVisible();
});`;

const visualTest = `// e2e/visual.spec.ts
import { test, expect } from '@playwright/test';

test('visual regression test', async ({ page }) => {
  await page.goto('/');

  // 전체 페이지 스크린샷 비교
  await expect(page).toHaveScreenshot('home-page.png');
});

test('component screenshot', async ({ page }) => {
  await page.goto('/');

  // 특정 컴포넌트만 스크린샷
  const todoList = page.locator('[data-testid="todo-list"]');
  await expect(todoList).toHaveScreenshot('todo-list.png');
});

test('full page screenshot with interactions', async ({ page }) => {
  await page.goto('/');

  // 할 일 추가 후 스크린샷
  await page.getByPlaceholder('할 일을 입력하세요').fill('스크린샷 테스트');
  await page.getByRole('button', { name: '추가' }).click();

  await expect(page).toHaveScreenshot('with-todo.png');
});`;

const ciConfig = `# .github/workflows/e2e.yml
name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Run E2E tests
        run: npx playwright test

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30`;
---

<DocsLayout
  title="E2E 테스트 가이드"
  description="Playwright로 E2E 테스트 작성하기"
  currentPath="/map/testing/e2e"
>
  <div class="max-w-4xl mx-auto px-6 py-8">
    <nav class="flex items-center gap-2 text-sm text-text-secondary mb-6" aria-label="현재 위치">
      <a href="/" class="hover:text-white transition-colors">홈</a>
      <span>/</span>
      <a href="/map/testing" class="hover:text-white transition-colors">테스팅</a>
      <span>/</span>
      <span class="text-primary font-medium">E2E 테스트</span>
    </nav>

    <header class="mb-8 pb-6 border-b border-border">
      <div class="flex items-center gap-2 mb-4">
        <span class="px-3 py-1 rounded-full bg-red-500/10 text-red-400 text-xs font-bold">E2E</span>
        <span class="px-3 py-1 rounded-full bg-surface text-text-secondary text-xs">Playwright</span>
      </div>
      <h1 class="text-3xl md:text-4xl font-black text-white mb-4">
        E2E 테스트 가이드
      </h1>
      <p class="text-text-secondary text-lg leading-relaxed">
        Playwright로 실제 브라우저에서 사용자 시나리오를 테스트합니다.
        크로스 브라우저 테스트와 시각적 회귀 테스트를 자동화합니다.
      </p>
    </header>

    <section class="mb-10">
      <Callout client:load variant="tip" title="왜 Playwright인가?">
        <ul class="list-disc list-inside space-y-1 mt-2">
          <li><strong class="text-white">크로스 브라우저</strong>: Chrome, Firefox, Safari, Edge</li>
          <li><strong class="text-white">자동 대기</strong>: 요소가 준비될 때까지 자동 대기</li>
          <li><strong class="text-white">강력한 선택자</strong>: 텍스트, 역할, 테스트 ID 기반</li>
          <li><strong class="text-white">스크린샷/비디오</strong>: 실패 시 자동 캡처</li>
        </ul>
      </Callout>
    </section>

    <article class="prose prose-invert max-w-none">
      <!-- 설치 및 설정 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">설치 및 설정</h2>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">프로젝트 초기화</h3>

        <CodeBlock
          client:load
          code={`# Playwright 설치
npm init playwright@latest

# 또는 기존 프로젝트에 추가
npm install -D @playwright/test
npx playwright install`}
          filename="터미널"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">설정 파일</h3>

        <CodeBlock
          client:load
          code={playwrightConfig}
          filename="playwright.config.ts"
        />

        <Callout client:load variant="info" title="webServer 옵션">
          <p class="text-sm mt-1">
            <code class="bg-surface px-1 rounded">webServer</code> 설정으로
            테스트 전에 자동으로 개발 서버를 시작할 수 있습니다.
          </p>
        </Callout>
      </section>

      <!-- 기본 테스트 작성 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">기본 테스트 작성</h2>

        <CodeBlock
          client:load
          code={basicTest}
          filename="e2e/todo.spec.ts"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">테스트 실행</h3>

        <CodeBlock
          client:load
          code={`# 전체 테스트 실행
npx playwright test

# UI 모드로 실행 (디버깅에 유용)
npx playwright test --ui

# 특정 브라우저만
npx playwright test --project=chromium

# 특정 파일만
npx playwright test e2e/todo.spec.ts

# 헤드리스 모드 끄기 (브라우저 보기)
npx playwright test --headed

# 테스트 리포트 열기
npx playwright show-report`}
          filename="터미널"
        />
      </section>

      <!-- 선택자 베스트 프랙티스 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">선택자 베스트 프랙티스</h2>

        <div class="grid md:grid-cols-2 gap-4 mb-6">
          <div class="p-4 bg-green-500/10 border border-green-500/30 rounded-xl">
            <h3 class="text-green-400 font-bold mb-2">추천</h3>
            <ul class="text-text-secondary text-sm space-y-2">
              <li><code class="bg-surface px-1 rounded">getByRole('button', {'{'}name: '추가'{'}'})</code></li>
              <li><code class="bg-surface px-1 rounded">getByText('할 일 목록')</code></li>
              <li><code class="bg-surface px-1 rounded">getByPlaceholder('입력...')</code></li>
              <li><code class="bg-surface px-1 rounded">getByTestId('todo-list')</code></li>
            </ul>
          </div>
          <div class="p-4 bg-red-500/10 border border-red-500/30 rounded-xl">
            <h3 class="text-red-400 font-bold mb-2">피하기</h3>
            <ul class="text-text-secondary text-sm space-y-2">
              <li><code class="bg-surface px-1 rounded">locator('.btn-primary')</code></li>
              <li><code class="bg-surface px-1 rounded">locator('#submit-btn')</code></li>
              <li><code class="bg-surface px-1 rounded">locator('div > button:nth-child(2)')</code></li>
            </ul>
          </div>
        </div>

        <Callout client:load variant="tip" title="우선순위">
          <p class="text-sm mt-1">
            <code class="bg-surface px-1 rounded">getByRole</code> &gt;
            <code class="bg-surface px-1 rounded">getByText</code> &gt;
            <code class="bg-surface px-1 rounded">getByTestId</code> &gt;
            <code class="bg-surface px-1 rounded">locator</code>
          </p>
        </Callout>
      </section>

      <!-- API 모킹 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">API 모킹</h2>

        <p class="text-text-secondary mb-4">
          실제 백엔드 없이도 프론트엔드를 테스트할 수 있습니다.
          <code class="bg-surface px-1 rounded">page.route()</code>로 API 응답을 모킹합니다.
        </p>

        <CodeBlock
          client:load
          code={apiMocking}
          filename="e2e/with-mock.spec.ts"
        />
      </section>

      <!-- 시각적 회귀 테스트 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">시각적 회귀 테스트</h2>

        <p class="text-text-secondary mb-4">
          스크린샷을 비교하여 UI가 의도치 않게 변경되었는지 감지합니다.
        </p>

        <CodeBlock
          client:load
          code={visualTest}
          filename="e2e/visual.spec.ts"
        />

        <CodeBlock
          client:load
          code={`# 첫 실행: 기준 스크린샷 생성
npx playwright test --update-snapshots

# 이후 실행: 기준과 비교
npx playwright test`}
          filename="터미널"
        />

        <Callout client:load variant="warning" title="OS별 차이">
          <p class="text-sm mt-1">
            스크린샷은 OS별로 렌더링이 다를 수 있습니다.
            CI에서 일관된 결과를 위해 Docker를 사용하거나
            <code class="bg-surface px-1 rounded">threshold</code>를 설정하세요.
          </p>
        </Callout>
      </section>

      <!-- CI/CD 통합 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">CI/CD 통합</h2>

        <CodeBlock
          client:load
          code={ciConfig}
          filename=".github/workflows/e2e.yml"
        />

        <Callout client:load variant="info" title="Playwright 브라우저 캐싱">
          <p class="text-sm mt-1">
            CI에서 브라우저 설치 시간을 줄이려면
            <a href="https://playwright.dev/docs/ci-intro#caching-browsers" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">캐싱 설정</a>을 참고하세요.
          </p>
        </Callout>
      </section>

      <!-- 디버깅 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">디버깅 팁</h2>

        <CodeBlock
          client:load
          code={`# UI 모드 (가장 추천)
npx playwright test --ui

# 디버그 모드 (브레이크포인트 지원)
npx playwright test --debug

# 추적 기록 (trace.zip)
npx playwright test --trace on

# Codegen: 브라우저 조작을 코드로 변환
npx playwright codegen localhost:5173`}
          filename="터미널"
        />

        <div class="grid md:grid-cols-2 gap-4 mt-6">
          <div class="p-4 bg-surface border border-border rounded-xl">
            <h3 class="text-white font-bold mb-2">UI 모드</h3>
            <p class="text-text-secondary text-sm">
              테스트를 단계별로 실행하고 각 단계의 DOM 상태를 확인할 수 있습니다.
            </p>
          </div>
          <div class="p-4 bg-surface border border-border rounded-xl">
            <h3 class="text-white font-bold mb-2">Codegen</h3>
            <p class="text-text-secondary text-sm">
              브라우저에서 직접 조작하면 자동으로 테스트 코드가 생성됩니다.
            </p>
          </div>
        </div>
      </section>

      <!-- 베스트 프랙티스 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">베스트 프랙티스</h2>

        <div class="grid md:grid-cols-2 gap-4">
          <div class="p-4 bg-green-500/10 border border-green-500/30 rounded-xl">
            <h3 class="text-green-400 font-bold mb-2">DO</h3>
            <ul class="text-text-secondary text-sm space-y-1">
              <li>✅ 핵심 사용자 시나리오만 테스트</li>
              <li>✅ 의미 있는 선택자 사용</li>
              <li>✅ API 모킹으로 안정성 확보</li>
              <li>✅ 실패 시 스크린샷 캡처</li>
              <li>✅ CI에서 병렬 실행</li>
            </ul>
          </div>
          <div class="p-4 bg-red-500/10 border border-red-500/30 rounded-xl">
            <h3 class="text-red-400 font-bold mb-2">DON'T</h3>
            <ul class="text-text-secondary text-sm space-y-1">
              <li>❌ 모든 것을 E2E로 테스트</li>
              <li>❌ CSS 선택자에 의존</li>
              <li>❌ 고정된 대기 시간 사용</li>
              <li>❌ 테스트 간 데이터 공유</li>
              <li>❌ 너무 많은 E2E 테스트</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- 다음 단계 -->
      <section class="mb-10">
        <Callout client:load variant="info" title="테스팅 완료!">
          <p class="text-sm">
            테스팅 가이드를 모두 완료했습니다.
            이제 <a href="/map" class="text-primary hover:underline">학습 로드맵</a>으로 돌아가
            다른 주제를 학습하거나, 직접 프로젝트에 테스트를 작성해보세요.
          </p>
        </Callout>
      </section>
    </article>

    <nav class="flex items-center justify-between pt-8 border-t border-border" aria-label="페이지 이동">
      <a
        href="/map/testing/unit"
        class="group flex items-center gap-3 px-4 py-2 rounded-lg border border-border hover:bg-surface transition-colors no-underline"
      >
        <svg class="w-5 h-5 text-text-secondary group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        <div class="text-left">
          <span class="text-xs text-text-secondary">이전</span>
          <span class="block text-sm text-white font-medium">단위 테스트</span>
        </div>
      </a>

      <a
        href="/map"
        class="group flex items-center gap-3 px-4 py-2 rounded-lg bg-primary hover:bg-primary-hover text-background transition-colors no-underline"
      >
        <div class="text-right">
          <span class="text-xs opacity-70">돌아가기</span>
          <span class="block text-sm font-bold">학습 로드맵</span>
        </div>
        <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </a>
    </nav>
  </div>
</DocsLayout>
