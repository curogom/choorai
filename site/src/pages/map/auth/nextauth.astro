---
import DocsLayout from '../../../layouts/DocsLayout.astro';
import Callout from '../../../components/Callout';
import CodeBlock from '../../../components/CodeBlock';
import SectionHeader from '../../../components/SectionHeader';
import MetaBadge from '../../../components/MetaBadge';
import PageNavigation from '../../../components/PageNavigation.astro';

const installCode = `npm install next-auth`;

const envCode = `# .env.local
NEXTAUTH_SECRET=your-secret-key-here
NEXTAUTH_URL=http://localhost:3000

# Google OAuth (선택)
GOOGLE_CLIENT_ID=xxx
GOOGLE_CLIENT_SECRET=xxx

# GitHub OAuth (선택)
GITHUB_ID=xxx
GITHUB_SECRET=xxx`;

const routeHandlerCode = `// app/api/auth/[...nextauth]/route.ts
import NextAuth from 'next-auth';
import GoogleProvider from 'next-auth/providers/google';
import GitHubProvider from 'next-auth/providers/github';
import CredentialsProvider from 'next-auth/providers/credentials';

const handler = NextAuth({
  providers: [
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    }),
    GitHubProvider({
      clientId: process.env.GITHUB_ID!,
      clientSecret: process.env.GITHUB_SECRET!,
    }),
    // 이메일/비밀번호 로그인 (직접 구현)
    CredentialsProvider({
      name: 'Credentials',
      credentials: {
        email: { label: 'Email', type: 'email' },
        password: { label: 'Password', type: 'password' },
      },
      async authorize(credentials) {
        // 여기서 DB 조회 및 비밀번호 검증
        // 실제로는 bcrypt 등으로 해시 비교 필요
        const user = await findUserByEmail(credentials?.email);
        if (user && verifyPassword(credentials?.password, user.password)) {
          return { id: user.id, email: user.email, name: user.name };
        }
        return null;
      },
    }),
  ],
  pages: {
    signIn: '/login',  // 커스텀 로그인 페이지
    error: '/auth/error',
  },
  callbacks: {
    async session({ session, token }) {
      // 세션에 사용자 ID 추가
      if (token.sub) {
        session.user.id = token.sub;
      }
      return session;
    },
  },
});

export { handler as GET, handler as POST };`;

const sessionProviderCode = `// app/providers.tsx
'use client';

import { SessionProvider } from 'next-auth/react';

export function Providers({ children }: { children: React.ReactNode }) {
  return <SessionProvider>{children}</SessionProvider>;
}

// app/layout.tsx
import { Providers } from './providers';

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="ko">
      <body>
        <Providers>{children}</Providers>
      </body>
    </html>
  );
}`;

const useSessionCode = `// components/AuthStatus.tsx
'use client';

import { useSession, signIn, signOut } from 'next-auth/react';

export function AuthStatus() {
  const { data: session, status } = useSession();

  if (status === 'loading') {
    return <div>로딩 중...</div>;
  }

  if (status === 'unauthenticated') {
    return (
      <div className="flex gap-2">
        <button
          onClick={() => signIn('google')}
          className="px-4 py-2 bg-white text-gray-800 rounded-lg border"
        >
          Google로 로그인
        </button>
        <button
          onClick={() => signIn('github')}
          className="px-4 py-2 bg-gray-800 text-white rounded-lg"
        >
          GitHub로 로그인
        </button>
      </div>
    );
  }

  return (
    <div className="flex items-center gap-4">
      <span>안녕하세요, {session?.user?.name}님!</span>
      <button
        onClick={() => signOut()}
        className="px-4 py-2 bg-red-600 text-white rounded-lg"
      >
        로그아웃
      </button>
    </div>
  );
}`;

const serverSessionCode = `// app/dashboard/page.tsx
import { getServerSession } from 'next-auth';
import { redirect } from 'next/navigation';
import { authOptions } from '@/app/api/auth/[...nextauth]/route';

export default async function DashboardPage() {
  const session = await getServerSession(authOptions);

  if (!session) {
    redirect('/login');
  }

  return (
    <div>
      <h1>대시보드</h1>
      <p>환영합니다, {session.user?.name}님!</p>
    </div>
  );
}`;

const middlewareCode = `// middleware.ts
import { withAuth } from 'next-auth/middleware';

export default withAuth({
  callbacks: {
    authorized: ({ token }) => !!token,
  },
});

// 보호할 경로 지정
export const config = {
  matcher: ['/dashboard/:path*', '/settings/:path*', '/api/protected/:path*'],
};`;

const prismaAdapterCode = `// 1. 패키지 설치
// npm install @prisma/client @next-auth/prisma-adapter
// npm install -D prisma

// 2. Prisma 스키마
// prisma/schema.prisma
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// 3. NextAuth 설정에 어댑터 추가
import { PrismaAdapter } from '@next-auth/prisma-adapter';
import { prisma } from '@/lib/prisma';

const handler = NextAuth({
  adapter: PrismaAdapter(prisma),
  providers: [...],
});`;
---

<DocsLayout
  title="NextAuth.js 인증 가이드 (Lv.3)"
  description="Next.js 앱에 NextAuth.js로 인증 기능을 추가하는 방법"
  currentPath="/map/auth/nextauth"
>
  <div class="max-w-4xl mx-auto px-6 py-8">
    <nav class="flex items-center gap-2 text-sm text-text-secondary mb-6" aria-label="현재 위치">
      <a href="/" class="hover:text-white transition-colors">홈</a>
      <span>/</span>
      <a href="/map" class="hover:text-white transition-colors">학습 사이클</a>
      <span>/</span>
      <a href="/map/auth" class="hover:text-white transition-colors">인증 가이드</a>
      <span>/</span>
      <span class="text-primary font-medium">NextAuth</span>
    </nav>

    <header class="mb-8 pb-6 border-b border-border">
      <div class="flex items-center gap-2 mb-4">
        <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-yellow-500/10 text-yellow-400 text-xs font-bold">
          Lv.3
        </span>
        <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-black/50 text-white text-xs font-bold border border-gray-700">
          Next.js
        </span>
      </div>
      <h1 class="text-3xl md:text-4xl font-black text-white mb-4">
        NextAuth.js 인증 가이드
      </h1>
      <p class="text-text-secondary text-lg leading-relaxed">
        NextAuth.js(Auth.js)는 Next.js를 위한 <strong class="text-white">풀스택 인증 솔루션</strong>입니다.
        OAuth, 이메일 로그인, DB 세션을 모두 지원합니다.
      </p>
    </header>

    <section class="mb-10">
      <Callout client:load variant="warning" title="Next.js 전용">
        <p class="text-sm">
          NextAuth.js는 Next.js에서만 사용할 수 있습니다.
          일반 React 앱은 <a href="/map/auth/clerk" class="text-primary hover:underline">Clerk</a>을 사용하세요.
        </p>
      </Callout>
    </section>

    <section class="mb-10">
      <Callout client:load variant="tip" title="왜 NextAuth인가요?">
        <ul class="list-disc list-inside space-y-1 mt-2">
          <li>Next.js App Router 완벽 지원</li>
          <li>50+ OAuth 프로바이더 지원</li>
          <li>서버 컴포넌트에서 세션 접근 가능</li>
          <li>Prisma, Drizzle 등 DB 어댑터 제공</li>
          <li>무료 & 오픈소스</li>
        </ul>
      </Callout>
    </section>

    <article class="prose prose-invert max-w-none">
      <!-- Step 1: 설치 -->
      <section class="mb-10">
        <SectionHeader number={1} title="설치 및 환경 변수" />

        <CodeBlock
          client:load
          code={installCode}
          filename="터미널"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">환경 변수 설정</h3>
        <CodeBlock
          client:load
          code={envCode}
          filename=".env.local"
        />

        <Callout client:load variant="info">
          <p class="text-sm">
            <code class="bg-surface px-1 rounded">NEXTAUTH_SECRET</code>은
            <code class="bg-surface px-1 rounded">openssl rand -base64 32</code>로 생성할 수 있습니다.
          </p>
        </Callout>
      </section>

      <!-- Step 2: Route Handler -->
      <section class="mb-10">
        <SectionHeader number={2} title="API Route 설정" />

        <p class="text-text-secondary mb-4">
          NextAuth는 <code class="bg-surface px-1 rounded">/api/auth/*</code> 경로를 사용합니다.
        </p>

        <CodeBlock
          client:load
          code={routeHandlerCode}
          filename="app/api/auth/[...nextauth]/route.ts"
        />
      </section>

      <!-- Step 3: SessionProvider -->
      <section class="mb-10">
        <SectionHeader number={3} title="SessionProvider 설정" />

        <p class="text-text-secondary mb-4">
          클라이언트 컴포넌트에서 세션을 사용하려면 <code class="bg-surface px-1 rounded">SessionProvider</code>가 필요합니다.
        </p>

        <CodeBlock
          client:load
          code={sessionProviderCode}
          filename="app/providers.tsx & app/layout.tsx"
        />
      </section>

      <!-- Step 4: 클라이언트 사용 -->
      <section class="mb-10">
        <SectionHeader number={4} title="클라이언트에서 세션 사용" />

        <CodeBlock
          client:load
          code={useSessionCode}
          filename="components/AuthStatus.tsx"
        />
      </section>

      <!-- Step 5: 서버 컴포넌트 -->
      <section class="mb-10">
        <SectionHeader number={5} title="서버 컴포넌트에서 세션 사용" />

        <p class="text-text-secondary mb-4">
          서버 컴포넌트에서는 <code class="bg-surface px-1 rounded">getServerSession</code>을 사용합니다.
        </p>

        <CodeBlock
          client:load
          code={serverSessionCode}
          filename="app/dashboard/page.tsx"
        />
      </section>

      <!-- Step 6: 미들웨어 -->
      <section class="mb-10">
        <SectionHeader number={6} title="미들웨어로 라우트 보호" />

        <p class="text-text-secondary mb-4">
          특정 경로를 일괄적으로 보호하려면 미들웨어를 사용합니다.
        </p>

        <CodeBlock
          client:load
          code={middlewareCode}
          filename="middleware.ts"
        />
      </section>

      <!-- Step 7: Prisma 어댑터 -->
      <section class="mb-10">
        <SectionHeader number={7} title="데이터베이스 연동 (선택)" />

        <p class="text-text-secondary mb-4">
          사용자 정보를 DB에 저장하려면 어댑터를 사용합니다.
        </p>

        <CodeBlock
          client:load
          code={prismaAdapterCode}
          filename="Prisma 어댑터 설정"
        />
      </section>

      <!-- 언제 사용하면 좋은가 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">언제 NextAuth를 선택할까요?</h2>

        <div class="grid md:grid-cols-2 gap-4">
          <div class="p-4 bg-green-500/10 border border-green-500/30 rounded-xl">
            <h3 class="text-white font-bold mb-2">NextAuth 추천</h3>
            <ul class="text-text-secondary text-sm space-y-1">
              <li>Next.js 풀스택 프로젝트</li>
              <li>서버 컴포넌트에서 세션 필요</li>
              <li>DB에 사용자 정보 저장 필요</li>
              <li>무료 솔루션 선호</li>
            </ul>
          </div>
          <div class="p-4 bg-red-500/10 border border-red-500/30 rounded-xl">
            <h3 class="text-white font-bold mb-2">다른 선택지 고려</h3>
            <ul class="text-text-secondary text-sm space-y-1">
              <li>React SPA → <a href="/map/auth/clerk" class="text-primary hover:underline">Clerk</a></li>
              <li>빠른 UI 필요 → <a href="/map/auth/clerk" class="text-primary hover:underline">Clerk</a></li>
              <li>엔터프라이즈 → <a href="/map/auth/auth0" class="text-primary hover:underline">Auth0</a></li>
            </ul>
          </div>
        </div>
      </section>

      <!-- 다음 단계 -->
      <section class="mb-10">
        <Callout client:load variant="info" title="다음 단계">
          <ul class="list-disc list-inside space-y-1 mt-2">
            <li>
              <a href="https://next-auth.js.org/providers" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">
                더 많은 프로바이더
              </a> - 50+ OAuth 프로바이더 설정
            </li>
            <li>
              <a href="https://next-auth.js.org/configuration/callbacks" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">
                Callbacks
              </a> - 세션/토큰 커스터마이징
            </li>
            <li>
              <a href="/map/database/supabase" class="text-primary hover:underline">
                Supabase 연동
              </a> - 데이터베이스와 함께 사용
            </li>
          </ul>
        </Callout>
      </section>
    </article>

    <PageNavigation currentPath="/map/auth/nextauth" />
  </div>
</DocsLayout>
