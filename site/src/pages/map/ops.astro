---
import DocsLayout from '../../layouts/DocsLayout.astro';
import Callout from '../../components/Callout';
import CodeBlock from '../../components/CodeBlock';
import PageNavigation from '../../components/PageNavigation.astro';
---

<DocsLayout
  title="Cycle 6: Ops - 운영 기초"
  description="배포 전략, 모니터링, 장애 대응, 비용 관리 방법"
  currentPath="/map/ops"
>
  <div class="max-w-4xl mx-auto px-6 py-8">
    <nav class="flex items-center gap-2 text-sm text-text-secondary mb-6" aria-label="현재 위치">
      <a href="/" class="hover:text-white transition-colors">홈</a>
      <span>/</span>
      <a href="/map" class="hover:text-white transition-colors">학습 사이클</a>
      <span>/</span>
      <span class="text-primary font-medium">Cycle 6: Ops</span>
    </nav>

    <header class="mb-8 pb-6 border-b border-border">
      <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-primary/10 text-primary text-xs font-bold mb-4">
        Cycle 6
      </div>
      <h1 class="text-3xl md:text-4xl font-black text-white mb-4">
        운영 (Ops) 기초
      </h1>
      <p class="text-text-secondary text-lg leading-relaxed">
        서비스를 안정적으로 운영하기 위한 배포 전략, 모니터링, 장애 대응, 비용 관리를 배웁니다.
      </p>
    </header>

    <section class="mb-10">
      <Callout client:load variant="tip" title="이 Cycle에서 배우는 것">
        <ul class="list-disc list-inside space-y-1 mt-2">
          <li>배포 전략 (Blue-Green, Rolling)</li>
          <li>모니터링과 알림 설정</li>
          <li>장애 대응 프로세스</li>
          <li>비용 관리와 최적화</li>
        </ul>
      </Callout>
    </section>

    <article class="prose prose-invert max-w-none">
      <!-- 배포 전략 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">배포 전략</h2>

        <p class="text-text-secondary mb-4">
          새 버전을 배포할 때 <strong class="text-white">다운타임 없이</strong> 안전하게 배포하는 방법입니다.
        </p>

        <div class="space-y-4 mb-6">
          <div class="p-4 bg-blue-500/10 border border-blue-500/30 rounded-xl">
            <h3 class="text-white font-bold mb-2">Blue-Green 배포</h3>
            <p class="text-text-secondary text-sm mb-3">
              두 개의 동일한 환경(Blue/Green)을 준비하고, 트래픽을 한 번에 전환합니다.
            </p>
            <div class="flex items-center gap-4 text-sm">
              <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-blue-400"></span>
                <span class="text-text-secondary">Blue (현재)</span>
              </div>
              <span class="text-text-secondary">→ 전환 →</span>
              <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-green-400"></span>
                <span class="text-text-secondary">Green (새 버전)</span>
              </div>
            </div>
            <p class="text-xs text-text-secondary mt-3">
              장점: 빠른 롤백 가능 | 단점: 리소스 2배 필요
            </p>
          </div>

          <div class="p-4 bg-purple-500/10 border border-purple-500/30 rounded-xl">
            <h3 class="text-white font-bold mb-2">Rolling 업데이트</h3>
            <p class="text-text-secondary text-sm mb-3">
              인스턴스를 순차적으로 교체합니다. Cloud Run의 기본 전략입니다.
            </p>
            <div class="flex items-center gap-2 text-sm">
              <span class="px-2 py-1 rounded bg-blue-500/30 text-blue-300">v1</span>
              <span class="px-2 py-1 rounded bg-blue-500/30 text-blue-300">v1</span>
              <span class="px-2 py-1 rounded bg-green-500/30 text-green-300">v2</span>
              <span class="text-text-secondary">→</span>
              <span class="px-2 py-1 rounded bg-blue-500/30 text-blue-300">v1</span>
              <span class="px-2 py-1 rounded bg-green-500/30 text-green-300">v2</span>
              <span class="px-2 py-1 rounded bg-green-500/30 text-green-300">v2</span>
              <span class="text-text-secondary">→</span>
              <span class="px-2 py-1 rounded bg-green-500/30 text-green-300">v2</span>
              <span class="px-2 py-1 rounded bg-green-500/30 text-green-300">v2</span>
              <span class="px-2 py-1 rounded bg-green-500/30 text-green-300">v2</span>
            </div>
            <p class="text-xs text-text-secondary mt-3">
              장점: 리소스 효율적 | 단점: 롤백이 새 배포와 동일
            </p>
          </div>
        </div>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">롤백 방법</h3>

        <CodeBlock
          client:load
          code={`# Cloud Run에서 이전 버전으로 롤백
gcloud run services update-traffic my-api \\
  --to-revisions=my-api-00001-abc=100 \\
  --region=asia-northeast3

# Cloudflare Pages 롤백 (대시보드에서)
# Deployments → 이전 배포 → Rollback to this deploy`}
          filename="터미널"
        />
      </section>

      <!-- 모니터링 기초 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">모니터링 기초</h2>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">로그 수집</h3>

        <p class="text-text-secondary mb-4">
          Cloud Run은 자동으로 <strong class="text-white">Cloud Logging</strong>에 로그를 수집합니다.
        </p>

        <CodeBlock
          client:load
          code={`# FastAPI에서 구조화된 로그 출력
import logging
import json

logger = logging.getLogger(__name__)

@app.get("/api/users/{user_id}")
def get_user(user_id: int):
    logger.info(json.dumps({
        "action": "get_user",
        "user_id": user_id,
        "status": "success"
    }))
    return {"id": user_id}`}
          filename="main.py"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">핵심 메트릭</h3>

        <div class="grid md:grid-cols-2 gap-4 mb-6">
          <div class="p-4 bg-surface border border-border rounded-xl">
            <h4 class="text-white font-bold mb-2">응답 시간</h4>
            <p class="text-text-secondary text-sm">p50, p95, p99 확인</p>
            <p class="text-xs text-green-400 mt-1">목표: p95 &lt; 200ms</p>
          </div>
          <div class="p-4 bg-surface border border-border rounded-xl">
            <h4 class="text-white font-bold mb-2">에러율</h4>
            <p class="text-text-secondary text-sm">5xx 에러 비율</p>
            <p class="text-xs text-green-400 mt-1">목표: &lt; 0.1%</p>
          </div>
          <div class="p-4 bg-surface border border-border rounded-xl">
            <h4 class="text-white font-bold mb-2">요청 수</h4>
            <p class="text-text-secondary text-sm">분당/시간당 요청</p>
            <p class="text-xs text-text-secondary mt-1">트래픽 패턴 파악</p>
          </div>
          <div class="p-4 bg-surface border border-border rounded-xl">
            <h4 class="text-white font-bold mb-2">리소스 사용량</h4>
            <p class="text-text-secondary text-sm">CPU, 메모리</p>
            <p class="text-xs text-text-secondary mt-1">스케일링 기준</p>
          </div>
        </div>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">알림 설정</h3>

        <CodeBlock
          client:load
          code={`# GCP에서 알림 정책 생성 (CLI)
gcloud alpha monitoring policies create \\
  --display-name="High Error Rate Alert" \\
  --condition-display-name="Error rate > 1%" \\
  --condition-filter='resource.type="cloud_run_revision" AND metric.type="run.googleapis.com/request_count"'`}
          filename="터미널 (예시)"
        />

        <Callout client:load variant="tip" title="알림 채널 추천">
          <ul class="list-disc list-inside mt-2 text-sm space-y-1">
            <li><strong class="text-white">Slack</strong>: 팀 채널로 즉시 알림</li>
            <li><strong class="text-white">Email</strong>: 일일 요약 리포트</li>
            <li><strong class="text-white">PagerDuty</strong>: 긴급 장애 시 온콜 호출</li>
          </ul>
        </Callout>
      </section>

      <!-- 장애 대응 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">장애 대응</h2>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">인시던트 대응 프로세스</h3>

        <div class="space-y-3">
          <div class="flex items-start gap-3 p-3 bg-surface border border-border rounded-lg">
            <span class="flex items-center justify-center w-6 h-6 rounded-full bg-red-500 text-white text-xs font-bold shrink-0">1</span>
            <div>
              <h4 class="text-white font-bold">감지</h4>
              <p class="text-text-secondary text-sm">모니터링 알림 또는 사용자 신고</p>
            </div>
          </div>
          <div class="flex items-start gap-3 p-3 bg-surface border border-border rounded-lg">
            <span class="flex items-center justify-center w-6 h-6 rounded-full bg-orange-500 text-white text-xs font-bold shrink-0">2</span>
            <div>
              <h4 class="text-white font-bold">분류</h4>
              <p class="text-text-secondary text-sm">심각도 판단 (Critical/High/Medium/Low)</p>
            </div>
          </div>
          <div class="flex items-start gap-3 p-3 bg-surface border border-border rounded-lg">
            <span class="flex items-center justify-center w-6 h-6 rounded-full bg-yellow-500 text-white text-xs font-bold shrink-0">3</span>
            <div>
              <h4 class="text-white font-bold">완화</h4>
              <p class="text-text-secondary text-sm">롤백, 스케일 업, 트래픽 차단 등</p>
            </div>
          </div>
          <div class="flex items-start gap-3 p-3 bg-surface border border-border rounded-lg">
            <span class="flex items-center justify-center w-6 h-6 rounded-full bg-blue-500 text-white text-xs font-bold shrink-0">4</span>
            <div>
              <h4 class="text-white font-bold">해결</h4>
              <p class="text-text-secondary text-sm">근본 원인 파악 및 수정</p>
            </div>
          </div>
          <div class="flex items-start gap-3 p-3 bg-surface border border-border rounded-lg">
            <span class="flex items-center justify-center w-6 h-6 rounded-full bg-green-500 text-white text-xs font-bold shrink-0">5</span>
            <div>
              <h4 class="text-white font-bold">회고</h4>
              <p class="text-text-secondary text-sm">포스트모템 작성, 재발 방지책 수립</p>
            </div>
          </div>
        </div>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">롤백 결정 기준</h3>

        <ul class="list-disc list-inside text-text-secondary space-y-2">
          <li>에러율이 <strong class="text-white">1% 이상</strong> 증가</li>
          <li>p95 응답시간이 <strong class="text-white">2배 이상</strong> 증가</li>
          <li>핵심 기능이 <strong class="text-white">5분 이상</strong> 장애</li>
          <li>수정 예상 시간이 <strong class="text-white">15분 이상</strong></li>
        </ul>
      </section>

      <!-- 비용 관리 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">비용 관리</h2>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">무료 티어 활용</h3>

        <div class="overflow-x-auto mb-6">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-border">
                <th class="text-left py-3 px-3 text-white">서비스</th>
                <th class="text-left py-3 px-3 text-white">무료 제공량</th>
              </tr>
            </thead>
            <tbody>
              <tr class="border-b border-border/50">
                <td class="py-3 px-3 text-text-secondary">Cloudflare Pages</td>
                <td class="py-3 px-3 text-green-400">무제한 요청, 500회/월 빌드</td>
              </tr>
              <tr class="border-b border-border/50">
                <td class="py-3 px-3 text-text-secondary">Cloud Run</td>
                <td class="py-3 px-3 text-green-400">200만 요청/월, 180,000 vCPU-초/월</td>
              </tr>
              <tr class="border-b border-border/50">
                <td class="py-3 px-3 text-text-secondary">Supabase</td>
                <td class="py-3 px-3 text-green-400">500MB DB, 1GB 스토리지</td>
              </tr>
              <tr>
                <td class="py-3 px-3 text-text-secondary">Neon</td>
                <td class="py-3 px-3 text-green-400">0.5GB 스토리지, 191시간/월 컴퓨팅</td>
              </tr>
            </tbody>
          </table>
        </div>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">비용 알림 설정</h3>

        <CodeBlock
          client:load
          code={`# GCP 예산 알림 설정 (콘솔에서)
# 1. 빌링 → 예산 및 알림 → 예산 만들기
# 2. 월 $10, $50, $100 등 임계값 설정
# 3. 50%, 90%, 100% 도달 시 이메일 알림`}
          filename="비용 알림"
        />

        <Callout client:load variant="warning" title="예상치 못한 비용 주의">
          <ul class="list-disc list-inside mt-2 text-sm space-y-1">
            <li>데이터 전송(Egress) 비용이 의외로 큼</li>
            <li>로그 저장 비용도 무시 못 함</li>
            <li>개발용 인스턴스 끄는 것 잊지 말기</li>
          </ul>
        </Callout>
      </section>

      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">운영 런북 확장</h2>
        <div class="grid md:grid-cols-2 gap-4">
          <a href="/map/ops/release-rollback" class="p-4 bg-surface border border-border rounded-lg hover:border-primary/50 transition-colors no-underline">
            <h3 class="text-white font-bold mb-1">릴리즈/롤백 런북</h3>
            <p class="text-text-secondary text-sm">배포 전 게이트와 롤백 트리거 표준화</p>
          </a>
          <a href="/recipes/review-pr-quality" class="p-4 bg-surface border border-border rounded-lg hover:border-primary/50 transition-colors no-underline">
            <h3 class="text-white font-bold mb-1">PR 품질 점검 레시피</h3>
            <p class="text-text-secondary text-sm">회귀 위험 중심 사전 점검</p>
          </a>
        </div>
      </section>

      <!-- 마무리 -->
      <section class="mb-10">
        <Callout client:load variant="info" title="축하합니다!">
          <p class="text-sm">
            모든 학습 사이클을 완료했습니다! 이제 웹 서비스를 만들고 배포하고 운영하는
            기본기를 갖추었습니다.
            <a href="/recipes" class="text-primary hover:underline ml-1">Agent Recipes</a>를
            활용해서 실제 프로젝트를 시작해보세요.
          </p>
        </Callout>
      </section>
    </article>

    <PageNavigation currentPath="/map/ops" />
  </div>
</DocsLayout>
