---
import DocsLayout from '../../../layouts/DocsLayout.astro';
import Callout from '../../../components/Callout';
import CodeBlock from '../../../components/CodeBlock';
import PageNavigation from '../../../components/PageNavigation.astro';

// Code blocks defined as variables to avoid esbuild parsing issues
const terminalSetup = `# .NET SDK 설치 확인
dotnet --version

# 프로젝트 생성
dotnet new webapi -n my-api --no-https
cd my-api`;

const programCode = `using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Http;

var builder = WebApplication.CreateBuilder(args);

// CORS 설정
builder.Services.AddCors(options =>
{
    options.AddDefaultPolicy(policy =>
    {
        policy.WithOrigins("http://localhost:5173")
              .AllowAnyHeader()
              .AllowAnyMethod()
              .AllowCredentials();
    });
});

var app = builder.Build();
app.UseCors();

app.MapGet("/health", () => Results.Ok(new { status = "healthy" }));

app.MapGet("/api/hello", (string? name) =>
    Results.Ok(new { message = \$"Hello, {name ?? "World"}!" }));

app.Run();`;

const crudCode = `using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Http;

// 모델 정의
record Project(Guid Id, string Name, string Description, DateTime CreatedAt);

var builder = WebApplication.CreateBuilder(args);
builder.Services.AddCors();
var app = builder.Build();
app.UseCors();

// In-memory 저장소
var projects = new List<Project>();
var lockObj = new object();

var api = app.MapGroup("/api/v1/projects");

// 목록 조회
api.MapGet("/", () =>
{
    lock (lockObj)
    {
        return Results.Ok(new { items = projects, total = projects.Count });
    }
});

// 단건 조회
api.MapGet("/{id:guid}", (Guid id) =>
{
    lock (lockObj)
    {
        var project = projects.FirstOrDefault(p => p.Id == id);
        return project is not null
            ? Results.Ok(project)
            : Results.NotFound(new { error = "not found" });
    }
});

// 생성
api.MapPost("/", (CreateProjectRequest req) =>
{
    var project = new Project(
        Guid.NewGuid(),
        req.Name,
        req.Description,
        DateTime.UtcNow
    );

    lock (lockObj)
    {
        projects.Add(project);
    }

    return Results.Created(\$"/api/v1/projects/{project.Id}", project);
});

// 수정
api.MapPut("/{id:guid}", (Guid id, UpdateProjectRequest req) =>
{
    lock (lockObj)
    {
        var index = projects.FindIndex(p => p.Id == id);
        if (index == -1)
            return Results.NotFound(new { error = "not found" });

        projects[index] = projects[index] with
        {
            Name = req.Name,
            Description = req.Description
        };

        return Results.Ok(projects[index]);
    }
});

// 삭제
api.MapDelete("/{id:guid}", (Guid id) =>
{
    lock (lockObj)
    {
        var removed = projects.RemoveAll(p => p.Id == id);
        return removed > 0
            ? Results.NoContent()
            : Results.NotFound(new { error = "not found" });
    }
});

app.Run();

// Request DTOs
record CreateProjectRequest(string Name, string Description);
record UpdateProjectRequest(string Name, string Description);`;

const terminalRun = `dotnet run

# 테스트 (새 터미널에서)
curl http://localhost:5000/health
curl "http://localhost:5000/api/hello?name=Choorai"`;

const dockerfileCode = `# Build stage
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src
COPY *.csproj .
RUN dotnet restore
COPY . .
RUN dotnet publish -c Release -o /app

# Runtime stage
FROM mcr.microsoft.com/dotnet/aspnet:8.0-alpine
WORKDIR /app
COPY --from=build /app .
ENV ASPNETCORE_URLS=http://+:8080
EXPOSE 8080
ENTRYPOINT ["dotnet", "my-api.dll"]`;

const deployCode = `# 로컬 테스트
docker build -t my-dotnet-api .
docker run -p 8080:8080 my-dotnet-api

# 이미지 크기 확인 (~100MB)
docker images my-dotnet-api

# Cloud Run 배포
gcloud run deploy my-dotnet-api \\
  --source . \\
  --region asia-northeast3 \\
  --allow-unauthenticated \\
  --min-instances 0 \\
  --max-instances 1`;
---

<DocsLayout
  title=".NET (Minimal API) - Lv.3 실무"
  description="대기업/금융/게임 분야 표준, 강력한 타입 시스템의 ASP.NET Core 백엔드"
  currentPath="/map/backend/dotnet"
>
  <div class="max-w-4xl mx-auto px-6 py-8">
    <nav class="flex items-center gap-2 text-sm text-text-secondary mb-6" aria-label="현재 위치">
      <a href="/" class="hover:text-white transition-colors">홈</a>
      <span>/</span>
      <a href="/map/backend" class="hover:text-white transition-colors">Backend 배포</a>
      <span>/</span>
      <span class="text-primary font-medium">.NET</span>
    </nav>

    <header class="mb-8 pb-6 border-b border-border">
      <div class="flex items-center gap-2 mb-4">
        <span class="px-3 py-1 rounded-full bg-orange-500/10 text-orange-400 text-xs font-bold">Lv.3 실무</span>
        <span class="px-3 py-1 rounded-full bg-surface text-text-secondary text-xs">C#</span>
        <span class="px-3 py-1 rounded-full bg-surface text-text-secondary text-xs">ASP.NET Core</span>
      </div>
      <h1 class="text-3xl md:text-4xl font-black text-white mb-4">
        ASP.NET Core로 실무 백엔드 만들기
      </h1>
      <p class="text-text-secondary text-lg leading-relaxed">
        ASP.NET Core는 Microsoft의 크로스 플랫폼 웹 프레임워크로,
        대기업, 금융, 게임 분야에서 널리 사용됩니다. Minimal API 스타일로 간결하면서도
        강력한 타입 시스템과 높은 성능(Kestrel)을 제공합니다.
      </p>
    </header>

    <section class="mb-10">
      <Callout client:load variant="tip" title="왜 .NET인가?">
        <ul class="list-disc list-inside space-y-1 mt-2">
          <li>대기업/금융/게임 분야의 산업 표준</li>
          <li>강력한 정적 타입 시스템 (C#)</li>
          <li>높은 성능 (Kestrel 웹 서버)</li>
          <li>크로스 플랫폼 (Windows, Linux, macOS)</li>
          <li>풍부한 현업 레퍼런스와 Microsoft 지원</li>
        </ul>
      </Callout>
    </section>

    <article class="prose prose-invert max-w-none">
      <!-- 프로젝트 생성 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">1. 프로젝트 생성</h2>

        <CodeBlock
          client:load
          code={terminalSetup}
          filename="터미널"
        />

        <p class="text-text-secondary mt-4">
          <code class="bg-surface px-1 rounded">dotnet new webapi</code>는 ASP.NET Core Web API 프로젝트를 생성합니다.
          <code class="bg-surface px-1 rounded">--no-https</code> 옵션으로 로컬 개발 시 HTTPS를 비활성화합니다.
        </p>
      </section>

      <!-- 첫 API -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">2. 첫 API 작성</h2>

        <CodeBlock
          client:load
          code={programCode}
          filename="Program.cs"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">실행</h3>

        <CodeBlock
          client:load
          code={terminalRun}
          filename="터미널"
        />
      </section>

      <!-- CRUD API -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">3. CRUD API 추가</h2>

        <CodeBlock
          client:load
          code={crudCode}
          filename="Program.cs"
        />

        <Callout client:load variant="info" title="Minimal API와 record 타입">
          <p class="text-sm mt-1">
            C#의 <code class="bg-surface px-1 rounded">record</code> 타입은 불변 데이터 객체를 간결하게 정의합니다.
            <code class="bg-surface px-1 rounded">with</code> 표현식으로 특정 필드만 변경한 새 인스턴스를 생성할 수 있습니다.
          </p>
        </Callout>
      </section>

      <!-- Docker 배포 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">4. Docker로 배포</h2>

        <CodeBlock
          client:load
          code={dockerfileCode}
          filename="Dockerfile"
        />

        <p class="text-text-secondary mt-4 mb-4">
          멀티스테이지 빌드로 SDK(~700MB)에서 런타임(~100MB)으로 줄입니다.
          Alpine 기반 이미지를 사용하여 크기를 최소화합니다.
        </p>

        <CodeBlock
          client:load
          code={deployCode}
          filename="터미널"
        />
      </section>

      <!-- 비교 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">프레임워크 비교</h2>

        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-border">
                <th class="text-left py-3 px-2 text-white">항목</th>
                <th class="text-left py-3 px-2 text-white">.NET (Minimal API)</th>
                <th class="text-left py-3 px-2 text-white">Go (Chi)</th>
                <th class="text-left py-3 px-2 text-white">FastAPI</th>
              </tr>
            </thead>
            <tbody class="text-text-secondary">
              <tr class="border-b border-border/50">
                <td class="py-3 px-2">이미지 크기</td>
                <td class="py-3 px-2 text-yellow-400">~100MB</td>
                <td class="py-3 px-2 text-green-400">~15MB</td>
                <td class="py-3 px-2">~200MB</td>
              </tr>
              <tr class="border-b border-border/50">
                <td class="py-3 px-2">Cold Start</td>
                <td class="py-3 px-2 text-yellow-400">~200ms</td>
                <td class="py-3 px-2 text-green-400">~100ms</td>
                <td class="py-3 px-2">~500ms</td>
              </tr>
              <tr class="border-b border-border/50">
                <td class="py-3 px-2">메모리 사용</td>
                <td class="py-3 px-2 text-yellow-400">~40MB</td>
                <td class="py-3 px-2 text-green-400">~20MB</td>
                <td class="py-3 px-2">~80MB</td>
              </tr>
              <tr class="border-b border-border/50">
                <td class="py-3 px-2">학습 곡선</td>
                <td class="py-3 px-2 text-yellow-400">중간</td>
                <td class="py-3 px-2 text-yellow-400">중간</td>
                <td class="py-3 px-2 text-green-400">쉬움</td>
              </tr>
              <tr>
                <td class="py-3 px-2">타입 시스템</td>
                <td class="py-3 px-2 text-green-400">정적</td>
                <td class="py-3 px-2 text-green-400">정적</td>
                <td class="py-3 px-2">동적</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- 언제 사용? -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">언제 .NET을 선택할까?</h2>

        <div class="grid md:grid-cols-2 gap-4">
          <div class="p-4 bg-orange-500/10 border border-orange-500/30 rounded-xl">
            <h3 class="text-orange-400 font-bold mb-2">.NET 추천</h3>
            <ul class="text-text-secondary text-sm space-y-1">
              <li>-- 대기업/금융 시스템 구축</li>
              <li>-- 강력한 타입 안전성이 필요한 경우</li>
              <li>-- Windows 서버 환경 또는 Azure 인프라</li>
              <li>-- 게임 서버 (Unity 연동)</li>
            </ul>
          </div>
          <div class="p-4 bg-surface border border-border rounded-xl">
            <h3 class="text-white font-bold mb-2">다른 선택 고려</h3>
            <ul class="text-text-secondary text-sm space-y-1">
              <li>최소 이미지 크기 → <a href="/map/backend/go" class="text-primary">Go</a></li>
              <li>빠른 프로토타입 → <a href="/map/backend/hono" class="text-primary">Hono</a></li>
              <li>엔터프라이즈 구조 → <a href="/map/backend/nest" class="text-primary">NestJS</a></li>
            </ul>
          </div>
        </div>
      </section>
    </article>

    <PageNavigation currentPath="/map/backend/dotnet" />
  </div>
</DocsLayout>
