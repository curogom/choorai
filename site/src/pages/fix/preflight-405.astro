---
import DocsLayout from '../../layouts/DocsLayout.astro';
import ErrorCard from '../../components/ErrorCard';
import CodeBlock from '../../components/CodeBlock';
import Callout from '../../components/Callout';
import TroubleshootingTemplate from '../../components/TroubleshootingTemplate.astro';

const faqStructuredData = {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: [
    {
      '@type': 'Question',
      name: 'CORS Preflight 405는 왜 발생하나요?',
      acceptedAnswer: {
        '@type': 'Answer',
        text: '브라우저의 OPTIONS 사전 요청을 서버 또는 프록시가 허용하지 않아 405 Method Not Allowed를 반환할 때 발생합니다.',
      },
    },
    {
      '@type': 'Question',
      name: '무엇을 먼저 수정해야 하나요?',
      acceptedAnswer: {
        '@type': 'Answer',
        text: '라우터보다 먼저 CORS 미들웨어를 적용하고 OPTIONS 요청이 200/204로 응답되도록 설정하세요.',
      },
    },
  ],
};
---

<DocsLayout
  title="CORS Preflight 405 해결하기"
  description="OPTIONS preflight 요청이 405로 실패하는 문제 해결"
  currentPath="/fix/preflight-405"
  structuredData={[faqStructuredData]}
>
  <div class="max-w-4xl mx-auto px-6 py-8">
    <nav class="flex items-center gap-2 text-sm text-text-secondary mb-6" aria-label="현재 위치">
      <a href="/" class="hover:text-white transition-colors">홈</a>
      <span>/</span>
      <a href="/fix" class="hover:text-white transition-colors">트러블슈팅</a>
      <span>/</span>
      <span class="text-primary font-medium">Preflight 405</span>
    </nav>

    <header class="mb-8 pb-6 border-b border-border">
      <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-error/10 text-error text-xs font-bold mb-4">
        CORS 사전 요청 실패
      </div>
      <h1 class="text-3xl md:text-4xl font-black text-white mb-4">
        CORS Preflight 405 해결하기
      </h1>
      <p class="text-text-secondary text-lg leading-relaxed">
        실제 API 호출 전에 보내는 <code class="bg-surface px-1 rounded">OPTIONS</code> 요청이
        <code class="bg-surface px-1 rounded">405 Method Not Allowed</code>로 실패하면 본요청도 실패합니다.
      </p>
    </header>

    <section class="mb-8">
      <Callout client:load variant="tip" title="TL;DR (핵심 요약)">
        <p class="mt-2">
          1) Network 탭에서 OPTIONS 응답코드 확인
          2) CORS 미들웨어 순서를 라우터 앞에 배치
          3) Access-Control-Allow-Methods/Headers 검증
        </p>
      </Callout>
    </section>

    <section class="mb-8 space-y-6">
      <ErrorCard
        client:load
        errorMessage="Response to preflight request doesn't pass access control check: It does not have HTTP ok status"
        severity="warning"
        cause="브라우저 preflight OPTIONS 요청이 405 또는 4xx로 차단되어 CORS 검증에 실패했습니다."
        solution={[
          '서버에서 OPTIONS 메서드 허용',
          'CORS 미들웨어를 라우팅보다 먼저 적용',
          '허용 메서드/헤더/오리진 명시',
          '프록시/WAF가 OPTIONS를 막지 않는지 확인'
        ]}
        aiPrompt="FastAPI API에서 preflight OPTIONS가 405로 실패해. CORS 미들웨어 순서와 설정값을 어떻게 점검할지 알려줘."
      />
    </section>

    <article class="prose prose-invert max-w-none">
      <h2 class="text-2xl font-bold text-white mb-4">설정 예시</h2>

      <section class="mb-8">
        <CodeBlock
          client:load
          filename="FastAPI"
          code={`from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

app = FastAPI()

app.add_middleware(
  CORSMiddleware,
  allow_origins=["https://app.example.com"],
  allow_credentials=True,
  allow_methods=["*"],
  allow_headers=["*"],
)`}
        />
      </section>

      <section class="mb-8">
        <CodeBlock
          client:load
          filename="Express"
          code={`import express from 'express';
import cors from 'cors';

const app = express();

app.use(cors({
  origin: 'https://app.example.com',
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS'],
}));`}
        />
      </section>

      <section class="mb-8">
        <Callout client:load variant="warning" title="주의">
          <p class="mt-2">
            <code class="bg-surface px-1 rounded">allow_origins=['*']</code>와
            <code class="bg-surface px-1 rounded">allow_credentials=true</code> 조합은 함께 사용할 수 없습니다.
          </p>
        </Callout>
      </section>
    </article>

    <TroubleshootingTemplate topic="preflight-405" />

    <section class="mt-12 pt-8 border-t border-border">
      <h3 class="text-lg font-bold text-white mb-4">관련 문서</h3>
      <div class="grid md:grid-cols-2 gap-4">
        <a href="/fix/cors" class="p-4 bg-surface border border-border rounded-lg hover:border-primary/50 transition-colors no-underline">
          <h4 class="text-white font-medium mb-1">CORS 에러</h4>
          <p class="text-text-secondary text-sm">기본 CORS 설정 문제 해결</p>
        </a>
        <a href="/fix/failed-to-fetch" class="p-4 bg-surface border border-border rounded-lg hover:border-primary/50 transition-colors no-underline">
          <h4 class="text-white font-medium mb-1">Failed to fetch</h4>
          <p class="text-text-secondary text-sm">클라이언트 요청 실패 분리 진단</p>
        </a>
      </div>
    </section>
  </div>
</DocsLayout>
