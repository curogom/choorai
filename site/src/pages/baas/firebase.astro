---
import DocsLayout from '../../layouts/DocsLayout.astro';
import Callout from '../../components/Callout';
import CodeBlock from '../../components/CodeBlock';
import SectionHeader from '../../components/SectionHeader';
import MetaBadge from '../../components/MetaBadge';
import PageNavigation from '../../components/PageNavigation.astro';

const firestoreRules = `rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /todos/{todoId} {
      allow read, write: if request.auth != null
        && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.userId;
    }
  }
}`;

const firebaseConfig = `// src/lib/firebase.ts
import { initializeApp } from 'firebase/app';
import { getFirestore } from 'firebase/firestore';
import { getAuth } from 'firebase/auth';

const firebaseConfig = {
  apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
  authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.VITE_FIREBASE_APP_ID,
};

const app = initializeApp(firebaseConfig);
export const db = getFirestore(app);
export const auth = getAuth(app);`;

const envVars = `# .env.local
VITE_FIREBASE_API_KEY=your-api-key
VITE_FIREBASE_AUTH_DOMAIN=your-project.firebaseapp.com
VITE_FIREBASE_PROJECT_ID=your-project-id
VITE_FIREBASE_STORAGE_BUCKET=your-project.appspot.com
VITE_FIREBASE_MESSAGING_SENDER_ID=your-sender-id
VITE_FIREBASE_APP_ID=your-app-id`;

const useTodosCode = `// src/hooks/useTodos.ts
import { useState, useEffect } from 'react';
import {
  collection,
  addDoc,
  getDocs,
  updateDoc,
  deleteDoc,
  doc,
  query,
  where,
  orderBy,
  onSnapshot,
  serverTimestamp,
} from 'firebase/firestore';
import { db, auth } from '../lib/firebase';

interface Todo {
  id: string;
  title: string;
  completed: boolean;
  userId: string;
  createdAt: any;
}

export function useTodos() {
  const [todos, setTodos] = useState<Todo[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const user = auth.currentUser;
    if (!user) return;

    const q = query(
      collection(db, 'todos'),
      where('userId', '==', user.uid),
      orderBy('createdAt', 'desc')
    );

    // 실시간 구독
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const items = snapshot.docs.map((doc) => ({
        id: doc.id,
        ...doc.data(),
      })) as Todo[];
      setTodos(items);
      setLoading(false);
    });

    return () => unsubscribe();
  }, []);

  // 생성
  const addTodo = async (title: string) => {
    const user = auth.currentUser;
    if (!user) throw new Error('Not authenticated');

    await addDoc(collection(db, 'todos'), {
      title,
      completed: false,
      userId: user.uid,
      createdAt: serverTimestamp(),
    });
  };

  // 수정
  const toggleTodo = async (id: string, completed: boolean) => {
    await updateDoc(doc(db, 'todos', id), { completed });
  };

  // 삭제
  const removeTodo = async (id: string) => {
    await deleteDoc(doc(db, 'todos', id));
  };

  return { todos, loading, addTodo, toggleTodo, removeTodo };
}`;

const useAuthCode = `// src/hooks/useAuth.ts
import { useState, useEffect } from 'react';
import {
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut as firebaseSignOut,
  onAuthStateChanged,
  User,
} from 'firebase/auth';
import { auth } from '../lib/firebase';

export function useAuth() {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (user) => {
      setUser(user);
      setLoading(false);
    });

    return () => unsubscribe();
  }, []);

  // 회원가입
  const signUp = async (email: string, password: string) => {
    const { user } = await createUserWithEmailAndPassword(
      auth, email, password
    );
    return user;
  };

  // 로그인
  const signIn = async (email: string, password: string) => {
    const { user } = await signInWithEmailAndPassword(
      auth, email, password
    );
    return user;
  };

  // 로그아웃
  const signOut = async () => {
    await firebaseSignOut(auth);
  };

  return { user, loading, signUp, signIn, signOut };
}`;
---

<DocsLayout
  title="Firebase 시작하기 (Lv.2)"
  description="Firebase로 백엔드 없이 데이터베이스와 인증을 구현하는 방법"
  currentPath="/baas/firebase"
>
  <div class="max-w-4xl mx-auto px-6 py-8">
    <nav class="flex items-center gap-2 text-sm text-text-secondary mb-6" aria-label="현재 위치">
      <a href="/" class="hover:text-white transition-colors">홈</a>
      <span>/</span>
      <span class="text-primary font-medium">BaaS</span>
      <span>/</span>
      <span class="text-primary font-medium">Firebase</span>
    </nav>

    <header class="mb-8 pb-6 border-b border-border">
      <div class="flex items-center gap-2 mb-4">
        <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-500/10 text-blue-400 text-xs font-bold">
          Lv.2
        </span>
        <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-orange-500/10 text-orange-400 text-xs font-bold">
          BaaS
        </span>
      </div>
      <h1 class="text-3xl md:text-4xl font-black text-white mb-4">
        Firebase 시작하기
      </h1>
      <p class="text-text-secondary text-lg leading-relaxed">
        <strong class="text-white">Backend-as-a-Service</strong>로 별도 백엔드 서버 없이
        NoSQL 데이터베이스와 인증을 사용할 수 있습니다.
      </p>
    </header>

    <section class="mb-10">
      <Callout client:load variant="tip" title="Firebase란?">
        <ul class="list-disc list-inside space-y-1 mt-2">
          <li><strong class="text-white">Firestore</strong> - NoSQL 실시간 데이터베이스</li>
          <li><strong class="text-white">Auth</strong> - 이메일/소셜 로그인 내장</li>
          <li><strong class="text-white">Cloud Storage</strong> - 파일 저장 및 관리</li>
          <li><strong class="text-white">Hosting</strong> - 정적 사이트 배포</li>
          <li><strong class="text-white">Cloud Functions</strong> - 서버리스 함수 실행</li>
          <li><strong class="text-white">무료 티어</strong> - Spark 플랜 무제한 프로젝트</li>
        </ul>
      </Callout>
    </section>

    <article class="prose prose-invert max-w-none">
      <!-- Step 1: 프로젝트 생성 -->
      <section class="mb-10">
        <SectionHeader number={1} title="Firebase 프로젝트 생성" />

        <ol class="list-decimal list-inside text-text-secondary space-y-3 mb-4">
          <li>
            <a href="https://console.firebase.google.com" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">
              console.firebase.google.com
            </a>에서 Google 계정으로 로그인
          </li>
          <li><strong class="text-white">프로젝트 추가</strong> 클릭</li>
          <li>프로젝트 이름 입력</li>
          <li>Google Analytics 설정 (선택 사항)</li>
          <li><strong class="text-white">프로젝트 만들기</strong> 클릭</li>
          <li>프로젝트 생성 후 <strong class="text-white">웹 앱 추가</strong> (&#60;/&#62; 아이콘) 클릭하여 SDK 설정 정보 확인</li>
        </ol>

        <Callout client:load variant="info">
          <p>프로젝트 생성 후 대시보드에서 <strong class="text-white">프로젝트 설정</strong>에 들어가면 API 키와 설정 정보를 확인할 수 있습니다.</p>
        </Callout>
      </section>

      <!-- Step 2: Firestore 데이터베이스 설정 -->
      <section class="mb-10">
        <SectionHeader number={2} title="Firestore 데이터베이스 설정" />

        <p class="text-text-secondary mb-4">
          대시보드에서 <strong class="text-white">Firestore Database</strong>를 선택하고 데이터베이스를 생성하세요.
        </p>

        <ol class="list-decimal list-inside text-text-secondary space-y-3 mb-4">
          <li><strong class="text-white">데이터베이스 만들기</strong> 클릭</li>
          <li>프로덕션 모드 또는 테스트 모드 선택</li>
          <li>리전 선택: <code class="bg-surface px-1 rounded">asia-northeast3 (Seoul)</code> 추천</li>
        </ol>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">보안 규칙 설정</h3>

        <p class="text-text-secondary mb-4">
          <strong class="text-white">Firestore</strong> → <strong class="text-white">규칙</strong> 탭에서 아래 보안 규칙을 적용하세요.
        </p>

        <CodeBlock
          client:load
          code={firestoreRules}
          filename="Firestore Rules"
        />

        <Callout client:load variant="warning" title="보안 규칙이 중요한 이유">
          <p class="text-sm mt-2">
            보안 규칙 없이는 <strong class="text-white">모든 사용자가 모든 데이터에 접근</strong>할 수 있습니다.
            <code class="bg-surface px-1 rounded">request.auth.uid</code>로 현재 로그인한 사용자만 자신의 데이터에 접근하도록 제한하세요.
          </p>
        </Callout>
      </section>

      <!-- Step 3: 클라이언트 설정 -->
      <section class="mb-10">
        <SectionHeader number={3} title="클라이언트 설정 (React)" />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">의존성 설치</h3>

        <CodeBlock
          client:load
          code={`npm install firebase`}
          filename="터미널"
        />

        <h3 class="text-lg font-bold text-white mt-6 mb-3">환경 변수 설정</h3>

        <CodeBlock
          client:load
          code={envVars}
          filename=".env.local"
        />

        <p class="text-text-secondary text-sm mt-2 mb-4">
          Firebase 콘솔 → <strong class="text-white">프로젝트 설정</strong> → <strong class="text-white">일반</strong> → <strong class="text-white">내 앱</strong>에서 확인하세요.
        </p>

        <h3 class="text-lg font-bold text-white mt-6 mb-3">Firebase 클라이언트</h3>

        <CodeBlock
          client:load
          code={firebaseConfig}
          filename="src/lib/firebase.ts"
        />
      </section>

      <!-- Step 4: CRUD 예제 -->
      <section class="mb-10">
        <SectionHeader number={4} title="CRUD 예제 (React + Firestore)" />

        <p class="text-text-secondary mb-4">
          Firestore의 실시간 구독(<code class="bg-surface px-1 rounded">onSnapshot</code>)을 활용한 Todo 앱 예제입니다.
        </p>

        <CodeBlock
          client:load
          code={useTodosCode}
          filename="src/hooks/useTodos.ts"
        />
      </section>

      <!-- Step 5: 인증 예제 -->
      <section class="mb-10">
        <SectionHeader number={5} title="인증 예제 (선택)" />

        <p class="text-text-secondary mb-4">
          Firebase Auth를 사용하면 이메일/비밀번호 로그인을 쉽게 구현할 수 있습니다.
        </p>

        <CodeBlock
          client:load
          code={useAuthCode}
          filename="src/hooks/useAuth.ts"
        />

        <Callout client:load variant="info" title="소셜 로그인">
          <p class="text-sm">
            Google, GitHub, Facebook 등 소셜 로그인도 지원합니다.
            Firebase 콘솔 → <strong class="text-white">Authentication</strong> → <strong class="text-white">Sign-in method</strong>에서 설정하세요.
          </p>
        </Callout>
      </section>

      <!-- 언제 사용하면 좋을까 -->
      <section class="mb-10">
        <h2 class="text-2xl font-bold text-white mb-4">언제 Firebase를 사용하면 좋을까요?</h2>

        <div class="grid md:grid-cols-2 gap-4 mb-6">
          <div class="p-4 bg-green-500/10 border border-green-500/30 rounded-xl">
            <h3 class="text-white font-bold mb-2">추천하는 경우</h3>
            <ul class="text-text-secondary text-sm space-y-1">
              <li>- 빠르게 프로토타입을 만들 때</li>
              <li>- 실시간 데이터 동기화가 필요할 때</li>
              <li>- 모바일 앱과 웹을 동시에 지원할 때</li>
              <li>- Google 생태계와 연동이 필요할 때</li>
            </ul>
          </div>
          <div class="p-4 bg-red-500/10 border border-red-500/30 rounded-xl">
            <h3 class="text-white font-bold mb-2">고려가 필요한 경우</h3>
            <ul class="text-text-secondary text-sm space-y-1">
              <li>- 복잡한 관계형 쿼리가 필요할 때</li>
              <li>- SQL 기반 데이터 분석이 중요할 때</li>
              <li>- 벤더 종속이 우려될 때</li>
              <li>- 대량 데이터 내보내기가 빈번할 때</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- 다음 단계 -->
      <section class="mb-10">
        <Callout client:load variant="info" title="다음 단계">
          <ul class="list-disc list-inside space-y-1 mt-2">
            <li><a href="/map/auth" class="text-primary hover:underline">인증 가이드</a> - JWT, Session, OAuth 비교</li>
            <li><a href="https://firebase.google.com/docs" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">Firebase 공식 문서</a> - 더 자세한 기능</li>
            <li><a href="/baas/supabase" class="text-primary hover:underline">Supabase 가이드</a> - SQL 기반 대안 비교</li>
          </ul>
        </Callout>
      </section>
    </article>

    <PageNavigation currentPath="/baas/firebase" />
  </div>
</DocsLayout>
