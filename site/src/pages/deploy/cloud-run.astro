---
import DocsLayout from '../../layouts/DocsLayout.astro';
import Callout from '../../components/Callout';
import CodeBlock from '../../components/CodeBlock';
import SectionHeader from '../../components/SectionHeader';
import MetaBadge from '../../components/MetaBadge';
---

<DocsLayout
  title="Cloud Run 배포 가이드"
  description="FastAPI 백엔드를 Google Cloud Run에 배포하는 방법"
  currentPath="/deploy/cloud-run"
>
  <div class="max-w-4xl mx-auto px-6 py-8">
    <nav class="flex items-center gap-2 text-sm text-text-secondary mb-6" aria-label="현재 위치">
      <a href="/" class="hover:text-white transition-colors">홈</a>
      <span>/</span>
      <a href="/deploy" class="hover:text-white transition-colors">배포</a>
      <span>/</span>
      <span class="text-primary font-medium">Cloud Run</span>
    </nav>

    <header class="mb-8 pb-6 border-b border-border">
      <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-500/10 text-blue-400 text-xs font-bold mb-4">
        Google Cloud
      </div>
      <h1 class="text-3xl md:text-4xl font-black text-white mb-4">
        Cloud Run 배포 가이드
      </h1>
      <p class="text-text-secondary text-lg leading-relaxed">
        FastAPI 백엔드를 Google Cloud Run에 배포하여 전 세계에서 접근 가능한 API를 만들어봅시다.
      </p>
    </header>

    <section class="mb-10">
      <Callout client:load variant="tip" title="TL;DR">
        <ul class="list-disc list-inside space-y-1 mt-2">
          <li>Dockerfile 작성</li>
          <li>Google Cloud 프로젝트 생성</li>
          <li><code>gcloud run deploy</code> 명령어로 배포</li>
        </ul>
      </Callout>
    </section>

    <article class="prose prose-invert max-w-none">
      <!-- 섹션 1: 사전 준비 -->
      <section class="mb-10">
        <SectionHeader number={1} title="사전 준비" />

        <p class="text-text-secondary mb-4">
          Cloud Run 배포에 필요한 것들:
        </p>

        <ul class="list-disc list-inside text-text-secondary space-y-2 mb-4">
          <li><a href="https://console.cloud.google.com" class="text-primary hover:underline">Google Cloud 계정</a> (무료 크레딧 $300 제공)</li>
          <li><a href="https://cloud.google.com/sdk/docs/install" class="text-primary hover:underline">Google Cloud CLI (gcloud)</a> 설치</li>
          <li>Docker (선택사항 - 로컬 테스트용)</li>
        </ul>
      </section>

      <!-- 섹션 2: Dockerfile -->
      <section class="mb-10">
        <SectionHeader number={2} title="Dockerfile 작성" />

        <p class="text-text-secondary mb-4">
          백엔드 폴더에 <code>Dockerfile</code>을 생성합니다:
        </p>

        <CodeBlock
          client:load
          code={`FROM python:3.11-slim

WORKDIR /app

# 의존성 설치
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 애플리케이션 복사
COPY . .

# Cloud Run은 PORT 환경변수를 사용
ENV PORT=8080
EXPOSE 8080

# 서버 실행
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8080"]`}
          filename="Dockerfile"
        />
      </section>

      <!-- 섹션 3: 배포 -->
      <section class="mb-10">
        <SectionHeader number={3} title="배포하기" />

        <CodeBlock
          client:load
          code={`# Google Cloud 로그인
gcloud auth login

# 프로젝트 설정 (YOUR_PROJECT_ID를 본인의 프로젝트 ID로 변경)
gcloud config set project YOUR_PROJECT_ID

# Cloud Run에 배포
gcloud run deploy my-admin-api \\
  --source . \\
  --region asia-northeast3 \\
  --allow-unauthenticated`}
          filename="터미널"
        />

        <p class="text-text-secondary mt-4">
          배포가 완료되면 <code>https://my-admin-api-xxxxx.run.app</code> 형태의 URL이 생성됩니다.
        </p>
      </section>

      <!-- 섹션 4: 프론트엔드 연결 -->
      <section class="mb-10">
        <SectionHeader number={4} title="프론트엔드 연결" />

        <p class="text-text-secondary mb-4">
          Cloudflare Pages의 환경변수에 백엔드 URL을 설정합니다:
        </p>

        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
          <div class="space-y-2">
            <div>
              <span class="text-gray-400 text-sm">Variable name</span>
              <div class="bg-gray-900 rounded px-3 py-2 mt-1 font-mono text-green-400">VITE_API_URL</div>
            </div>
            <div>
              <span class="text-gray-400 text-sm">Value</span>
              <div class="bg-gray-900 rounded px-3 py-2 mt-1 font-mono text-green-400">https://my-admin-api-xxxxx.run.app</div>
            </div>
          </div>
        </div>
      </section>

      <!-- 비용 안내 -->
      <section class="mb-10">
        <Callout client:load variant="info" title="비용 안내">
          <p class="text-sm">
            Cloud Run은 요청이 없을 때는 비용이 발생하지 않습니다 (scale to zero).
            무료 티어로 월 200만 건의 요청까지 무료입니다.
            <a href="https://cloud.google.com/run/pricing" class="text-primary hover:underline ml-1">자세한 가격 정책 →</a>
          </p>
        </Callout>
      </section>
    </article>

    <nav class="flex items-center justify-between pt-8 border-t border-border" aria-label="페이지 이동">
      <a
        href="/deploy/cloudflare-pages"
        class="group flex items-center gap-3 px-4 py-2 rounded-lg border border-border hover:bg-surface transition-colors no-underline"
      >
        <svg class="w-5 h-5 text-text-secondary group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        <div class="text-left">
          <span class="text-xs text-text-secondary">이전</span>
          <span class="block text-sm text-white font-medium">Cloudflare Pages</span>
        </div>
      </a>

      <a
        href="/map"
        class="group flex items-center gap-3 px-4 py-2 rounded-lg bg-primary hover:bg-primary-hover text-background transition-colors no-underline"
      >
        <div class="text-right">
          <span class="text-xs opacity-70">다음</span>
          <span class="block text-sm font-bold">학습 사이클</span>
        </div>
        <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </a>
    </nav>
  </div>
</DocsLayout>
