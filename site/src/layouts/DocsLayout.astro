---
import BaseLayout from './BaseLayout.astro';
import NavGroup from '../components/NavGroup.tsx';
import FeedbackBox from '../components/FeedbackBox';
import LanguagePicker from '../components/LanguagePicker.astro';
import type { Lang } from '../i18n/ui';
import { useTranslations, getLocalePath } from '../i18n/utils';
import { getNavigation } from '../i18n/navigation';
import { existsSync, statSync } from 'node:fs';
import path from 'node:path';
import { fileURLToPath } from 'node:url';
import packageJson from '../../package.json';

type JsonLd = Record<string, unknown>;

interface Props {
  title: string;
  description?: string;
  currentPath?: string;
  lang?: Lang;
  structuredData?: JsonLd | JsonLd[];
}

const { title, description, currentPath, lang = 'ko', structuredData } = Astro.props;
const t = useTranslations(lang);
const navigation = getNavigation(lang);
const lp = (path: string) => getLocalePath(lang, path);
const docsVersion = `v${packageJson.version}`;
// `currentPath` is stored without locale (e.g. `/map/frontend`). Sidebar hrefs are localized (e.g. `/en/map/frontend`),
// so compare using a localized version to keep active highlighting correct.
const currentPathLocalized = currentPath ? lp(currentPath) : undefined;
const localizedDocPath = currentPath ? lp(currentPath) : Astro.url.pathname;
const absoluteDocUrl = `https://choorai.com${localizedDocPath}`;
const absoluteHomeUrl = `https://choorai.com${lp('/')}`;
const inLanguage = lang === 'en' ? 'en-US' : 'ko-KR';
const docsSourceRoot = path.join(fileURLToPath(new URL('..', import.meta.url)), 'pages');
const sourceRoutePath = currentPath ? `${lang === 'en' ? '/en' : ''}${currentPath}` : Astro.url.pathname;
const normalizedSourceRoutePath = sourceRoutePath.replace(/\/+$/, '') || '/';
const sourcePathSegments = normalizedSourceRoutePath === '/' ? [] : normalizedSourceRoutePath.slice(1).split('/');
const sourceCandidates = sourcePathSegments.length === 0
  ? [path.join(docsSourceRoot, 'index.astro')]
  : [
      `${path.join(docsSourceRoot, ...sourcePathSegments)}.astro`,
      path.join(docsSourceRoot, ...sourcePathSegments, 'index.astro'),
    ];
const sourceFilePath = sourceCandidates.find((candidate) => existsSync(candidate));
const lastUpdatedDate = sourceFilePath ? statSync(sourceFilePath).mtime : new Date();
const lastUpdatedIso = lastUpdatedDate.toISOString();
const lastUpdatedText = new Intl.DateTimeFormat(lang === 'en' ? 'en-US' : 'ko-KR', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
}).format(lastUpdatedDate);
const docsMetaText = lang === 'en'
  ? `Last updated: ${lastUpdatedText} · Version: ${docsVersion}`
  : `마지막 업데이트: ${lastUpdatedText} · 버전: ${docsVersion}`;
const docsStructuredData: JsonLd[] = [
  {
    '@context': 'https://schema.org',
    '@type': 'Article',
    headline: title,
    description,
    inLanguage,
    mainEntityOfPage: {
      '@type': 'WebPage',
      '@id': absoluteDocUrl,
    },
    author: {
      '@type': 'Person',
      name: 'CuroGom',
      url: 'https://curogom.dev',
    },
    publisher: {
      '@type': 'Organization',
      name: 'Choorai',
      url: 'https://choorai.com',
      logo: {
        '@type': 'ImageObject',
        url: 'https://choorai.com/logo-64.png',
      },
    },
    dateModified: lastUpdatedIso,
    version: docsVersion,
  },
  {
    '@context': 'https://schema.org',
    '@type': 'BreadcrumbList',
    itemListElement: [
      {
        '@type': 'ListItem',
        position: 1,
        name: t('layout.home'),
        item: absoluteHomeUrl,
      },
      {
        '@type': 'ListItem',
        position: 2,
        name: title,
        item: absoluteDocUrl,
      },
    ],
  },
];
const pageStructuredData = Array.isArray(structuredData)
  ? structuredData
  : structuredData
    ? [structuredData]
    : [];
const allStructuredData = [...docsStructuredData, ...pageStructuredData];
---

<BaseLayout title={title} description={description} lang={lang} structuredData={allStructuredData}>
  <div class="min-h-screen flex flex-col">
    <!-- 헤더 -->
    <header class="sticky top-0 z-50 border-b border-border bg-background/80 backdrop-blur-md">
      <div class="max-w-[1440px] mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-14">
          <div class="flex items-center gap-4">
            <!-- 모바일 메뉴 버튼 -->
            <button
              id="mobile-menu-trigger"
              class="lg:hidden p-2 -ml-2 text-text-secondary hover:text-white transition-colors"
              aria-label={t('layout.menuOpen')}
            >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
              </svg>
            </button>
            <a href={lp('/')} class="flex items-center gap-2" aria-label="Choorai">
              <img src="/favicon.png" alt="" class="w-7 h-7" aria-hidden="true" />
              <span class="text-lg font-bold">Choorai</span>
            </a>
            <span class="text-border hidden sm:inline">|</span>
            <span class="text-sm text-text-secondary hidden sm:inline">{t('layout.docs')}</span>
          </div>

          <div class="flex items-center gap-4">
            <!-- 검색 -->
            <button
              id="search-trigger"
              class="hidden md:flex items-center h-9 w-64 rounded-lg border border-border bg-surface px-3 hover:border-primary/50 transition-colors cursor-pointer"
              aria-label={t('layout.searchOpen')}
            >
              <svg class="w-4 h-4 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              <span class="flex-1 text-left text-sm text-text-secondary px-2">{t('layout.search')}</span>
              <kbd class="text-[10px] text-text-secondary bg-background px-1.5 py-0.5 rounded border border-border" aria-hidden="true">⌘K</kbd>
            </button>

            <LanguagePicker lang={lang} />

            <a href="https://github.com/curogom/choorai" class="text-text-secondary hover:text-white transition-colors" aria-label="GitHub">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z" />
              </svg>
            </a>
          </div>
        </div>
      </div>
    </header>

    <div class="flex-1 flex">
      <!-- 사이드바 -->
      <aside id="sidebar" class="hidden lg:block w-64 border-r border-border bg-background sticky top-14 h-[calc(100vh-3.5rem)] overflow-y-auto">
        <nav class="p-4 space-y-4" aria-label={t('layout.docNav')}>
          {navigation.map((section, index) => (
            <div class={index > 0 ? 'pt-4 border-t border-border/50' : ''}>
              <h3 class="text-base font-bold text-white mb-3 px-3 flex items-center gap-2">
                {section.title}
              </h3>

              {/* 접을 수 있는 그룹 */}
              {section.groups?.map((group) => (
                <NavGroup
                  client:load
                  title={group.title}
                  items={group.items}
                  currentPath={currentPathLocalized}
                  storageKey={group.storageKey}
                />
              ))}

              {/* 일반 아이템 */}
              {section.items && (
                <ul class="space-y-1">
                  {section.items?.map((item) => (
                    item.href ? (
                      <li>
                        <a
                          href={item.href}
                          class={`
                            flex items-center justify-between py-2 rounded-lg text-sm font-medium
                            transition-colors pr-3
                            ${item.indent === 2 ? 'pl-9 text-xs' : item.indent === 1 ? 'pl-6' : 'pl-3'}
                            ${currentPathLocalized === item.href || currentPathLocalized?.startsWith(item.href + '/')
                              ? 'bg-primary/10 text-primary border-l-2 border-primary -ml-[1px]'
                              : 'text-text-secondary hover:text-white hover:bg-surface'
                            }
                          `}
                        >
                          <span>{item.label}</span>
                          {item.badge && (
                            <span class="px-1.5 py-0.5 text-[10px] font-bold bg-primary/20 text-primary rounded">
                              {item.badge}
                            </span>
                          )}
                        </a>
                      </li>
                    ) : null
                  ))}
                </ul>
              )}
            </div>
          ))}
        </nav>
      </aside>

      <!-- 메인 콘텐츠 -->
      <main class="flex-1 min-w-0">
        <slot />
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="mt-10 mb-6 pt-6 border-t border-border/70">
            <p class="text-xs text-text-muted">{docsMetaText}</p>
          </div>
          <FeedbackBox client:load currentPath={currentPathLocalized} lang={lang} />
        </div>

        <!-- 문서 페이지 푸터 -->
        <footer class="border-t border-border bg-surface/30 py-8 mt-16">
          <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
              <div class="flex items-center gap-2">
                <img src="/favicon.png" alt="" class="w-5 h-5" aria-hidden="true" />
                <span class="text-white font-medium">Choorai</span>
                <span class="text-text-secondary text-sm">· {t('layout.docs')}</span>
              </div>
              <div class="flex items-center gap-4 text-sm">
                <a href={lp('/')} class="text-text-secondary hover:text-white transition-colors">{t('layout.home')}</a>
                <a href="https://github.com/curogom/choorai" target="_blank" rel="noopener noreferrer" class="text-text-secondary hover:text-white transition-colors flex items-center gap-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z" />
                  </svg>
                  GitHub
                </a>
                <a href={lp('/terms')} class="text-text-secondary hover:text-white transition-colors">{t('layout.terms')}</a>
              </div>
            </div>
            <p class="text-xs text-text-secondary text-center mt-4">
              © {new Date().getFullYear()} CuroGom · Made with Choorai
            </p>
          </div>
        </footer>
      </main>
    </div>
  </div>

  <!-- 모바일 사이드바 -->
  <div id="mobile-sidebar" class="fixed inset-0 z-[90] lg:hidden hidden" role="dialog" aria-modal="true" aria-label={t('layout.navMenu')}>
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="mobile-overlay" aria-hidden="true"></div>
    <div class="absolute top-0 left-0 w-72 h-full bg-background border-r border-border shadow-2xl transform transition-transform duration-300" id="mobile-drawer">
      <div class="flex items-center justify-between h-14 px-4 border-b border-border">
        <span class="text-lg font-bold">{t('layout.menu')}</span>
        <button id="mobile-menu-close" class="p-2 text-text-secondary hover:text-white transition-colors" aria-label={t('layout.menuClose')}>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <nav class="p-4 space-y-4 overflow-y-auto h-[calc(100%-3.5rem)]" aria-label={t('layout.docNav')}>
        {navigation.map((section) => (
          <div>
            <h3 class="text-xs font-bold text-text-secondary uppercase tracking-wider mb-2 px-3">
              {section.title}
            </h3>
            {section.groups?.map((group) => (
              <NavGroup
                client:load
                title={group.title}
                items={group.items}
                currentPath={currentPathLocalized}
                storageKey={group.storageKey}
              />
            ))}
            {section.items && (
              <ul class="space-y-1">
                {section.items.map((item) => (
                  <li>
                    {item.href ? (
                      <a
                        href={item.href}
                        class={`
                          flex items-center justify-between py-2 rounded-lg text-sm font-medium pr-3 transition-colors
                          ${item.indent === 2 ? 'pl-9 text-xs' : item.indent === 1 ? 'pl-6' : 'pl-3'}
                          ${currentPathLocalized === item.href || currentPathLocalized?.startsWith(item.href + '/')
                            ? 'bg-primary/10 text-primary border-l-2 border-primary -ml-[1px]'
                            : 'text-text-secondary hover:text-white hover:bg-surface'
                          }
                        `}
                      >
                        <span>{item.label}</span>
                        <span class="flex items-center gap-1">
                          {item.tags?.map((tag) => (
                            <span class="text-xs leading-none">{tag}</span>
                          ))}
                          {item.badge && (
                            <span class="px-1.5 py-0.5 text-[10px] font-bold bg-primary/20 text-primary rounded">
                              {item.badge}
                            </span>
                          )}
                        </span>
                      </a>
                    ) : (
                      <span class="flex items-center justify-between py-2 rounded-lg text-sm pl-3 pr-3 text-text-secondary/60">
                        <span>{item.label}</span>
                        <span class="flex items-center gap-1">
                          {item.tags?.map((tag) => (
                            <span class="text-xs leading-none opacity-80">{tag}</span>
                          ))}
                          {item.badge && (
                            <span class="px-1.5 py-0.5 text-[10px] font-bold bg-surface text-text-secondary/60 rounded">
                              {item.badge}
                            </span>
                          )}
                        </span>
                      </span>
                    )}
                  </li>
                ))}
              </ul>
            )}
          </div>
        ))}
      </nav>
    </div>
  </div>

  <!-- 검색 모달 -->
  <div id="search-modal" class="fixed inset-0 z-[100] hidden" role="dialog" aria-modal="true" aria-label={t('layout.search')}>
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="search-overlay" aria-hidden="true"></div>
    <div class="relative max-w-2xl mx-auto mt-20 bg-background border border-border rounded-xl shadow-2xl overflow-hidden">
      <div class="p-4">
        <div id="pagefind-container"></div>
      </div>
    </div>
  </div>

  <script define:vars={{ searchPlaceholder: t('layout.searchPlaceholder'), searchNoResults: t('layout.searchNoResults'), searchResults: t('layout.searchResults'), searchOneResult: t('layout.searchOneResult') }}>
    // Pagefind 초기화 (lazy loading)
    let pagefindLoaded = false;

    async function initSearch() {
      if (pagefindLoaded) return;
      pagefindLoaded = true;

      try {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = '/pagefind/pagefind-ui.css';
        document.head.appendChild(link);

        const style = document.createElement('style');
        style.textContent = `
          .pagefind-ui { --pagefind-ui-scale: 1; --pagefind-ui-primary: #57ABFF; --pagefind-ui-text: #fff; --pagefind-ui-background: #161B22; --pagefind-ui-border: #30363D; --pagefind-ui-tag: #21262D; --pagefind-ui-border-width: 1px; --pagefind-ui-border-radius: 8px; }
          .pagefind-ui__search-input { background: #0D1117 !important; }
          .pagefind-ui__result-link { color: #57ABFF !important; }
          .pagefind-ui__result-excerpt { color: #8B949E !important; }
        `;
        document.head.appendChild(style);

        const script = document.createElement('script');
        script.src = '/pagefind/pagefind-ui.js';
        script.onerror = () => {
          const container = document.getElementById('pagefind-container');
          if (container) {
            container.innerHTML = '<p class="text-text-secondary text-sm">Search is available after build.</p>';
          }
        };
        script.onload = () => {
          // @ts-ignore
          new PagefindUI({
            element: '#pagefind-container',
            showSubResults: true,
            showImages: false,
            translations: { placeholder: searchPlaceholder, zero_results: searchNoResults, many_results: searchResults, one_result: searchOneResult }
          });
        };
        document.head.appendChild(script);
      } catch (e) {
        console.warn('Pagefind not available in dev mode');
      }
    }

    // 모달 열기/닫기
    const modal = document.getElementById('search-modal');
    const trigger = document.getElementById('search-trigger');
    const overlay = document.getElementById('search-overlay');

    function openSearch() {
      modal?.classList.remove('hidden');
      initSearch();
      setTimeout(() => (document.querySelector('.pagefind-ui__search-input'))?.focus(), 100);
    }
    function closeSearch() { modal?.classList.add('hidden'); }

    trigger?.addEventListener('click', openSearch);
    overlay?.addEventListener('click', closeSearch);
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); openSearch(); }
      if (e.key === 'Escape') { closeSearch(); closeMobileMenu(); }
    });

    // 모바일 메뉴 열기/닫기
    const mobileSidebar = document.getElementById('mobile-sidebar');
    const mobileOverlay = document.getElementById('mobile-overlay');
    const mobileTrigger = document.getElementById('mobile-menu-trigger');
    const mobileClose = document.getElementById('mobile-menu-close');

    function openMobileMenu() {
      mobileSidebar?.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
    function closeMobileMenu() {
      mobileSidebar?.classList.add('hidden');
      document.body.style.overflow = '';
    }

    mobileTrigger?.addEventListener('click', openMobileMenu);
    mobileClose?.addEventListener('click', closeMobileMenu);
    mobileOverlay?.addEventListener('click', closeMobileMenu);

    // 사이드바에서 현재 활성 항목으로 스크롤
    const sidebar = document.getElementById('sidebar');
    const activeItem = sidebar?.querySelector('.border-primary');
    if (sidebar && activeItem) {
      const sidebarRect = sidebar.getBoundingClientRect();
      const itemRect = activeItem.getBoundingClientRect();
      const scrollTop = activeItem.offsetTop - sidebar.offsetTop - (sidebarRect.height / 2) + (itemRect.height / 2);
      sidebar.scrollTop = Math.max(0, scrollTop);
    }
  </script>
</BaseLayout>
