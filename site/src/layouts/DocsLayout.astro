---
import BaseLayout from './BaseLayout.astro';
import NavGroup from '../components/NavGroup.tsx';

interface Props {
  title: string;
  description?: string;
  currentPath?: string;
}

interface NavItem {
  label: string;
  href?: string;
  badge?: string;
  indent?: number;
}

interface NavGroupType {
  title: string;
  storageKey: string;
  items: NavItem[];
}

interface NavSection {
  title: string;
  href?: string;
  groups?: NavGroupType[];
  items?: NavItem[];
}

const { title, description, currentPath } = Astro.props;

// ìƒˆë¡œìš´ IA: Path / Map / Fix / Recipes / Reference
const navigation: NavSection[] = [
  {
    title: 'ğŸ¯ Path',
    href: '/path',
    groups: [
      {
        title: 'ì½”ìŠ¤ ëª©ë¡',
        storageKey: 'path-courses',
        items: [
          { label: '60ë¶„ ì™„ì£¼', href: '/path/60min', badge: 'ì…ë¬¸', indent: 1 },
          { label: 'React', href: '/start/60min/frontend/react', indent: 2 },
          { label: 'Vue', href: '/start/60min/frontend/vue', indent: 2 },
          { label: 'FastAPI', href: '/start/60min/backend/fastapi', indent: 2 },
          { label: 'Hono', href: '/start/60min/backend/hono', indent: 2 },
          { label: 'ì—°ê²°í•˜ê¸°', href: '/start/60min/connect', indent: 2 },
          { label: 'ë°°í¬í•˜ê¸°', href: '/start/60min/deploy', indent: 2 },
          { label: 'ì™„ë£Œ!', href: '/start/60min/complete', indent: 2 },
          { label: 'ë¯¸ë‹ˆ SaaS', badge: 'ì¤€ë¹„ì¤‘', indent: 1 },
          { label: 'B2B Admin', badge: 'ì¤€ë¹„ì¤‘', indent: 1 },
        ],
      },
    ],
    items: [
      { label: 'ë„êµ¬ ì¤€ë¹„', href: '/map/tools' },
    ],
  },
  {
    title: 'ğŸ—ºï¸ Map',
    href: '/map',
    groups: [
      {
        title: 'ê¸°ë³¸ ì‚¬ì´í´',
        storageKey: 'map-basic',
        items: [
          { label: 'ì „ì²´ ë¡œë“œë§µ', href: '/map' },
          { label: 'ë„ë©”ì¸ & DNS', href: '/map/dns' },
          { label: 'í”„ë¡ íŠ¸ì—”ë“œ', href: '/map/frontend', indent: 1 },
          { label: 'Vue', href: '/map/frontend/vue', indent: 2 },
          { label: 'ë°±ì—”ë“œ', href: '/map/backend', indent: 1 },
          { label: 'Hono', href: '/map/backend/hono', indent: 2 },
          { label: 'Go', href: '/map/backend/go', indent: 2 },
          { label: 'NestJS', href: '/map/backend/nest', indent: 2 },
          { label: 'ë°ì´í„°ë² ì´ìŠ¤', href: '/map/database', indent: 1 },
          { label: 'RDB', badge: 'ì¤€ë¹„ì¤‘', indent: 2 },
          { label: 'NoSQL', badge: 'ì¤€ë¹„ì¤‘', indent: 2 },
          { label: 'In-Memory/Cache', badge: 'ì¤€ë¹„ì¤‘', indent: 2 },
          { label: 'Vector DB', badge: 'ì¤€ë¹„ì¤‘', indent: 2 },
          { label: 'í™˜ê²½ë³€ìˆ˜', href: '/map/runtime', indent: 1 },
          { label: 'ëª¨ë‹ˆí„°ë§', href: '/map/ops', indent: 1 },
        ],
      },
      {
        title: 'ì‹¬í™”',
        storageKey: 'map-advanced',
        items: [
          { label: 'Docker', href: '/map/docker', indent: 1 },
          { label: 'CI/CD', href: '/map/cicd', indent: 1 },
        ],
      },
    ],
  },
  {
    title: 'â˜ï¸ BaaS',
    items: [
      { label: 'Supabase', href: '/baas/supabase' },
      { label: 'Firebase', badge: 'ì¤€ë¹„ì¤‘' },
    ],
  },
  {
    title: 'ğŸ” ì¸ì¦',
    items: [
      { label: 'ê°œìš”', href: '/map/auth' },
      { label: 'Clerk', href: '/map/auth/clerk', badge: 'ì¶”ì²œ', indent: 1 },
      { label: 'NextAuth', href: '/map/auth/nextauth', indent: 1 },
      { label: 'Auth0', href: '/map/auth/auth0', indent: 1 },
      { label: 'Firebase', href: '/map/auth/firebase', indent: 1 },
    ],
  },
  {
    title: 'ğŸ§ª í…ŒìŠ¤íŒ…',
    items: [
      { label: 'ê°œìš”', href: '/map/testing' },
      { label: 'ë‹¨ìœ„ í…ŒìŠ¤íŠ¸', href: '/map/testing/unit', indent: 1 },
      { label: 'E2E í…ŒìŠ¤íŠ¸', href: '/map/testing/e2e', indent: 1 },
    ],
  },
  {
    title: 'ğŸ› ï¸ Fix',
    href: '/fix',
    items: [
      { label: 'íŠ¸ëŸ¬ë¸”ìŠˆíŒ…', href: '/fix' },
      { label: 'CORS ì—ëŸ¬', href: '/fix/cors', indent: 1 },
      { label: 'í™˜ê²½ ë³€ìˆ˜', href: '/fix/env', indent: 1 },
      { label: 'SPA 404', href: '/fix/spa-404', indent: 1 },
      { label: 'ë¹Œë“œ ì‹¤íŒ¨', href: '/fix/build-fail', indent: 1 },
      { label: 'ì¸ì¦/ì¿ í‚¤', href: '/fix/auth-cookie', indent: 1 },
    ],
  },
  {
    title: 'ğŸ¤– Recipes',
    href: '/recipes',
    items: [
      { label: 'Agent Recipes', href: '/recipes' },
    ],
  },
  {
    title: 'ğŸ“¦ Reference',
    href: '/reference',
    items: [
      { label: 'ì˜ˆì œ í”„ë¡œì íŠ¸', href: '/reference' },
    ],
  },
  {
    title: 'ğŸš€ ë°°í¬ í”Œë«í¼',
    items: [
      { label: 'Cloudflare Pages', href: '/deploy/cloudflare-pages' },
      { label: 'Vercel', href: '/deploy/vercel' },
      { label: 'Cloud Run', href: '/deploy/cloud-run' },
    ],
  },
];
---

<BaseLayout title={title} description={description}>
  <div class="min-h-screen flex flex-col">
    <!-- í—¤ë” -->
    <header class="sticky top-0 z-50 border-b border-border bg-background/80 backdrop-blur-md">
      <div class="max-w-[1440px] mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-14">
          <div class="flex items-center gap-4">
            <!-- ëª¨ë°”ì¼ ë©”ë‰´ ë²„íŠ¼ -->
            <button
              id="mobile-menu-trigger"
              class="lg:hidden p-2 -ml-2 text-text-secondary hover:text-white transition-colors"
              aria-label="ë©”ë‰´ ì—´ê¸°"
            >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
              </svg>
            </button>
            <a href="/" class="flex items-center gap-2" aria-label="Choorai í™ˆ">
              <img src="/favicon.png" alt="" class="w-7 h-7" aria-hidden="true" />
              <span class="text-lg font-bold">Choorai</span>
            </a>
            <span class="text-border hidden sm:inline">|</span>
            <span class="text-sm text-text-secondary hidden sm:inline">ë¬¸ì„œ</span>
          </div>

          <div class="flex items-center gap-4">
            <!-- ê²€ìƒ‰ -->
            <button
              id="search-trigger"
              class="hidden md:flex items-center h-9 w-64 rounded-lg border border-border bg-surface px-3 hover:border-primary/50 transition-colors cursor-pointer"
              aria-label="ë¬¸ì„œ ê²€ìƒ‰ ì—´ê¸°"
            >
              <svg class="w-4 h-4 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              <span class="flex-1 text-left text-sm text-text-secondary px-2">ë¬¸ì„œ ê²€ìƒ‰...</span>
              <kbd class="text-[10px] text-text-secondary bg-background px-1.5 py-0.5 rounded border border-border" aria-hidden="true">âŒ˜K</kbd>
            </button>

            <a href="https://github.com/curogom/choorai" class="text-text-secondary hover:text-white transition-colors" aria-label="GitHub ì €ì¥ì†Œ">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z" />
              </svg>
            </a>
          </div>
        </div>
      </div>
    </header>

    <div class="flex-1 flex">
      <!-- ì‚¬ì´ë“œë°” -->
      <aside id="sidebar" class="hidden lg:block w-64 border-r border-border bg-background sticky top-14 h-[calc(100vh-3.5rem)] overflow-y-auto">
        <nav class="p-4 space-y-4" aria-label="ë¬¸ì„œ ë„¤ë¹„ê²Œì´ì…˜">
          {navigation.map((section, index) => (
            <div class={index > 0 ? 'pt-4 border-t border-border/50' : ''}>
              <h3 class="text-base font-bold text-white mb-3 px-3 flex items-center gap-2">
                {section.title}
              </h3>

              {/* ì ‘ì„ ìˆ˜ ìˆëŠ” ê·¸ë£¹ */}
              {section.groups?.map((group) => (
                <NavGroup
                  client:load
                  title={group.title}
                  items={group.items}
                  currentPath={currentPath}
                  storageKey={group.storageKey}
                />
              ))}

              {/* ì¼ë°˜ ì•„ì´í…œ */}
              {section.items && (
                <ul class="space-y-1">
                  {section.items?.map((item) => (
                    item.href ? (
                      <li>
                        <a
                          href={item.href}
                          class={`
                            flex items-center justify-between py-2 rounded-lg text-sm font-medium
                            transition-colors pr-3
                            ${item.indent === 2 ? 'pl-9 text-xs' : item.indent === 1 ? 'pl-6' : 'pl-3'}
                            ${currentPath === item.href || currentPath?.startsWith(item.href + '/')
                              ? 'bg-primary/10 text-primary border-l-2 border-primary -ml-[1px]'
                              : 'text-text-secondary hover:text-white hover:bg-surface'
                            }
                          `}
                        >
                          <span>{item.label}</span>
                          {item.badge && (
                            <span class="px-1.5 py-0.5 text-[10px] font-bold bg-primary/20 text-primary rounded">
                              {item.badge}
                            </span>
                          )}
                        </a>
                      </li>
                    ) : null
                  ))}
                </ul>
              )}
            </div>
          ))}
        </nav>
      </aside>

      <!-- ë©”ì¸ ì½˜í…ì¸  -->
      <main class="flex-1 min-w-0">
        <slot />

        <!-- ë¬¸ì„œ í˜ì´ì§€ í‘¸í„° -->
        <footer class="border-t border-border bg-surface/30 py-8 mt-16">
          <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
              <div class="flex items-center gap-2">
                <img src="/favicon.png" alt="" class="w-5 h-5" aria-hidden="true" />
                <span class="text-white font-medium">Choorai</span>
                <span class="text-text-secondary text-sm">Â· ë¬¸ì„œ</span>
              </div>
              <div class="flex items-center gap-4 text-sm">
                <a href="/" class="text-text-secondary hover:text-white transition-colors">í™ˆ</a>
                <a href="https://github.com/curogom/choorai" target="_blank" rel="noopener noreferrer" class="text-text-secondary hover:text-white transition-colors flex items-center gap-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z" />
                  </svg>
                  GitHub
                </a>
                <a href="/terms" class="text-text-secondary hover:text-white transition-colors">ì´ìš©ì•½ê´€</a>
              </div>
            </div>
            <p class="text-xs text-text-secondary text-center mt-4">
              Â© {new Date().getFullYear()} CuroGom Â· Made with Choorai
            </p>
          </div>
        </footer>
      </main>
    </div>
  </div>

  <!-- ëª¨ë°”ì¼ ì‚¬ì´ë“œë°” -->
  <div id="mobile-sidebar" class="fixed inset-0 z-[90] lg:hidden hidden" role="dialog" aria-modal="true" aria-label="ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="mobile-overlay" aria-hidden="true"></div>
    <div class="absolute top-0 left-0 w-72 h-full bg-background border-r border-border shadow-2xl transform transition-transform duration-300" id="mobile-drawer">
      <div class="flex items-center justify-between h-14 px-4 border-b border-border">
        <span class="text-lg font-bold">ë©”ë‰´</span>
        <button id="mobile-menu-close" class="p-2 text-text-secondary hover:text-white transition-colors" aria-label="ë©”ë‰´ ë‹«ê¸°">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <nav class="p-4 space-y-4 overflow-y-auto h-[calc(100%-3.5rem)]" aria-label="ë¬¸ì„œ ë„¤ë¹„ê²Œì´ì…˜">
        {navigation.map((section) => (
          <div>
            <h3 class="text-xs font-bold text-text-secondary uppercase tracking-wider mb-2 px-3">
              {section.title}
            </h3>
            <ul class="space-y-1">
              {section.items?.map((item) => (
                <li>
                  <a
                    href={item.href}
                    class={`
                      flex items-center justify-between px-3 py-2 rounded-lg text-sm font-medium
                      transition-colors
                      ${currentPath === item.href || currentPath?.startsWith(item.href + '/')
                        ? 'bg-primary/10 text-primary border-l-2 border-primary -ml-[1px]'
                        : 'text-text-secondary hover:text-white hover:bg-surface'
                      }
                    `}
                  >
                    <span>{item.label}</span>
                    {item.badge && (
                      <span class="px-1.5 py-0.5 text-[10px] font-bold bg-primary/20 text-primary rounded">
                        {item.badge}
                      </span>
                    )}
                  </a>
                </li>
              ))}
            </ul>
          </div>
        ))}
      </nav>
    </div>
  </div>

  <!-- ê²€ìƒ‰ ëª¨ë‹¬ -->
  <div id="search-modal" class="fixed inset-0 z-[100] hidden" role="dialog" aria-modal="true" aria-label="ë¬¸ì„œ ê²€ìƒ‰">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" id="search-overlay" aria-hidden="true"></div>
    <div class="relative max-w-2xl mx-auto mt-20 bg-background border border-border rounded-xl shadow-2xl overflow-hidden">
      <div class="p-4">
        <div id="pagefind-container"></div>
      </div>
    </div>
  </div>

  <script>
    // Pagefind ì´ˆê¸°í™” (lazy loading - ê²€ìƒ‰ ëª¨ë‹¬ ì—´ ë•Œë§Œ ë¡œë“œ)
    let pagefindLoaded = false;

    async function initSearch() {
      if (pagefindLoaded) return;
      pagefindLoaded = true;

      try {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = '/pagefind/pagefind-ui.css';
        document.head.appendChild(link);

        const style = document.createElement('style');
        style.textContent = `
          .pagefind-ui { --pagefind-ui-scale: 1; --pagefind-ui-primary: #57ABFF; --pagefind-ui-text: #fff; --pagefind-ui-background: #161B22; --pagefind-ui-border: #30363D; --pagefind-ui-tag: #21262D; --pagefind-ui-border-width: 1px; --pagefind-ui-border-radius: 8px; }
          .pagefind-ui__search-input { background: #0D1117 !important; }
          .pagefind-ui__result-link { color: #57ABFF !important; }
          .pagefind-ui__result-excerpt { color: #8B949E !important; }
        `;
        document.head.appendChild(style);

        const script = document.createElement('script');
        script.src = '/pagefind/pagefind-ui.js';
        script.onerror = () => {
          const container = document.getElementById('pagefind-container');
          if (container) {
            container.innerHTML = '<p class="text-text-secondary text-sm">ê²€ìƒ‰ ê¸°ëŠ¥ì€ ë¹Œë“œ í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>';
          }
        };
        script.onload = () => {
          // @ts-ignore
          new PagefindUI({
            element: '#pagefind-container',
            showSubResults: true,
            showImages: false,
            translations: { placeholder: 'ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...', zero_results: 'ê²°ê³¼ ì—†ìŒ', many_results: '[COUNT]ê°œ ê²°ê³¼', one_result: '1ê°œ ê²°ê³¼' }
          });
        };
        document.head.appendChild(script);
      } catch (e) {
        console.warn('Pagefind not available in dev mode');
      }
    }

    // ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
    const modal = document.getElementById('search-modal');
    const trigger = document.getElementById('search-trigger');
    const overlay = document.getElementById('search-overlay');

    function openSearch() {
      modal?.classList.remove('hidden');
      initSearch(); // ëª¨ë‹¬ ì—´ ë•Œ pagefind ë¡œë“œ
      setTimeout(() => (document.querySelector('.pagefind-ui__search-input') as HTMLElement)?.focus(), 100);
    }
    function closeSearch() { modal?.classList.add('hidden'); }

    trigger?.addEventListener('click', openSearch);
    overlay?.addEventListener('click', closeSearch);
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); openSearch(); }
      if (e.key === 'Escape') { closeSearch(); closeMobileMenu(); }
    });

    // ëª¨ë°”ì¼ ë©”ë‰´ ì—´ê¸°/ë‹«ê¸°
    const mobileSidebar = document.getElementById('mobile-sidebar');
    const mobileOverlay = document.getElementById('mobile-overlay');
    const mobileTrigger = document.getElementById('mobile-menu-trigger');
    const mobileClose = document.getElementById('mobile-menu-close');

    function openMobileMenu() {
      mobileSidebar?.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
    function closeMobileMenu() {
      mobileSidebar?.classList.add('hidden');
      document.body.style.overflow = '';
    }

    mobileTrigger?.addEventListener('click', openMobileMenu);
    mobileClose?.addEventListener('click', closeMobileMenu);
    mobileOverlay?.addEventListener('click', closeMobileMenu);

    // ì‚¬ì´ë“œë°”ì—ì„œ í˜„ì¬ í™œì„± í•­ëª©ìœ¼ë¡œ ìŠ¤í¬ë¡¤
    const sidebar = document.getElementById('sidebar');
    const activeItem = sidebar?.querySelector('.border-primary') as HTMLElement | null;
    if (sidebar && activeItem) {
      const sidebarRect = sidebar.getBoundingClientRect();
      const itemRect = activeItem.getBoundingClientRect();
      const scrollTop = activeItem.offsetTop - sidebar.offsetTop - (sidebarRect.height / 2) + (itemRect.height / 2);
      sidebar.scrollTop = Math.max(0, scrollTop);
    }
  </script>
</BaseLayout>
