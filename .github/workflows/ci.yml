name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # 테스트 실행
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            site/package-lock.json
            examples/b2b-admin/web/package-lock.json
            examples/b2b-admin/web-vue/package-lock.json
            examples/b2b-admin/api-hono/package-lock.json
            examples/b2b-admin/api-nest/package-lock.json
            examples/b2c-todo/web/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # B2B Admin 테스트
      - name: Install B2B Admin API dependencies
        run: |
          cd examples/b2b-admin/api
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run B2B Admin API tests
        run: cd examples/b2b-admin/api && pytest -v

      # B2B Admin API (Hono) 테스트
      - name: Install B2B Admin API (Hono) dependencies
        run: cd examples/b2b-admin/api-hono && npm ci

      - name: Run B2B Admin API (Hono) tests
        run: cd examples/b2b-admin/api-hono && npm run test:run

      # B2B Admin API (NestJS) 테스트
      - name: Install B2B Admin API (NestJS) dependencies
        run: cd examples/b2b-admin/api-nest && npm ci

      - name: Run B2B Admin API (NestJS) tests
        run: cd examples/b2b-admin/api-nest && npm run test:e2e

      - name: Install B2B Admin Web dependencies
        run: cd examples/b2b-admin/web && npm ci

      - name: Run B2B Admin Web tests
        run: cd examples/b2b-admin/web && npm run test:run

      # B2B Admin Web (Vue) 테스트
      - name: Install B2B Admin Web (Vue) dependencies
        run: cd examples/b2b-admin/web-vue && npm ci

      - name: Run B2B Admin Web (Vue) tests
        run: cd examples/b2b-admin/web-vue && npm run test:run

      # B2C Todo 테스트
      - name: Install B2C Todo API dependencies
        run: |
          cd examples/b2c-todo/api
          pip install -r requirements.txt

      - name: Run B2C Todo API tests
        run: cd examples/b2c-todo/api && pytest -v

      - name: Install B2C Todo Web dependencies
        run: cd examples/b2c-todo/web && npm ci

      - name: Run B2C Todo Web tests
        run: cd examples/b2c-todo/web && npm run test:run

  # 사이트 빌드 검증
  build:
    name: Build Site
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: site/package-lock.json

      - name: Install dependencies
        run: cd site && npm ci

      - name: Build site
        run: cd site && npm run build
